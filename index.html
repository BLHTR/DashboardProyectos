<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlatoRH - Project Analysis Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Bebas Neue & Exo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Exo:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.372.0/dist/umd/lucide.min.js"></script>

    <!-- HTML to Canvas for JPG Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbGfnTY51aFHIeVR/A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* Aplicando la paleta de colores y tipograf√≠as de BlatoRH */
        :root {
            --bl-azul-oscuro: #0D2240;
            --bl-dorado: #B1A96E;
            --bl-azul-principal: #1A77D2;
            --bl-blanco: #FFFFFF;
            --bl-gris-claro: #f3f4f6;
            --bl-gris-oscuro: #1f2937;
        }

        body {
            font-family: 'Exo', sans-serif;
            background-color: var(--bl-azul-oscuro);
            color: var(--bl-blanco);
        }

        h1, h2, h3, h4, .font-display {
            font-family: 'Bebas Neue', sans-serif;
        }

        .brand-logo {
            color: var(--bl-blanco);
        }
        .brand-logo span {
            color: var(--bl-dorado);
        }
        .brand-subtitle {
            font-family: 'Exo', sans-serif;
            font-size: 0.8rem;
            letter-spacing: 2px;
            color: var(--bl-gris-claro);
            opacity: 0.8;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 28px;
            bottom: 0;
            width: 2px;
            background-color: var(--bl-dorado);
            opacity: 0.5;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 28px;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background-color: var(--bl-azul-oscuro);
            border: 3px solid var(--bl-dorado);
            z-index: 10;
        }
        .timeline-dot.completed {
            background-color: var(--bl-dorado);
            border-color: var(--bl-dorado);
        }


        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bl-azul-oscuro);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bl-dorado);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #c9bf86;
        }

        .export-btn, .action-btn {
            background-color: rgba(177, 169, 110, 0.1);
            border: 1px solid var(--bl-dorado);
            color: var(--bl-dorado);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 10px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .export-btn:hover, .action-btn:hover {
            background-color: var(--bl-dorado);
            color: var(--bl-azul-oscuro);
        }
        .gantt-view-btn {
             transition: all 0.2s;
        }
        .gantt-view-btn.active {
            background-color: var(--bl-dorado);
            color: var(--bl-azul-oscuro);
            font-weight: bold;
        }

        /* Style for date picker icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.7;
            cursor: pointer;
        }
        
        /* Custom Gantt Styles */
        .gantt-row {
            height: 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }
        .gantt-task-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gantt-task-name.summary-task {
            font-weight: 500;
        }
        .toggle-btn {
            cursor: pointer;
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }
        .toggle-btn.collapsed {
            transform: rotate(-90deg);
        }
        
        .gantt-bar {
            position: absolute;
            height: 20px;
            top: 6px; /* (ROW_HEIGHT - BAR_HEIGHT) / 2 */
            background-color: #374151; /* Gray-700 for the track */
            border-radius: 4px;
            cursor: pointer;
            transition: filter 0.2s;
        }
        .gantt-bar:hover {
            filter: brightness(1.2);
        }
        .gantt-milestone {
            position: absolute;
            top: 8px; /* (ROW_HEIGHT - MILESTONE_SIZE) / 2 */
            width: 16px;
            height: 16px;
            background-color: var(--bl-dorado);
            transform: rotate(45deg);
            cursor: pointer;
        }
        .gantt-bar-progress {
            border-radius: 4px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow: hidden;
        }
        .gantt-bar-label {
            color: white;
            font-size: 10px;
            padding: 0 5px;
            white-space: nowrap;
        }
        #gantt-tooltip {
            position: fixed;
            display: none;
            background-color: var(--bl-gris-oscuro);
            color: var(--bl-blanco);
            border: 1px solid var(--bl-dorado);
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none; /* VERY IMPORTANT */
            max-width: 300px;
        }
        .gantt-timeline-header {
            background-color: var(--bl-azul-oscuro);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-6 border-b border-white/10 sticky top-0 bg-[--bl-azul-oscuro]/80 backdrop-blur-md z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="font-display text-4xl tracking-wider brand-logo">BlatoRH<span class="text-4xl">.</span></h1>
                <p class="brand-subtitle">BUSINESS CONSULTING</p>
            </div>
            <div class="text-right">
                <h2 class="font-display text-2xl md:text-3xl tracking-wide text-white/90">
                    Project Analysis Dashboard
                </h2>
                <p id="report-date" class="text-xs text-white/60 h-4"></p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 md:p-6">
        
        <!-- Upload Section -->
        <section id="uploadSection" class="text-center transition-opacity duration-500">
            <div class="max-w-4xl mx-auto border-2 border-dashed border-white/20 rounded-xl p-8 md:p-12 mt-10">
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <!-- Current File Upload -->
                    <div id="current-file-dropzone" class="border-2 border-dashed border-white/20 rounded-xl p-8 hover:border-white/50 hover:bg-white/5 transition-all cursor-pointer">
                        <input type="file" id="currentFile" class="hidden" accept=".xml">
                        <label for="currentFile" class="cursor-pointer">
                            <div class="flex flex-col items-center">
                                <i data-lucide="file-check-2" class="w-12 h-12 text-white/70 mb-4"></i>
                                <h3 class="font-display text-2xl text-white">Archivo Actual (Obligatorio)</h3>
                                <p class="text-white/60 mt-2 text-sm">Arrastra o selecciona el XML m√°s reciente.</p>
                                <span id="currentFileName" class="text-xs text-[--bl-dorado] mt-2 h-4"></span>
                            </div>
                        </label>
                    </div>
                    <!-- Previous File Upload -->
                    <div id="previous-file-dropzone" class="border-2 border-dashed border-white/20 rounded-xl p-8 hover:border-white/50 hover:bg-white/5 transition-all cursor-pointer">
                        <input type="file" id="previousFile" class="hidden" accept=".xml">
                        <label for="previousFile" class="cursor-pointer">
                            <div class="flex flex-col items-center">
                                <i data-lucide="file-clock" class="w-12 h-12 text-white/70 mb-4"></i>
                                <h3 class="font-display text-2xl text-white">Archivo Anterior (Opcional)</h3>
                                <p class="text-white/60 mt-2 text-sm">Arrastra o selecciona el XML de la semana pasada para comparar.</p>
                                 <span id="previousFileName" class="text-xs text-[--bl-dorado] mt-2 h-4"></span>
                            </div>
                        </label>
                    </div>
                </div>
                <button id="generate-report-btn" class="mt-8 bg-[--bl-dorado] text-[--bl-azul-oscuro] font-bold font-display text-xl px-12 py-3 rounded-lg hover:bg-yellow-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Generar Dashboard</button>
            </div>
        </section>

        <!-- Dashboard Section (Initially Hidden) -->
        <section id="dashboardSection" class="hidden opacity-0 transition-opacity duration-1000">
            <!-- Project Header -->
            <div class="mb-6 p-4 rounded-lg">
                <h2 class="font-display text-4xl" id="projectName"></h2>
                <p class="text-white/70" id="projectManager"></p>
            </div>

            <!-- Dashboard Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                <!-- Trend Analysis Panel -->
                <div id="trend-analysis-container-for-export" class="hidden card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">An√°lisis de Tendencias (Semana Actual vs. Anterior)</h3>
                        <button class="action-btn" id="exportTrendJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- KPIs Delta -->
                        <div id="kpi-delta-section">
                             <h4 class="font-display text-xl text-[--bl-dorado] mb-1 cursor-pointer" data-tooltip-text="Salud general del proyecto y su evoluci√≥n semanal.">KPIs Principales</h4>
                             <p class="text-xs text-white/60 -mt-1 mb-2 italic">Un resumen del cambio en la salud del proyecto.</p>
                            <ul class="space-y-2 text-sm" id="kpiDeltaList"></ul>
                        </div>
                        <!-- Slippage Report -->
                        <div id="slippage-section">
                            <h4 class="font-display text-xl text-[--bl-dorado] mb-1 cursor-pointer" data-tooltip-text="Diagn√≥stico de las tareas clave que causaron retrasos en la √∫ltima semana.">An√°lisis de Desv√≠os</h4>
                            <p class="text-xs text-white/60 -mt-1 mb-2 italic">Tareas clave que se han retrasado recientemente.</p>
                            <ul class="space-y-2 text-sm" id="slippageList"></ul>
                        </div>
                        <!-- Scope Changes -->
                        <div id="scope-change-section">
                           <h4 class="font-display text-xl text-[--bl-dorado] mb-1 cursor-pointer" data-tooltip-text="Control sobre el trabajo a√±adido o eliminado del plan.">Cambios en Alcance</h4>
                           <p class="text-xs text-white/60 -mt-1 mb-2 italic">Detecci√≥n de "scope creep" o cambios en el plan.</p>
                            <ul class="space-y-2 text-sm" id="scopeChangeList"></ul>
                        </div>
                    </div>
                </div>
                
                <!-- KPIs Summary -->
                <div class="col-span-1 md:col-span-2 lg:col-span-4 grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">Fecha de Inicio</h4>
                        <p class="font-display text-3xl text-white" id="startDate"></p>
                    </div>
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">Fin L√≠nea Base</h4>
                        <p class="font-display text-3xl text-white" id="baselineEndDate"></p>
                    </div>
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">Fin Proyectada</h4>
                        <p class="font-display text-3xl text-white" id="projectedEndDate"></p>
                    </div>
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">D√≠as Restantes</h4>
                        <p class="font-display text-3xl text-white" id="daysRemaining"></p>
                    </div>
                </div>

                <!-- Gauges -->
                <div class="card p-4 rounded-lg"><div id="progressChart"></div></div>
                <div class="card p-4 rounded-lg"><div id="timeChart"></div></div>
                
                <!-- RAG Status -->
                <div class="card p-4 rounded-lg md:col-span-2 lg:col-span-2">
                    <h3 class="font-display text-2xl mb-4 text-white text-center cursor-pointer" id="rag-title" data-tooltip-text="RAG (Red, Amber, Green) es un sistema de sem√°foro para mostrar la salud del proyecto. <br><b>Verde:</b> En buen camino. <br><b>√Åmbar:</b> Precauci√≥n. <br><b>Rojo:</b> Riesgo alto.">Estado General (RAG)</h3>
                    <div class="flex justify-around items-center h-full" id="ragStatusContainer">
                        <!-- RAG items will be injected here -->
                    </div>
                </div>

                <!-- Task Stats -->
                <div class="col-span-1 md:col-span-2 lg:col-span-4 grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="card p-4 rounded-lg text-center" id="completedTasksCard"></div>
                    <div class="card p-4 rounded-lg text-center cursor-pointer hover:bg-white/10 transition-colors" id="inProgressTasksCard"></div>
                    <div class="card p-4 rounded-lg text-center cursor-pointer hover:bg-white/10 transition-colors" id="notStartedTasksCard"></div>
                    <div class="card p-4 rounded-lg text-center cursor-pointer hover:bg-white/10 transition-colors" id="overdueTasksCard"></div>
                </div>

                <!-- Gantt Chart -->
                <div id="gantt-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="font-display text-2xl text-white">Diagrama de Gantt</h3>
                        <div class="flex items-center gap-4 text-sm flex-wrap">
                            <div class="flex items-center gap-2">
                                <label for="ganttStartDate" class="text-white/70">Desde:</label>
                                <input type="date" id="ganttStartDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="ganttEndDate" class="text-white/70">Hasta:</label>
                                <input type="date" id="ganttEndDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                            </div>
                            <div id="gantt-view-toggle" class="flex rounded-md bg-black/20 p-0.5">
                                <button data-view="day" class="gantt-view-btn active px-2 py-0.5 rounded-md text-xs">D√≠a</button>
                                <button data-view="week" class="gantt-view-btn px-2 py-0.5 rounded-md text-xs">Semana</button>
                            </div>
                            <button class="action-btn" id="regenerateGantt"><i data-lucide="refresh-cw" class="w-3 h-3"></i>Regenerar</button>
                        </div>
                        <div class="flex gap-2">
                             <button class="action-btn" id="expandAll"><i data-lucide="unfold-vertical"></i>Expandir</button>
                             <button class="action-btn" id="collapseAll"><i data-lucide="fold-vertical"></i>Colapsar</button>
                             <button class="action-btn" id="exportGanttJPG"><i data-lucide="image"></i>JPG</button>
                             <button class="export-btn" id="exportAllTasks"><i data-lucide="file-down"></i>CSV</button>
                        </div>
                    </div>
                    <div id="gantt-chart-container" class="w-full h-[600px] flex border border-white/10 rounded-md overflow-hidden">
                        <!-- Hierarchical Gantt will be rendered here -->
                    </div>
                </div>

                <!-- Burn-up Chart -->
                <div id="burnup-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="font-display text-2xl text-white">Gr√°fico de Avance (Curva S)</h3>
                        <div class="flex items-center gap-4 text-sm flex-wrap">
                            <div id="burnup-view-toggle" class="flex rounded-md bg-black/20 p-0.5">
                                <button data-view="day" class="gantt-view-btn px-2 py-0.5 rounded-md text-xs">D√≠a</button>
                                <button data-view="week" class="gantt-view-btn active px-2 py-0.5 rounded-md text-xs">Semana</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="action-btn" id="exportBurnupJPG"><i data-lucide="image"></i>JPG</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 text-sm flex-wrap mb-4">
                        <div class="flex items-center gap-2">
                            <label for="burnupStartDate" class="text-white/70">Desde:</label>
                            <input type="date" id="burnupStartDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="burnupEndDate" class="text-white/70">Hasta:</label>
                            <input type="date" id="burnupEndDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                        </div>
                        <button class="action-btn" id="regenerateBurnup"><i data-lucide="refresh-cw" class="w-3 h-3"></i>Regenerar</button>
                    </div>
                    <div id="burnupChart"></div>
                </div>
                
                <!-- Resource Load Chart -->
                <div id="resources-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-2 bg-[--bl-azul-oscuro]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">An√°lisis de Carga de Recursos</h3>
                        <button class="action-btn" id="exportResourcesJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div id="resourceLoadChart"></div>
                </div>

                 <!-- SPI Panel -->
                <div id="spi-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="<b>¬øQu√© es el SPI?</b><br>El √çndice de Rendimiento del Cronograma (SPI) mide la eficiencia del tiempo del proyecto. Compara el trabajo que se ha completado contra el que deber√≠a haberse completado hasta hoy.<br><br><b>Interpretaci√≥n de Colores:</b><br>üü¢ <b>Verde (SPI >= 0.98):</b> ¬°Excelente! El ritmo de trabajo es igual o mayor al planificado.<br>üü° <b>√Åmbar (0.90 a 0.97):</b> Precauci√≥n. El ritmo es ligeramente m√°s lento de lo esperado.<br>üî¥ <b>Rojo (SPI < 0.90):</b> Riesgo Alto. El ritmo de trabajo es significativamente menor al planificado.">√çndice de Rendimiento (SPI)</h3>
                        <button class="action-btn" id="exportSPIJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div id="spiValueContainer" class="flex items-center justify-center h-full">
                        <!-- SPI Value will be injected here -->
                    </div>
                </div>

                <!-- Foco en Tareas de Alto Impacto -->
                <div id="foco-critico-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="Muestra tareas que, si no se gestionan, tienen el mayor potencial de impactar negativamente el cronograma. Se basa en criticidad, urgencia y estado de avance.">Tareas de Foco Cr√≠tico</h3>
                        <button class="action-btn" id="exportFocoCriticoJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="focoCriticoList"></ul>
                </div>

                <!-- Milestone Timeline -->
                <div id="milestones-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">Hitos Principales</h3>
                        <button class="action-btn" id="exportMilestonesJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div class="relative pl-6 max-h-96 overflow-y-auto" id="milestoneTimeline"></div>
                </div>

                <!-- Critical Path -->
                <div id="criticalpath-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">Ruta Cr√≠tica</h3>
                        <button class="action-btn" id="exportCriticalPathJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="criticalPathList"></ul>
                </div>

                <!-- Risks -->
                <div id="risks-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="Identifica todas las tareas que ya han superado su fecha de finalizaci√≥n planificada pero no est√°n al 100% completadas. Son un indicador directo de los desv√≠os del proyecto.">Riesgos (Tareas Atrasadas)</h3>
                        <button class="action-btn" id="exportRisksJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="riskList"></ul>
                </div>
                
            </div>
        </section>
    </main>
    
    <!-- Task Detail Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="card w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-white/10">
                <h3 id="modal-title" class="font-display text-2xl text-[--bl-dorado]"></h3>
                <button id="modal-close-btn" class="p-1 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto">
                <!-- Task list will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Gantt Tooltip -->
    <div id="gantt-tooltip"></div>

    <!-- Footer -->
    <footer class="text-center p-4 mt-6 text-sm text-white/40">
        Copyright 2024 | BlatoRH Group | All Rights Reserved
    </footer>

    <script>
    // --- SCRIPT DE LA APLICACI√ìN ---

    let projectDataStore = {}; // Global store for full project data
    let previousProjectDataStore = null; // Store for previous project data
    let ganttViewMode = 'day'; // 'day' or 'week'
    let burnupViewMode = 'week'; // 'day' or 'week'

    // 1. DOM Elements & Initialization
    const uploadSection = document.getElementById('uploadSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const currentFileInput = document.getElementById('currentFile');
    const previousFileInput = document.getElementById('previousFile');
    const generateBtn = document.getElementById('generate-report-btn');

    [currentFileInput, previousFileInput].forEach(input => {
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const nameEl = document.getElementById(`${e.target.id}Name`);
            if (file) {
                nameEl.textContent = file.name;
            } else {
                nameEl.textContent = '';
            }
            generateBtn.disabled = !currentFileInput.files[0];
        });
    });
    
    generateBtn.addEventListener('click', handleFileSelect);

    // 2. Core File Handling and Parsing Functions
    async function handleFileSelect(event) {
        const currentFile = currentFileInput.files[0];
        const previousFile = previousFileInput.files[0];
        
        if (!currentFile) {
            alert("Debe seleccionar un 'Archivo Actual' para continuar.");
            return;
        }

        const readFile = file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        reject(new Error("Error al procesar el archivo XML."));
                    }
                    resolve(parseProjectXML(xmlDoc));
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        };

        try {
            const currentData = await readFile(currentFile);
            projectDataStore = { ...currentData, tasks: buildTaskTree(currentData.tasks) };
            
            if (previousFile) {
                const previousData = await readFile(previousFile);
                previousProjectDataStore = { ...previousData, tasks: buildTaskTree(previousData.tasks) };
            } else {
                previousProjectDataStore = null;
            }

            uploadSection.classList.add('opacity-0');
            setTimeout(() => {
                uploadSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                setTimeout(() => dashboardSection.classList.remove('opacity-0'), 50);
                processAndRenderDashboard(projectDataStore, previousProjectDataStore);
            }, 500);

        } catch (error) {
            console.error("Error processing files:", error);
            alert("Hubo un error al leer uno de los archivos del proyecto. Aseg√∫rate de que son XML v√°lidos exportados desde MS Project.");
        }
    }

    function parseProjectXML(xmlDoc) {
        const get = (el, tag) => el.getElementsByTagName(tag)[0]?.textContent || '';
        
        const resources = new Map();
        Array.from(xmlDoc.getElementsByTagName('Resource')).forEach(resEl => {
            const id = get(resEl, 'UID');
            if (id) {
                resources.set(id, { name: get(resEl, 'Name') || `Recurso ${id}` });
            }
        });

        const tasks = Array.from(xmlDoc.getElementsByTagName('Task')).map(taskEl => {
             const assignments = Array.from(taskEl.getElementsByTagName('Assignment')).map(assEl => {
                const resourceId = get(assEl, 'ResourceUID');
                return resourceId;
             });

            return {
                id: get(taskEl, 'UID'),
                name: get(taskEl, 'Name'),
                start: get(taskEl, 'Start'),
                end: get(taskEl, 'Finish'),
                percentComplete: parseFloat(get(taskEl, 'PercentComplete') || 0),
                isMilestone: get(taskEl, 'Milestone') === '1',
                isCritical: get(taskEl, 'Critical') === '1',
                outlineLevel: parseInt(get(taskEl, 'OutlineLevel') || 1),
                isSummary: get(taskEl, 'Summary') === '1',
                resourceIds: assignments,
            }
        });

        const projectSummary = tasks.find(t => t.id === '0');

        return {
            name: get(xmlDoc, 'Title') || 'Proyecto sin T√≠tulo',
            projectManager: get(xmlDoc, 'Author') || 'No especificado',
            startDate: get(xmlDoc, 'StartDate'),
            baselineEndDate: projectSummary ? projectSummary.end : get(xmlDoc, 'FinishDate'),
            tasks: tasks.filter(t => t.id !== '0' && t.name),
            resources: resources
        };
    }

    function buildTaskTree(tasks) {
        const stack = [];
        const tree = [];

        for (const task of tasks) {
            const node = { ...task, children: [] };
            while (stack.length > 0 && stack[stack.length - 1].outlineLevel >= node.outlineLevel) {
                stack.pop();
            }
            if (stack.length > 0) {
                stack[stack.length - 1].children.push(node);
            } else {
                tree.push(node);
            }
            stack.push(node);
        }
        return tree;
    }

    function flattenTasks(tasks) {
        let flat = [];
        tasks.forEach(task => {
            flat.push(task);
            if (task.children) {
                flat = flat.concat(flattenTasks(task.children));
            }
        });
        return flat;
    }


    // 3. Dashboard Processing and Rendering Functions
    function processAndRenderDashboard(data, previousData = null) {
        const today = new Date();
        const startDate = new Date(data.startDate);
        const baselineEndDate = new Date(data.baselineEndDate);
        const flatTaskList = flattenTasks(data.tasks);

        // --- Calculations ---
        const executableTasks = flatTaskList.filter(t => !t.isSummary);
        const { projectedEndDate, spi } = calculateKPIs(executableTasks, startDate, baselineEndDate, today);
        const daysRemaining = Math.max(0, Math.ceil((baselineEndDate - today) / (1000 * 60 * 60 * 24)));

        // Task Stats - Filter out summary tasks
        const taskStats = {
            completed: executableTasks.filter(t => t.percentComplete === 100),
            inProgress: executableTasks.filter(t => t.percentComplete > 0 && t.percentComplete < 100),
            notStarted: executableTasks.filter(t => t.percentComplete === 0),
            overdue: executableTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100),
        };
        
        // --- Rendering ---
        updateReportDateTime();
        populateSummary(data, projectedEndDate, daysRemaining);
        const overallProgress = executableTasks.length > 0 ? Math.round(executableTasks.reduce((acc, task) => acc + task.percentComplete, 0) / executableTasks.length) : 0;
        const timeProgress = (baselineEndDate - startDate) > 0 ? Math.min(100, Math.round(((today - startDate) / (baselineEndDate - startDate)) * 100)) : 0;
        renderGauges(overallProgress, timeProgress);
        renderSPI(spi);
        renderRagStatus(projectedEndDate, baselineEndDate, taskStats.overdue.length, executableTasks.length);
        setupGlobalTooltips();
        renderTaskStats(taskStats);
        setupGanttFilters(data.startDate, data.baselineEndDate);
        filterAndRenderGantt(); // Initial Gantt render
        setupBurnUpFilters(data.startDate, data.baselineEndDate);
        filterAndRenderBurnup(executableTasks); // Initial Burn-up render
        renderResourceLoadChart(executableTasks, data.resources);
        renderMilestoneTimeline(flatTaskList);
        renderCriticalPath(executableTasks);
        renderFocoCritico(executableTasks, today);
        renderRisks(executableTasks, today);

        if (previousData) {
            renderTrendAnalysis(data, previousData);
        }

        addExportFunctionality({ ...data, tasks: flatTaskList });
    }

    function calculateKPIs(executableTasks, startDate, baselineEndDate, today) {
        const overallProgress = executableTasks.length > 0 ? Math.round(executableTasks.reduce((acc, task) => acc + task.percentComplete, 0) / executableTasks.length) : 0;
        const timeProgress = (baselineEndDate - startDate) > 0 ? Math.min(100, Math.round(((today - startDate) / (baselineEndDate - startDate)) * 100)) : 0;

        const performanceFactor = timeProgress > 0 ? (overallProgress / timeProgress) : 1;
        const totalPlannedDuration = (baselineEndDate - startDate) / (1000 * 60 * 60 * 24);
        const projectedDuration = totalPlannedDuration / (performanceFactor || 1);
        const projectedEndDate = new Date(startDate.getTime() + projectedDuration * 1000 * 60 * 60 * 24);

        const EV = executableTasks.filter(t => t.percentComplete === 100).length;
        const PV = executableTasks.filter(t => new Date(t.end) <= today).length;
        const spi = (PV > 0) ? (EV / PV) : 1.00;

        return { projectedEndDate, spi, overallProgress };
    }
    
    function populateSummary(data, projectedEndDate, daysRemaining) {
        document.getElementById('projectName').textContent = data.name;
        document.getElementById('projectManager').textContent = `Project Manager: ${data.projectManager}`;
        document.getElementById('startDate').textContent = formatDate(data.startDate);
        document.getElementById('baselineEndDate').textContent = formatDate(data.baselineEndDate);
        document.getElementById('projectedEndDate').textContent = formatDate(projectedEndDate);
        document.getElementById('daysRemaining').textContent = daysRemaining;
    }

    function updateReportDateTime() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = String(now.getFullYear()).slice(-2);
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes}`;
        const reportDateEl = document.getElementById('report-date');
        if(reportDateEl) {
            reportDateEl.textContent = `Generado el: ${formattedDateTime}`;
        }
    }


    function renderGauges(progress, time) {
        document.getElementById('progressChart').innerHTML = '';
        document.getElementById('timeChart').innerHTML = '';
        const gaugeOptions = (series, label) => ({
            chart: { type: 'radialBar', height: 250, sparkline: { enabled: true } },
            plotOptions: { radialBar: { hollow: { size: '70%' }, track: { background: 'rgba(255, 255, 255, 0.1)' }, dataLabels: { name: { offsetY: -10, color: '#B1A96E', fontFamily: 'Bebas Neue', fontSize: '20px' }, value: { offsetY: 5, color: '#FFFFFF', fontFamily: 'Exo', fontSize: '24px', formatter: val => val + "%" } } } },
            fill: { colors: ['#B1A96E'] }, stroke: { lineCap: 'round' }, series: [series], labels: [label]
        });
        new ApexCharts(document.querySelector("#progressChart"), gaugeOptions(progress, 'Progreso General')).render();
        new ApexCharts(document.querySelector("#timeChart"), gaugeOptions(time, 'Tiempo Transcurrido')).render();
    }

    function renderSPI(spi) {
        const container = document.getElementById('spiValueContainer');
        let colorClass = 'text-green-400';
        if (spi < 0.9) {
            colorClass = 'text-red-400';
        } else if (spi <= 0.98) {
            colorClass = 'text-yellow-400';
        }
        container.innerHTML = `<div class="text-center"><p class="font-display text-7xl ${colorClass}">${spi.toFixed(2)}</p></div>`;
    }
    
    function renderRagStatus(projectedEndDate, baselineEndDate, overdueTasksCount, totalTasks) {
        const container = document.getElementById('ragStatusContainer');
        container.innerHTML = '';
        const timeDiffDays = (projectedEndDate - baselineEndDate) / (1000 * 60 * 60 * 24);

        let timeColor = 'bg-green-500';
        let timeTooltip = "<b>Estado del Tiempo: Verde</b><br>¬°Excelente! El proyecto est√° en camino de terminar en la fecha original o antes.";
        if (timeDiffDays > 14) {
            timeColor = 'bg-red-500';
            timeTooltip = "<b>Estado del Tiempo: Rojo</b><br>Riesgo Alto. El proyecto tiene un retraso significativo (m√°s de 14 d√≠as).";
        } else if (timeDiffDays > 0) {
            timeColor = 'bg-yellow-500';
            timeTooltip = "<b>Estado del Tiempo: √Åmbar</b><br>Atenci√≥n. Hay un ligero retraso (hasta 14 d√≠as) sobre la fecha planificada.";
        }

        let tasksColor = 'bg-green-500';
        let tasksTooltip = "<b>Estado de Tareas: Verde</b><br>¬°Perfecto! No hay ninguna tarea atrasada en el proyecto.";
        if (totalTasks > 0 && (overdueTasksCount / totalTasks) > 0.1) {
            tasksColor = 'bg-red-500';
            tasksTooltip = "<b>Estado de Tareas: Rojo</b><br>Problema. M√°s del 10% del total de las tareas est√°n atrasadas.";
        } else if (overdueTasksCount > 0) {
            tasksColor = 'bg-yellow-500';
            tasksTooltip = "<b>Estado de Tareas: √Åmbar</b><br>Precauci√≥n. Hay tareas atrasadas, pero representan menos del 10% del total.";
        }

        const createRagItem = (color, label, tooltipText) => `
            <div class="text-center cursor-pointer" data-tooltip-text="${tooltipText.replace(/"/g, '&quot;')}">
                <div class="w-16 h-16 rounded-full ${color} mx-auto mb-2 border-4 border-white/20 pointer-events-none"></div>
                <h4 class="font-display text-xl pointer-events-none">${label}</h4>
            </div>`;
        container.innerHTML = createRagItem(timeColor, 'Tiempo', timeTooltip) + createRagItem(tasksColor, 'Tareas', tasksTooltip);
    }

    function setupGlobalTooltips() {
        const tooltip = document.getElementById('gantt-tooltip');
        document.body.addEventListener('mousemove', (e) => {
            const target = e.target.closest('[data-tooltip-text]');
            if (target) {
                tooltip.style.display = 'block';
                tooltip.style.left = `${e.clientX + 15}px`;
                tooltip.style.top = `${e.clientY + 15}px`;
                tooltip.innerHTML = target.dataset.tooltipText;
            } else {
                 const ganttBar = e.target.closest('.gantt-bar, .gantt-milestone');
                if(!ganttBar) {
                    tooltip.style.display = 'none';
                }
            }
        });
         document.body.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
        });
    }

    function renderTaskStats(stats) {
        const createTaskCard = (id, count, label, icon, colorClass) => {
            document.getElementById(id).innerHTML = `
                <i data-lucide="${icon}" class="w-8 h-8 mx-auto mb-2 ${colorClass}"></i>
                <p class="font-display text-4xl text-white">${count}</p>
                <h4 class="font-display text-lg ${colorClass}">${label}</h4>`;
        };
        createTaskCard('completedTasksCard', stats.completed.length, 'Completadas', 'check-circle-2', 'text-green-400');
        createTaskCard('inProgressTasksCard', stats.inProgress.length, 'En Progreso', 'loader-2', 'text-blue-400');
        createTaskCard('notStartedTasksCard', stats.notStarted.length, 'Por Iniciar', 'circle-dashed', 'text-gray-400');
        createTaskCard('overdueTasksCard', stats.overdue.length, 'Atrasadas', 'alert-triangle', 'text-red-400');
        lucide.createIcons();

        // Add double-click listeners
        document.getElementById('inProgressTasksCard').addEventListener('dblclick', () => showTaskModal('Tareas en Progreso', stats.inProgress));
        document.getElementById('notStartedTasksCard').addEventListener('dblclick', () => showTaskModal('Tareas por Iniciar', stats.notStarted));
        document.getElementById('overdueTasksCard').addEventListener('dblclick', () => showTaskModal('Tareas Atrasadas', stats.overdue));
    }

    function setupGanttFilters(projectStart, projectEnd) {
        const startDateInput = document.getElementById('ganttStartDate');
        const endDateInput = document.getElementById('ganttEndDate');
        
        startDateInput.value = new Date(projectStart).toISOString().split('T')[0];
        endDateInput.value = new Date(projectEnd).toISOString().split('T')[0];
        
        document.getElementById('regenerateGantt').addEventListener('click', filterAndRenderGantt);
        
        document.querySelectorAll('#gantt-view-toggle .gantt-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                ganttViewMode = btn.dataset.view;
                document.querySelector('#gantt-view-toggle .gantt-view-btn.active').classList.remove('active');
                btn.classList.add('active');
                filterAndRenderGantt();
            });
        });
        
        document.getElementById('expandAll').addEventListener('click', () => {
            toggleAll(projectDataStore.tasks, false);
            filterAndRenderGantt();
        });
        document.getElementById('collapseAll').addEventListener('click', () => {
            toggleAll(projectDataStore.tasks, true);
            filterAndRenderGantt();
        });
    }

    function toggleAll(tasks, collapse) {
        tasks.forEach(task => {
            if (task.isSummary) {
                task.isCollapsed = collapse;
                if (task.children) {
                    toggleAll(task.children, collapse);
                }
            }
        });
    }

    function filterTaskTree(tasks, rangeStart, rangeEnd) {
        const filtered = [];
        tasks.forEach(task => {
            const taskStart = new Date(task.start);
            const taskEnd = new Date(task.end);
            let children = [];
            if (task.children && task.children.length > 0) {
                children = filterTaskTree(task.children, rangeStart, rangeEnd);
            }
            const intersects = (taskEnd >= rangeStart && taskStart <= rangeEnd);
            if (intersects || children.length > 0) {
                filtered.push({ ...task, children: children });
            }
        });
        return filtered;
    }
    
    function filterAndRenderGantt() {
        if (!projectDataStore.tasks) return;
        const filterStart = new Date(document.getElementById('ganttStartDate').value);
        const filterEnd = new Date(document.getElementById('ganttEndDate').value);
        const filteredTree = filterTaskTree(projectDataStore.tasks, filterStart, filterEnd);
        renderGanttChart(filteredTree);
    }

    function renderGanttChart(taskTree) {
        const container = document.getElementById('gantt-chart-container');
        container.innerHTML = `
            <div id="gantt-task-list" class="w-1/3 h-full overflow-y-auto overflow-x-hidden border-r border-white/10 shrink-0"></div>
            <div id="gantt-timeline-wrapper" class="w-2/3 h-full overflow-auto">
                <div id="gantt-timeline-header" class="sticky top-0 z-10 h-[64px]"></div>
                <div id="gantt-timeline" class="relative"></div>
            </div>`;

        const taskListEl = document.getElementById('gantt-task-list');
        const timelineWrapperEl = document.getElementById('gantt-timeline-wrapper');
        const timelineHeaderEl = document.getElementById('gantt-timeline-header');
        const timelineEl = document.getElementById('gantt-timeline');

        const filterStart = new Date(document.getElementById('ganttStartDate').value);
        const filterEnd = new Date(document.getElementById('ganttEndDate').value);
        const tooltip = document.getElementById('gantt-tooltip');
        
        const DAY_WIDTH = 40;
        const WEEK_WIDTH = 60;
        const ROW_HEIGHT = 32;
        
        const unitWidth = ganttViewMode === 'day' ? DAY_WIDTH : WEEK_WIDTH;

        // Render timeline header
        timelineHeaderEl.innerHTML = ''; // Clear header
        if (ganttViewMode === 'day') {
             renderDayHeader(timelineHeaderEl, filterStart, filterEnd);
        } else {
             renderWeekHeader(timelineHeaderEl, filterStart, filterEnd);
        }
        
        let visibleRowCount = 0;
        
        function renderRows(tasks, parentIsCollapsed = false) {
            tasks.forEach(task => {
                const isCollapsed = task.isSummary && (task.isCollapsed === undefined ? true : task.isCollapsed);
                const isHidden = parentIsCollapsed;

                if (!isHidden) {
                    const taskStart = new Date(task.start);
                    const taskEnd = new Date(task.end);
                    const keywordMilestone = /hito|sign off|entrega|fin/i.test(task.name);
                    const isVisuallyMilestone = task.isMilestone || (taskStart.getTime() === taskEnd.getTime()) || keywordMilestone;
    
                    // Create Task Label Row
                    const taskRow = document.createElement('div');
                    taskRow.className = 'gantt-row flex items-center text-sm px-2';
                    taskRow.style.paddingLeft = `${(task.outlineLevel - 1) * 20 + 8}px`;
                    
                    let toggleIcon = task.isSummary
                        ? `<i data-lucide="chevron-down" class="toggle-btn shrink-0 mr-1 ${isCollapsed ? 'collapsed' : ''}"></i>`
                        : (isVisuallyMilestone ? '<span class="text-[--bl-dorado] w-4 mr-1 text-center font-bold">‚óÜ</span>' : `<span class="w-4 mr-1"></span>`);

                    taskRow.innerHTML = `${toggleIcon}<span class="gantt-task-name ${task.isSummary ? 'summary-task' : ''}" title="${task.name}">${task.name}</span>`;
                    taskListEl.appendChild(taskRow);
                    
                    if (task.isSummary) {
                        taskRow.querySelector('.toggle-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            task.isCollapsed = !isCollapsed;
                            filterAndRenderGantt();
                        });
                    }

                    // Create Gantt Bar/Milestone
                    const offset = ganttViewMode === 'day' 
                        ? (taskStart - filterStart) / (1000 * 60 * 60 * 24)
                        : (taskStart - filterStart) / (1000 * 60 * 60 * 24 * 7);

                    let barElement;
                    if (isVisuallyMilestone) {
                        barElement = document.createElement('div');
                        barElement.className = 'gantt-milestone';
                        barElement.style.left = `${offset * unitWidth + (unitWidth / 2) - 8}px`;
                    } else {
                        const duration = ganttViewMode === 'day'
                            ? (taskEnd - taskStart) / (1000 * 60 * 60 * 24)
                            : (taskEnd - taskStart) / (1000 * 60 * 60 * 24 * 7);

                        barElement = document.createElement('div');
                        barElement.className = 'gantt-bar';
                        barElement.style.left = `${offset * unitWidth}px`;
                        barElement.style.width = `${duration * unitWidth}px`;
                        
                        const progress = document.createElement('div');
                        let bgColor = task.isCritical ? 'bg-amber-500' : 'bg-[--bl-azul-principal]';
                        if (task.percentComplete === 100) bgColor = 'bg-green-500';
                        progress.className = `gantt-bar-progress ${bgColor}`;
                        progress.style.width = `${task.percentComplete}%`;
                        
                        if(duration * unitWidth > 35) {
                            const label = document.createElement('span');
                            label.className = 'gantt-bar-label';
                            label.textContent = `${task.percentComplete}%`;
                            progress.appendChild(label);
                        }
                        barElement.appendChild(progress);
                    }
                    
                    barElement.style.top = `${visibleRowCount * ROW_HEIGHT}px`;
                    timelineEl.appendChild(barElement);

                    barElement.addEventListener('mousemove', e => {
                        tooltip.style.display = 'block';
                        tooltip.style.left = `${e.clientX + 15}px`;
                        tooltip.style.top = `${e.clientY + 15}px`;
                        let tooltipContent = `<strong>${task.name}</strong><br>Inicio: ${formatDate(task.start)}`;
                        if (!isVisuallyMilestone) {
                            tooltipContent += `<br>Fin: ${formatDate(task.end)}<br>Avance: ${task.percentComplete}%`;
                        }
                        tooltip.innerHTML = tooltipContent;
                    });
                    barElement.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                    
                    visibleRowCount++;
                }
                
                if (task.children && task.children.length > 0) {
                    renderRows(task.children, isHidden || isCollapsed);
                }
            });
        }
        
        renderRows(taskTree);
        const totalHeight = visibleRowCount * ROW_HEIGHT;
        taskListEl.style.height = `${totalHeight}px`;
        timelineEl.style.height = `${totalHeight}px`;

        let isSyncingScroll = false;
        timelineWrapperEl.addEventListener('scroll', () => {
            if (isSyncingScroll) return;
            isSyncingScroll = true;
            taskListEl.scrollTop = timelineWrapperEl.scrollTop;
            isSyncingScroll = false;
        });
        taskListEl.addEventListener('scroll', () => {
            if (isSyncingScroll) return;
            isSyncingScroll = true;
            timelineWrapperEl.scrollTop = taskListEl.scrollTop;
            isSyncingScroll = false;
        });

        lucide.createIcons();
    }
    
    function renderDayHeader(headerEl, filterStart, filterEnd) {
        const totalDays = Math.max(0, Math.round((filterEnd - filterStart) / (1000 * 60 * 60 * 24)));
        const chartWidth = totalDays * 40;
        headerEl.style.width = `${chartWidth}px`;
        
        const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const monthsEl = document.createElement('div');
        monthsEl.className = 'flex gantt-row';
        const daysEl = document.createElement('div');
        daysEl.className = 'flex gantt-row';
        headerEl.appendChild(monthsEl);
        headerEl.appendChild(daysEl);

        let currentMonth = -1;
        let monthDayCount = 0;
        let lastMonthDiv = null;

        for (let i = 0; i <= totalDays; i++) {
            const date = new Date(filterStart);
            date.setUTCDate(date.getUTCDate() + i);
            const month = date.getUTCMonth();

            const dayDiv = document.createElement('div');
            dayDiv.className = 'shrink-0 text-center text-xs text-white/60 border-r border-white/10 flex items-center justify-center';
            dayDiv.style.width = '40px';
            dayDiv.textContent = date.getUTCDate();
            daysEl.appendChild(dayDiv);

            if (month !== currentMonth) {
                if (lastMonthDiv) lastMonthDiv.style.width = `${monthDayCount * 40}px`;
                monthDayCount = 0;
                currentMonth = month;
                const monthName = `${monthNames[month]} ${date.getUTCFullYear()}`;
                const monthDiv = document.createElement('div');
                monthDiv.className = 'shrink-0 border-r border-white/10 text-center font-semibold text-sm flex items-center justify-center';
                monthDiv.textContent = monthName;
                monthsEl.appendChild(monthDiv);
                lastMonthDiv = monthDiv;
            }
            monthDayCount++;
        }
        if (lastMonthDiv) lastMonthDiv.style.width = `${monthDayCount * 40}px`;
    }

    function renderWeekHeader(headerEl, filterStart, filterEnd) {
        const totalWeeks = Math.max(0, Math.ceil(((filterEnd - filterStart) / (1000 * 60 * 60 * 24)) / 7));
        const chartWidth = totalWeeks * 60;
        headerEl.style.width = `${chartWidth}px`;
        
        const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const monthsEl = document.createElement('div');
        monthsEl.className = 'flex gantt-row';
        const weeksEl = document.createElement('div');
        weeksEl.className = 'flex gantt-row';
        headerEl.appendChild(monthsEl);
        headerEl.appendChild(weeksEl);

        let currentMonth = -1;
        let monthWeekCount = 0;
        let lastMonthDiv = null;

        let weekStartDate = new Date(filterStart);
        while (weekStartDate < filterEnd) {
            const month = weekStartDate.getUTCMonth();
            const weekDiv = document.createElement('div');
            weekDiv.className = 'shrink-0 text-center text-xs text-white/60 border-r border-white/10 flex items-center justify-center';
            weekDiv.style.width = '60px';
            weekDiv.textContent = `S${getWeekNumber(weekStartDate)}`;
            weeksEl.appendChild(weekDiv);
            
            if (month !== currentMonth) {
                 if (lastMonthDiv) lastMonthDiv.style.width = `${monthWeekCount * 60}px`;
                monthWeekCount = 0;
                currentMonth = month;
                const monthName = `${monthNames[month]} ${weekStartDate.getUTCFullYear()}`;
                const monthDiv = document.createElement('div');
                monthDiv.className = 'shrink-0 border-r border-white/10 text-center font-semibold text-sm flex items-center justify-center';
                monthDiv.textContent = monthName;
                monthsEl.appendChild(monthDiv);
                lastMonthDiv = monthDiv;
            }
            monthWeekCount++;
            weekStartDate.setUTCDate(weekStartDate.getUTCDate() + 7);
        }
        if (lastMonthDiv) lastMonthDiv.style.width = `${monthWeekCount * 60}px`;
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        return weekNo;
    }

    function setupBurnUpFilters(projectStart, projectEnd) {
        const startDateInput = document.getElementById('burnupStartDate');
        const endDateInput = document.getElementById('burnupEndDate');
        
        startDateInput.value = new Date(projectStart).toISOString().split('T')[0];
        endDateInput.value = new Date(projectEnd).toISOString().split('T')[0];
        
        document.getElementById('regenerateBurnup').addEventListener('click', () => {
             const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary);
             filterAndRenderBurnup(flatTaskList);
        });

        document.querySelectorAll('#burnup-view-toggle .gantt-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                burnupViewMode = btn.dataset.view;
                document.querySelector('#burnup-view-toggle .gantt-view-btn.active').classList.remove('active');
                btn.classList.add('active');
                const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary);
                filterAndRenderBurnup(flatTaskList);
            });
        });
    }

     function filterAndRenderBurnup(executableTasks) {
        if (!executableTasks) return;
        const filterStart = new Date(document.getElementById('burnupStartDate').value);
        const filterEnd = new Date(document.getElementById('burnupEndDate').value);
        renderBurnUpChart(executableTasks, filterStart, filterEnd);
    }

    function renderBurnUpChart(tasks, startDate, endDate) {
        document.getElementById('burnupChart').innerHTML = '';
        const burnupData = generateBurnUpData(tasks, startDate, endDate);
        const options = {
            series: [
                { name: 'Plan de Finalizaci√≥n (Curva S)', data: burnupData.planned }, 
                { name: 'Avance Real', data: burnupData.completed }
            ],
            chart: { type: 'area', height: 350, toolbar: { show: false }, background: 'transparent' },
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 2 },
            xaxis: { 
                type: 'datetime', 
                categories: burnupData.categories, 
                labels: { 
                    style: { 
                        colors: '#FFFFFF' 
                    },
                    formatter: function(value, timestamp) {
                        if (timestamp) {
                            const date = new Date(timestamp);
                             if (burnupViewMode === 'week') {
                                const week = getWeekNumber(date);
                                const month = date.toLocaleString('es-AR', { month: 'short', timeZone: 'UTC' });
                                const year = date.getUTCFullYear();
                                const capitalizedMonth = month.charAt(0).toUpperCase() + month.slice(1).replace('.','');
                                return `S${week} - ${capitalizedMonth} ${year}`;
                             }
                             return date.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', timeZone:'UTC'});
                        }
                        return value;
                    },
                    rotate: -45,
                    hideOverlappingLabels: true,
                }
            },
            yaxis: { 
                labels: { 
                    style: { 
                        colors: '#FFFFFF' 
                    },
                    formatter: function (value) {
                        return Math.round(value);
                    }
                },
                title: { text: 'N¬∫ de Tareas', style: { color: '#FFFFFF', fontWeight: 'normal'} }
            },
            tooltip: { 
                theme: 'dark', 
                x: { 
                    formatter: function(value) {
                        const date = new Date(value);
                        return `${burnupViewMode === 'week' ? 'Semana del' : ''} ${date.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', year:'numeric', timeZone:'UTC'})}`;
                    }
                }
            },
            grid: { borderColor: 'rgba(255,255,255,0.2)' },
            legend: { labels: { colors: '#FFFFFF' } },
            colors: ['#FFFFFF', '#B1A96E']
        };
        new ApexCharts(document.querySelector("#burnupChart"), options).render();
    }

    function renderMilestoneTimeline(tasks) {
        const container = document.getElementById('milestoneTimeline');
        container.innerHTML = '';
        tasks.filter(t => t.isMilestone).forEach(milestone => {
            const isCompleted = milestone.percentComplete === 100;
            const item = document.createElement('div');
            item.className = 'relative pl-8 pb-8 timeline-item';
            item.innerHTML = `<div class="timeline-dot ${isCompleted ? 'completed' : ''}"></div><p class="text-sm text-white/60">${formatDate(milestone.start)}</p><h5 class="font-semibold text-white">${milestone.name}</h5>`;
            container.appendChild(item);
        });
    }

    function renderCriticalPath(tasks) {
        const container = document.getElementById('criticalPathList');
        container.innerHTML = '';
        tasks.filter(t => t.isCritical && !t.isMilestone).forEach(task => {
            const item = document.createElement('li');
            item.className = 'flex items-center text-sm';
            item.innerHTML = `<i data-lucide="link-2" class="w-4 h-4 shrink-0 mr-2 text-white/50"></i><span class="truncate">${task.name}</span>`;
            container.appendChild(item);
        });
        lucide.createIcons();
    }

    function renderFocoCritico(tasks, today) {
        const container = document.getElementById('focoCriticoList');
        container.innerHTML = '';
        const sevenDaysFromNow = new Date(today);
        sevenDaysFromNow.setDate(today.getDate() + 7);

        const focoTasks = new Map();

        // Criterio 1: Tareas cr√≠ticas no iniciadas con fecha de inicio inminente (pr√≥ximos 7 d√≠as)
        tasks.filter(t => t.isCritical && t.percentComplete === 0 && new Date(t.start) >= today && new Date(t.start) <= sevenDaysFromNow)
            .forEach(t => {
                if (!focoTasks.has(t.id)) {
                    focoTasks.set(t.id, { task: t, reasons: [] });
                }
                focoTasks.get(t.id).reasons.push({ text: 'Inicio Inminente', color: 'text-blue-400', icon: 'play-circle' });
            });

        // Criterio 2: Tareas cr√≠ticas en progreso con bajo avance (menor al 50%)
        tasks.filter(t => t.isCritical && t.percentComplete > 0 && t.percentComplete < 50)
            .sort((a, b) => a.percentComplete - b.percentComplete)
            .slice(0, 5) // Tomar las 5 con menor avance
            .forEach(t => {
                if (!focoTasks.has(t.id)) {
                    focoTasks.set(t.id, { task: t, reasons: [] });
                }
                focoTasks.get(t.id).reasons.push({ text: `Bajo Avance (${t.percentComplete}%)`, color: 'text-yellow-400', icon: 'trending-down' });
            });

        // Criterio 3: Tareas cr√≠ticas atrasadas (ya deber√≠an haber terminado)
        tasks.filter(t => t.isCritical && t.percentComplete < 100 && new Date(t.end) < today)
            .forEach(t => {
                if (!focoTasks.has(t.id)) {
                    focoTasks.set(t.id, { task: t, reasons: [] });
                }
                focoTasks.get(t.id).reasons.push({ text: 'Atrasada', color: 'text-red-400', icon: 'alert-triangle' });
            });

        if (focoTasks.size === 0) {
            container.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="shield-check" class="w-4 h-4 shrink-0 mr-2"></i>No se identifican tareas de foco cr√≠tico.</li>`;
        } else {
            focoTasks.forEach(data => {
                const item = document.createElement('li');
                item.className = 'flex items-start text-sm';
                
                const reasonsHTML = data.reasons.map(reason => 
                    `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${reason.color} bg-opacity-20 bg-current mr-2">${reason.text}</span>`
                ).join('');

                item.innerHTML = `
                    <i data-lucide="target" class="w-4 h-4 shrink-0 mr-2 mt-0.5 text-[--bl-dorado]"></i>
                    <div>
                        <span class="font-semibold text-white">${data.task.name}</span>
                        <div class="flex flex-wrap mt-1">${reasonsHTML}</div>
                    </div>`;
                container.appendChild(item);
            });
        }
        lucide.createIcons();
    }

    function renderRisks(tasks, today) {
        const container = document.getElementById('riskList');
        container.innerHTML = '';
        const risks = [];
        tasks.filter(t => new Date(t.end) < today && t.percentComplete < 100).forEach(t => risks.push({ type: 'Tarea Atrasada', text: t.name }));
        if (risks.length === 0) {
            container.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="shield-check" class="w-4 h-4 shrink-0 mr-2"></i>No se han detectado riesgos mayores.</li>`;
        } else {
            risks.forEach(risk => {
                const item = document.createElement('li');
                item.className = 'flex items-start text-sm';
                item.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 shrink-0 mr-2 mt-0.5 text-yellow-400"></i><div><span class="font-semibold text-white">${risk.type}:</span><span class="text-white/80"> ${risk.text}</span></div>`;
                container.appendChild(item);
            });
        }
        lucide.createIcons();
    }
    
    function renderResourceLoadChart(tasks, resourcesMap) {
        const chartEl = document.getElementById('resourceLoadChart');
        chartEl.innerHTML = '';

        const genericResourceLoad = new Map();

        tasks.forEach(task => {
            task.resourceIds.forEach(resId => {
                const resource = resourcesMap.get(resId);
                if(resource && resource.name) {
                    const genericName = resource.name.replace(/\s*\d+\s*$/, '').trim();
                    if (!genericResourceLoad.has(genericName)) {
                        genericResourceLoad.set(genericName, { count: 0, tasks: [] });
                    }
                    const load = genericResourceLoad.get(genericName);
                    load.count++;
                    load.tasks.push(task);
                }
            });
        });
        
        if (genericResourceLoad.size === 0) {
            chartEl.innerHTML = '<p class="text-center text-white/50">No hay recursos asignados a tareas.</p>';
            return;
        }

        const sortedResources = [...genericResourceLoad.entries()].sort((a,b) => b[1].count - a[1].count);
        const avgTasks = tasks.length / genericResourceLoad.size;
        
        const chartData = sortedResources.map(([name, data]) => ({
            x: data.count,
            y: name,
            fillColor: data.count > avgTasks * 1.5 ? '#ef4444' : (data.count > avgTasks * 1.1 ? '#B1A96E' : '#1A77D2')
        }));

        const options = {
            series: [{ data: chartData }],
            chart: { type: 'bar', height: 100 + sortedResources.length * 30, background: 'transparent', toolbar: { show: false },
                events: {
                    dataPointSelection: (event, chartContext, config) => {
                        const resourceName = config.w.globals.labels[config.dataPointIndex];
                        const allTasksForRole = [];
                         tasks.forEach(task => {
                            const hasResource = task.resourceIds.some(resId => {
                                const resource = resourcesMap.get(resId);
                                return resource && resource.name.replace(/\s*\d+\s*$/, '').trim() === resourceName;
                            });
                            if (hasResource) {
                                allTasksForRole.push(task);
                            }
                        });
                        showTaskModal(`Tareas asignadas a: ${resourceName}`, allTasksForRole, true);
                    }
                }
            },
            plotOptions: { bar: { borderRadius: 4, horizontal: true, distributed: true, dataLabels: { position: 'top' } } },
            dataLabels: { enabled: true, offsetX: 15, style: { colors: ['#fff'], fontSize: '12px' } },
            legend: { show: false },
            xaxis: { categories: sortedResources.map(([name, data]) => name), labels: { style: { colors: '#FFFFFF' } }, title: { text: 'N¬∫ de Tareas Asignadas', style: { color: '#FFFFFF', fontWeight: 'normal'} } },
            yaxis: { labels: { style: { colors: '#FFFFFF' } } },
            grid: { borderColor: 'rgba(255,255,255,0.1)' }
        };
        new ApexCharts(chartEl, options).render();
    }


    // 4. Utility & Helper Functions
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' });
    }
    
    function generateBurnUpData(tasks, startDate, endDate) {
        const data = { planned: [], completed: [], categories: [] };
        if (!startDate || !endDate || startDate > endDate) return data;
        
        const relevantTasks = tasks.filter(t => {
            const taskEnd = new Date(t.end);
            return taskEnd >= startDate && taskEnd <= endDate;
        });

        const increment = burnupViewMode === 'day' ? 1 : 7;

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + increment)) {
            const datePoint = d.toISOString().split('T')[0];
            data.categories.push(datePoint);

            const plannedOnDate = relevantTasks.filter(t => new Date(t.end) <= d).length;
            data.planned.push(plannedOnDate);
            
            const completedOnDate = relevantTasks.filter(t => t.percentComplete === 100 && new Date(t.end) <= d).length;
            data.completed.push(completedOnDate);
        }
        return data;
    }

    function showTaskModal(title, tasks) {
        const modal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        
        modalTitle.textContent = title;
        modalContent.innerHTML = '';

        if (tasks.length === 0) {
            modalContent.innerHTML = '<p class="text-white/60">No hay tareas para mostrar en esta categor√≠a.</p>';
        } else {
            let tableHTML = `
                <table class="w-full text-sm text-left table-fixed">
                    <thead class="text-xs text-white/70 uppercase">
                        <tr>
                            <th scope="col" class="px-4 py-2 w-[40%]">Nombre Tarea</th>
                            <th scope="col" class="px-4 py-2 w-[20%]">Recurso(s)</th>
                            <th scope="col" class="px-4 py-2 w-[15%]">Fecha Inicio</th>
                            <th scope="col" class="px-4 py-2 w-[15%]">Fecha Fin</th>
                            <th scope="col" class="px-4 py-2 w-[10%] text-right">Avance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            tasks.forEach(task => {
                const resourceNames = task.resourceIds.map(id => projectDataStore.resources.get(id)?.name || '').join(', ');
                tableHTML += `
                    <tr class="border-b border-white/10 hover:bg-white/5">
                        <td class="px-4 py-2 font-medium truncate" title="${task.name}">${task.name}</td>
                        <td class="px-4 py-2 text-xs truncate" title="${resourceNames}">${resourceNames}</td>
                        <td class="px-4 py-2">${formatDate(task.start)}</td>
                        <td class="px-4 py-2">${formatDate(task.end)}</td>
                        <td class="px-4 py-2 text-right">${task.percentComplete}%</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            modalContent.innerHTML = tableHTML;
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    // Modal close logic
    const modal = document.getElementById('task-modal');
    document.getElementById('modal-close-btn').addEventListener('click', () => modal.classList.add('hidden'));
    modal.addEventListener('click', (e) => {
        if (e.target.id === 'task-modal') {
            modal.classList.add('hidden');
        }
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape" && !modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
        }
    });
    
    function addExportFunctionality(data) {
        const addClickListener = (id, generator) => {
            const button = document.getElementById(id);
            if (!button) return;
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            newButton.addEventListener('click', generator);
        };

        addClickListener('exportGanttJPG', () => exportElementAsJPG('gantt-container-for-export', 'exportGanttJPG'));
        addClickListener('exportBurnupJPG', () => exportElementAsJPG('burnup-container-for-export', 'exportBurnupJPG'));
        addClickListener('exportResourcesJPG', () => exportElementAsJPG('resources-container-for-export', 'exportResourcesJPG'));
        addClickListener('exportMilestonesJPG', () => exportElementAsJPG('milestones-container-for-export', 'exportMilestonesJPG'));
        addClickListener('exportCriticalPathJPG', () => exportElementAsJPG('criticalpath-container-for-export', 'exportCriticalPathJPG'));
        addClickListener('exportFocoCriticoJPG', () => exportElementAsJPG('foco-critico-container-for-export', 'exportFocoCriticoJPG'));
        addClickListener('exportRisksJPG', () => exportElementAsJPG('risks-container-for-export', 'exportRisksJPG'));
        addClickListener('exportSPIJPG', () => exportElementAsJPG('spi-container-for-export', 'exportSPIJPG'));
        addClickListener('exportTrendJPG', () => exportElementAsJPG('trend-analysis-container-for-export', 'exportTrendJPG'));


        addClickListener('exportAllTasks', () => {
             const csvData = generateHierarchicalCSVData(projectDataStore.tasks);
             exportToCSV(csvData, 'gantt_proyecto.csv');
        });
    }

    async function exportElementAsJPG(elementId, buttonId) {
        const containerToExport = document.getElementById(elementId);
        const button = document.getElementById(buttonId);
        const originalButtonHTML = button.innerHTML;
        button.innerHTML = 'Generando...';
        button.disabled = true;

        const clone = containerToExport.cloneNode(true);
        clone.id = `${elementId}-clone`;
        clone.style.position = 'absolute';
        clone.style.left = '-9999px';
        clone.style.top = '0px';
        clone.style.width = '1200px'; 
        document.body.appendChild(clone);
        
        const ganttContainerClone = clone.querySelector('#gantt-chart-container');
        if (ganttContainerClone) {
            const taskListClone = clone.querySelector('#gantt-task-list');
            const timelineWrapperClone = clone.querySelector('#gantt-timeline-wrapper');
            const timelineClone = clone.querySelector('#gantt-timeline');
            
            if (taskListClone && timelineWrapperClone && timelineClone) {
                const fullHeight = taskListClone.scrollHeight;
                ganttContainerClone.style.height = `${fullHeight + 20}px`; // Add padding
                ganttContainerClone.style.overflow = 'visible';
                taskListClone.style.height = `${fullHeight}px`;
                taskListClone.style.overflow = 'visible';
                timelineWrapperClone.style.height = `${fullHeight + 64 + 20}px`; // Add header and padding
                timelineWrapperClone.style.overflow = 'visible';
            }
        }
        
        await new Promise(resolve => setTimeout(resolve, 100));

        try {
            const canvas = await html2canvas(clone, {
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bl-azul-oscuro').trim(),
                scale: 2,
                useCORS: true,
                logging: false,
            });

            const link = document.createElement('a');
            const fileName = `${elementId.split('-')[0]}_proyecto_${new Date().toISOString().split('T')[0]}.jpg`;
            link.download = fileName;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();

        } catch (err) {
            console.error("Error al exportar JPG:", err);
            alert("Hubo un problema al generar la imagen.");
        } finally {
            document.body.removeChild(clone);
            button.innerHTML = originalButtonHTML;
            button.disabled = false;
            lucide.createIcons();
        }
    }

    function generateHierarchicalCSVData(taskTree) {
        const csvData = [];
        function traverse(tasks, prefix) {
            tasks.forEach((task, index) => {
                const wbs = prefix ? `${prefix}.${index + 1}` : `${index + 1}`;
                const indentation = '  '.repeat(task.outlineLevel - 1);

                csvData.push({
                    'ID (WBS)': wbs,
                    'Nivel': task.outlineLevel,
                    'Nombre Tarea': `${indentation}${task.name}`,
                    'Es Resumen': task.isSummary ? 'S√≠' : 'No',
                    'Inicio': formatDate(task.start),
                    'Fin': formatDate(task.end),
                    'Avance (%)': task.percentComplete,
                    'Cr√≠tica': task.isCritical ? 'S√≠' : 'No'
                });

                if (task.children && task.children.length > 0) {
                    traverse(task.children, wbs);
                }
            });
        }
        traverse(taskTree, '');
        return csvData;
    }


    function exportToCSV(data, filename) {
        if (data.length === 0) {
            alert("No hay datos para exportar.");
            return;
        }
        const headers = Object.keys(data[0]).join(',');
        const rows = data.map(row => {
            return Object.values(row).map(value => {
                let valStr = String(value).replace(/"/g, '""'); // Escape double quotes
                if (valStr.includes(',')) return `"${valStr}"`;
                return valStr;
            }).join(',');
        }).join('\n');
        const csvContent = `data:text/csv;charset=utf-8,\uFEFF${headers}\n${rows}`; // \uFEFF for BOM
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function renderTrendAnalysis(currentData, previousData) {
        const trendPanel = document.getElementById('trend-analysis-container-for-export');
        const kpiList = document.getElementById('kpiDeltaList');
        const slippageList = document.getElementById('slippageList');
        const scopeList = document.getElementById('scopeChangeList');

        if (!trendPanel || !kpiList || !slippageList || !scopeList) return;

        trendPanel.classList.remove('hidden');

        const today = new Date();
        const currentFlatTasks = flattenTasks(currentData.tasks);
        const previousFlatTasks = flattenTasks(previousData.tasks);
        
        const currentExecTasks = currentFlatTasks.filter(t => !t.isSummary);
        const previousExecTasks = previousFlatTasks.filter(t => !t.isSummary);

        // --- 1. KPI Delta Calculation ---
        const currentKPIs = calculateKPIs(currentExecTasks, new Date(currentData.startDate), new Date(currentData.baselineEndDate), today);
        const previousKPIs = calculateKPIs(previousExecTasks, new Date(previousData.startDate), new Date(previousData.baselineEndDate), today);

        const currentOverdue = currentExecTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100).length;
        const previousOverdue = previousExecTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100).length;
        
        const currentCompleted = currentExecTasks.filter(t => t.percentComplete === 100).length;
        const previousCompleted = previousExecTasks.filter(t => t.percentComplete === 100).length;

        kpiList.innerHTML = '';
        
        const tooltips = {
            endDate: "<b>¬øPor qu√© cambia?</b> Se calcula en base al rendimiento general. Si se completaron menos tareas de las planificadas o hubo retrasos, la fecha proyectada se mover√° hacia el futuro.",
            spi: "<b>¬øPor qu√© cambia?</b> Compara la cantidad de tareas que deber√≠an haberse terminado a hoy (Plan) con las que realmente se terminaron (Real). Si el n√∫mero real es menor, el √≠ndice baja.",
            overdue: "<b>¬øPor qu√© cambia?</b> Aumenta si las tareas no se completan antes de su fecha de fin. Disminuye a medida que esas tareas se van completando, incluso tarde.",
            completed: "<b>¬øPor qu√© cambia?</b> Es un contador de tareas al 100%. El cambio muestra la productividad del equipo en el √∫ltimo per√≠odo."
        };

        // Projected End Date Delta
        const endDateDiff = (currentKPIs.projectedEndDate - previousKPIs.projectedEndDate) / (1000 * 60 * 60 * 24);
        kpiList.appendChild(createDeltaLi('Fin Proyectada', formatDate(currentKPIs.projectedEndDate), endDateDiff, 'd√≠as', true, tooltips.endDate));

        // SPI Delta
        const spiDiff = currentKPIs.spi - previousKPIs.spi;
        kpiList.appendChild(createDeltaLi('√çndice SPI', currentKPIs.spi.toFixed(2), spiDiff, '', false, tooltips.spi));

        // Overdue Tasks Delta
        const overdueDiff = currentOverdue - previousOverdue;
        kpiList.appendChild(createDeltaLi('Tareas Atrasadas', currentOverdue, overdueDiff, '', true, tooltips.overdue));

        // Completed Tasks Delta
        const completedDiff = currentCompleted - previousCompleted;
        kpiList.appendChild(createDeltaLi('Tareas Completadas', currentCompleted, completedDiff, '', false, tooltips.completed));


        // --- 2. Slippage Report ---
        slippageList.innerHTML = '';
        const previousTasksMap = new Map(previousFlatTasks.map(t => [t.id, t]));
        const slippedTasks = [];

        currentFlatTasks.forEach(currentTask => {
            const previousTask = previousTasksMap.get(currentTask.id);
            if (previousTask && (currentTask.isCritical || currentTask.isMilestone)) {
                const currentEndDate = new Date(currentTask.end);
                const previousEndDate = new Date(previousTask.end);
                if (currentEndDate > previousEndDate) {
                    slippedTasks.push({task: currentTask, prevEnd: previousEndDate});
                }
            }
        });

        if (slippedTasks.length > 0) {
            slippedTasks.forEach(slip => {
                const li = document.createElement('li');
                li.className = 'flex items-start text-xs';
                li.innerHTML = `
                    <i data-lucide="chevrons-right" class="w-4 h-4 text-orange-400 shrink-0 mr-2"></i>
                    <div>
                        <span class="font-semibold">${slip.task.name}</span>
                        <span class="block text-orange-400">Desv√≠o de ${formatDate(slip.prevEnd)} a ${formatDate(slip.task.end)}</span>
                    </div>`;
                slippageList.appendChild(li);
            });
        } else {
            slippageList.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="thumbs-up" class="w-4 h-4 shrink-0 mr-2"></i>Sin desv√≠os en tareas clave.</li>`;
        }


        // --- 3. Scope Changes ---
        scopeList.innerHTML = '';
        const currentTaskIds = new Set(currentFlatTasks.map(t => t.id));
        const previousTaskIds = new Set(previousFlatTasks.map(t => t.id));

        const newTasks = currentFlatTasks.filter(t => !previousTaskIds.has(t.id));
        const removedTasks = previousFlatTasks.filter(t => !currentTaskIds.has(t.id));

        scopeList.innerHTML = `
            <li class="flex items-center justify-between"><span>Tareas Nuevas:</span> <span class="font-bold text-lg text-blue-400">${newTasks.length}</span></li>
            <li class="flex items-center justify-between"><span>Tareas Eliminadas:</span> <span class="font-bold text-lg text-gray-400">${removedTasks.length}</span></li>
        `;

        lucide.createIcons();
    }

    function createDeltaLi(label, value, delta, unit = '', higherIsWorse = false, tooltipText = '') {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between cursor-pointer';
        li.dataset.tooltipText = tooltipText.replace(/"/g, '&quot;');
        
        let deltaText = '';
        let colorClass = 'text-gray-400';
        
        if (delta !== 0) {
            const sign = delta > 0 ? '+' : '';
            colorClass = (delta > 0) ? (higherIsWorse ? 'text-red-400' : 'text-green-400') : (higherIsWorse ? 'text-green-400' : 'text-red-400');
            deltaText = `(${sign}${delta.toFixed(2).replace(/\.00$/, '')} ${unit})`;
        }

        li.innerHTML = `
            <span>${label}:</span>
            <span class="font-bold text-lg">${value} <span class="text-xs ${colorClass}">${deltaText}</span></span>
        `;
        return li;
    }
    
    // Inicializar iconos
    lucide.createIcons();

    </script>
</body>
</html>

