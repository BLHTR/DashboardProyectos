<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlatoRH - Project Analysis Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Exo:wght@400;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script src="https://unpkg.com/lucide@0.372.0/dist/umd/lucide.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

    <style>
        /* Aplicando la paleta de colores y tipograf√≠as de BlatoRH */
        :root {
            --bl-azul-oscuro: #0D2240;
            --bl-dorado: #B1A96E;
            --bl-azul-principal: #1A77D2;
            --bl-blanco: #FFFFFF;
            --bl-gris-claro: #f3f4f6;
            --bl-gris-oscuro: #1f2937;
        }

        /* --- TEMA 2: Oce√°nico --- */
        .theme-oceanic {
            --bl-azul-oscuro: #021024;
            --bl-dorado: #05C7F2;
            --bl-azul-principal: #0597F2;
        }

        /* --- TEMA 3: Contraste --- */
        .theme-contrast {
            --bl-azul-oscuro: #000000;
            --bl-dorado: #F2D157; /* Corregido de F2W157 */
            --bl-azul-principal: #FFFFFF;
        }


        body {
            font-family: 'Exo', sans-serif;
            background-color: var(--bl-azul-oscuro);
            color: var(--bl-blanco);
            transition: background-color 0.5s ease;
        }

        h1, h2, h3, h4, .font-display {
            font-family: 'Bebas Neue', sans-serif;
        }

        .brand-logo {
            color: var(--bl-blanco);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-logo span {
            color: var(--bl-dorado);
            transition: color 0.5s ease;
        }
        .brand-subtitle {
            font-family: 'Exo', sans-serif;
            font-size: 0.8rem;
            letter-spacing: 2px;
            color: var(--bl-gris-claro);
            opacity: 0.8;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Estilos para el fondo de part√≠culas */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* Animaci√≥n de entrada para la secci√≥n de carga */
        #uploadSection {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        #uploadSection.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para la nueva zona de carga inteligente */
        #smart-dropzone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        #smart-dropzone.dragover {
            border-color: var(--bl-dorado);
            background-color: rgba(177, 169, 110, 0.1);
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(177, 169, 110, 0.3);
        }

        /* Estilos para el panel de personalizaci√≥n */
        #branding-panel {
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            width: 320px;
            background-color: var(--bl-azul-oscuro);
            border-left: 1px solid var(--bl-dorado);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: -10px 0 30px rgba(0,0,0,0.3);
        }
        
        /* Panel de notas Modo Presentador */
        #presenter-panel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 320px;
            background-color: var(--bl-azul-oscuro);
            border-right: 1px solid var(--bl-dorado);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 10px 0 30px rgba(0,0,0,0.3);
        }
        #presenter-panel.is-open {
            transform: translateX(0);
        }

        #branding-panel.is-open {
            transform: translateX(0);
        }

        /* --- RESTO DE ESTILOS ORIGINALES (SIN CAMBIOS) --- */
        .timeline-item::before { content: ''; position: absolute; left: 11px; top: 28px; bottom: 0; width: 2px; background-color: var(--bl-dorado); opacity: 0.5; }
        .timeline-item:last-child::before { display: none; }
        .timeline-dot { position: absolute; left: 0; top: 28px; height: 24px; width: 24px; border-radius: 50%; background-color: var(--bl-azul-oscuro); border: 3px solid var(--bl-dorado); z-index: 10; }
        .timeline-dot.completed { background-color: var(--bl-dorado); border-color: var(--bl-dorado); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bl-azul-oscuro); }
        ::-webkit-scrollbar-thumb { background: var(--bl-dorado); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #c9bf86; }
        .export-btn, .action-btn { background-color: rgba(177, 169, 110, 0.1); border: 1px solid var(--bl-dorado); color: var(--bl-dorado); padding: 2px 6px; border-radius: 6px; font-size: 10px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; }
        .export-btn:hover, .action-btn:hover { background-color: var(--bl-dorado); color: var(--bl-azul-oscuro); }
        .gantt-view-btn { transition: all 0.2s; }
        .gantt-view-btn.active { background-color: var(--bl-dorado); color: var(--bl-azul-oscuro); font-weight: bold; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.7; cursor: pointer; }
        #gantt-task-list, #gantt-timeline-wrapper { max-height: 72vh; overflow-y: auto; }
        #gantt-legend .legend-item{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
        #gantt-legend .swatch{ width:14px; height:14px; border-radius:3px; display:inline-block; }
        #gantt-legend .hatched{ background: repeating-linear-gradient(135deg, rgba(177,169,110,0.35), rgba(177,169,110,0.35) 6px, rgba(255,255,255,0.1) 6px, rgba(255,255,255,0.1) 12px); border:1px solid rgba(177,169,110,0.6); }
        .gantt-progress-summary{ height:8px!important; top:5px!important; border-radius:4px!important; opacity:0.95; }
        .gantt-percent-badge{ position:absolute; top:50%; transform: translateY(-50%); padding: 2px 6px; font-size: 11px; line-height: 1; border-radius: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.25); color: #fff; pointer-events: none; white-space: nowrap; }
        #gantt-timeline-wrapper { overflow: auto; }
        #gantt-timeline { position: relative; overflow: hidden; }
        .gantt-bar { position: absolute; height: 18px; border-radius: 6px; }
        .gantt-bar .gantt-bar-label { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 10px; color: white; opacity: .9; }
        .gantt-track { position:absolute; left:0; top:0; height:100%; width:100%; border-radius:6px; background-color: rgba(255, 255, 255, 0.15); }
        .gantt-track-summary { background: repeating-linear-gradient(135deg, rgba(177,169,110,0.20), rgba(177,169,110,0.20) 6px, rgba(255,255,255,0.06) 6px, rgba(255,255,255,0.06) 12px); border: 1px solid rgba(177,169,110,0.35); }
        .gantt-progress { position:absolute; left:0; top:0; height:100%; border-radius:6px; }
        .gantt-progress-marker { position:absolute; top:-2px; bottom:-2px; width:2px; background: white; opacity:.9; border-radius:1px; box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset; }
        .gantt-grid { display: grid; grid-template-columns: minmax(300px, 25%) 1fr; grid-template-rows: 64px auto; }
        .gantt-row { height: 32px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); box-sizing: border-box; }
        .gantt-task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-task-name.summary-task { font-weight: 500; }
        .toggle-btn { cursor: pointer; width: 16px; height: 16px; transition: transform 0.2s; }
        .toggle-btn.collapsed { transform: rotate(-90deg); }
        .gantt-bar { position: absolute; height: 20px; top: 6px; border-radius: 4px; cursor: pointer; transition: filter 0.2s; }
        .gantt-bar:hover { filter: brightness(1.2); }
        .gantt-milestone { position: absolute; top: 8px; width: 16px; height: 16px; background-color: var(--bl-dorado); transform: rotate(45deg); cursor: pointer; }
        .gantt-bar-label { position: absolute; left: 5px; top: 0; height: 100%; display: flex; align-items: center; color: white; font-size: 10px; white-space: nowrap; text-shadow: 0 0 2px rgba(0,0,0,0.7); pointer-events: none; }
        #gantt-tooltip { position: fixed; display: none; background-color: var(--bl-gris-oscuro); color: var(--bl-blanco); border: 1px solid var(--bl-dorado); border-radius: 6px; padding: 8px; font-size: 12px; z-index: 100; pointer-events: none; max-width: 300px; }
        .gantt-timeline-header { background-color: var(--bl-azul-oscuro); }

        /* Estilos para el indicador de carga IA */
        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: #fff; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 #fff, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 #fff, .5em 0 0 #fff; }
        }

    </style>

<style id="blatorh-patch">
/* Logo: lock box size to default and keep uploaded image contained */
#custom-logo, #blatorh-logo-center{
  display:block;
  width: var(--logo-w, 40px); /* Ajustado para el nuevo header */
  height: var(--logo-h, 40px); /* Ajustado para el nuevo header */
  object-fit: contain;
  object-position: left center;
}
.brand-actions .btn{ padding:.5rem .75rem; border-radius:.5rem; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#fff; }
.brand-actions .btn:hover{ background:rgba(255,255,255,.18); }
/* Steps state helpers */
.card-done{ box-shadow: 0 0 0 2px #22c55e inset!important; }      /* green */
.card-skip{ box-shadow: 0 0 0 2px #ef4444 inset!important; }      /* red */
.dropzone{ border:2px dashed rgba(242,209,87,.7); border-radius:1rem; padding:1.25rem; }
.dropzone--muted{ border-color: rgba(255,255,255,.22); }
/* Ensure legacy hero is hidden (JS also reinforces) */
[data-legacy-hero], .legacy-upload-hero{ display:none !important; }

/* Estilo para input de API Key */
#gemini-api-key-input {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--bl-blanco);
    padding: 8px 12px;
    border-radius: 6px;
    width: 100%;
}
/* Estilo para el contenedor de KPI clickeable (Asistente IA) */
.kpi-interpretable:hover {
    cursor: pointer;
    box-shadow: 0 0 10px rgba(177, 169, 110, 0.5);
    transform: translateY(-2px);
}
/* Soporte para visualizaci√≥n de rutas en tarjetas y listados */
.gantt-task-name.summary-task {
    color: var(--bl-dorado);
    font-weight: 600;}
/* Estilo para el texto de ruta en tarjetas */
#ragStatusContainer [data-tooltip-text] {
    max-width: 200px;}
/* Asegurar que el modal muestre bien la tabla con rutas */
#modal-content table {
    border-collapse: separate;
    border-spacing: 0;}
#modal-content td {
    vertical-align: top;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;}

/* Logos aumentados 65% */
#custom-logo, #blatorh-logo-center {
  max-width: 160px !important;  /* 65% m√°s grande */
  max-height: 80px !important;  /* 65% m√°s grande */
  width: auto !important;
  height: auto !important;
  object-fit: contain;
}

/* Header en grid de 3 columnas */
header .container {
  display: grid !important;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 2rem;
}

header .container > div:first-child { justify-self: start; }
header .container > div:nth-child(2) { justify-self: center; }
header .container > div:last-child { justify-self: end; text-align: right; }



/* Animaci√≥n para tareas atrasadas (Real vs Plan) */
.gantt-bar.delayed-task {
    animation: pulse-delay 1.5s infinite;
    border: 2px solid #dc2626 !important;
}

@keyframes pulse-delay {
    0%, 100% { filter: brightness(1) drop-shadow(0 0 5px #dc2626); }
    50% { filter: brightness(1.5) drop-shadow(0 0 15px #dc2626); }
}

/* Bot√≥n de reporte estilo profesional */
#download-report-btn {
    box-shadow: 0 4px 15px rgba(177, 169, 110, 0.3);
    transition: all 0.3s ease;
}

#download-report-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(177, 169, 110, 0.4);
}

/* Tooltips funcionales en HTML exportado */
.static-tooltip.hidden { 
    display: none !important; 
}
[data-tooltip-text] { 
    position: relative; 
    cursor: help; 
}
</style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="particles-js"></div>

    <header class="p-6 border-b border-white/10 sticky top-0 bg-[--bl-azul-oscuro]/80 backdrop-blur-md z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4 min-w-0">
                <img id="custom-logo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTI0IDRDMTIuOTYgNCA0IDEyLjk2IDQgMjRDNCAzNS4wNCAxMi45NiA0NCAyNCA0NFY0WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTI0IDRDNTIgNCAzNS4wNCA0IDI0IDQ0QzEyLjk2IDQ0IDQgMzUuMDQgNCAyNFY0SDI0WiIgZmlsbD0iI0IxQTk2RSIvPgo8L3N2Zz4K" alt="Logo Cliente" class="h-10 w-10 object-contain">
            </div>

            <div class="flex items-center justify-center min-w-0">
                <img id="blatorh-logo-center" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTI0IDRDMTIuOTYgNCA0IDEyLjk2IDQgMjRDNCAzNS4wNCAxMi45NiA0NCAyNCA0NFY0WiIgZmlsbD0id2hpdGUiLz4KPHBhdGsgZD0iTTI0IDRDNTIgNCAzNS4wNCA0IDI0IDQ0QzEyLjk2IDQ0IDQgMzUuMDQgNCAyNFY0SDI0WiIgZmlsbD0iI0IxQTk2RSIvPgo8L3N2Zz4K" alt="Logo BlatoRH" class="h-10 w-10 object-contain">
            </div>

            <div class="flex items-center gap-6 min-w-0">
                <div class="text-right">
                    <h2 class="font-display text-2xl md:text-3xl tracking-wide text-white/90">
                        Project Analysis Dashboard
                    </h2>
                    <p id="report-date" class="text-xs text-white/60 h-4"></p>
                </div>
                <button id="export-snapshot-btn" class="text-white/80 hover:text-[--bl-dorado] transition-colors no-export hidden" title="Exportar estado actual del tablero como JSON">
                    <i data-lucide="download" class="w-6 h-6"></i>
                </button>
                <button id="branding-toggle-btn" class="text-white/80 hover:text-[--bl-dorado] transition-colors no-export" title="Personalizar Branding y Configuraci√≥n IA">
                    <i data-lucide="settings-2" class="w-6 h-6"></i>
                </button>
                <div class="relative inline-block no-export">
                    <button id="lang-toggle-btn" class="text-white/80 hover:text-[--bl-dorado] transition-colors" title="Idioma">
                        <i data-lucide="globe-2" class="w-6 h-6"></i>
                    </button>
                    <div id="lang-menu" class="absolute right-0 mt-2 bg-white text-black text-xs rounded shadow-lg py-1 w-40 hidden no-export">
                        <button type="button" data-lang="es" class="w-full text-left px-3 py-1 hover:bg-gray-100">es (Espa√±ol)</button>
                        <button type="button" data-lang="en" class="w-full text-left px-3 py-1 hover:bg-gray-100">en (English)</button>
                        <button type="button" data-lang="pt" class="w-full text-left px-3 py-1 hover:bg-gray-100">pt (Portugu√™s)</button>
                    </div>
                </div>
<button id="presenter-mode-toggle" class="text-white/80 hover:text-[--bl-dorado] transition-colors no-export" title="Modo Presentador">
                    <i data-lucide="keyboard" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>
    <section id="stepsInlinePro" class="relative z-[10] mx-auto max-w-6xl px-4 pt-8 pb-6">
  <header class="mb-8">
    <h2 class="text-3xl font-extrabold tracking-tight text-white">Cargar datos del proyecto</h2>
    <p class="text-white/80 text-base mt-1">
      1) XML <strong>actual</strong> (obligatorio) ‚Äî base de KPIs y Gantt ¬∑
      2) XML <strong>anterior</strong> (opcional) ‚Äî comparativas y tendencias ¬∑
      3) <strong>Generar</strong> el dashboard.
    </p>
  </header>
  <ol class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <li id="inStep1" class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 ring-0 transition-all min-h-[300px]">
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" class="text-[color:var(--bl-dorado,var(--brand-accent,#F2D157))]" stroke-width="1.5"/><path d="M14 2v6h6" stroke="currentColor" stroke-width="1.5"/></svg>
          <div>
            <div class="text-xl font-semibold text-white">1. Archivo Actual</div>
            <div class="text-xs text-white/70 -mt-0.5">Obligatorio ¬∑ base de KPIs y Gantt</div>
          </div>
        </div>
        <span id="inS1State" class="text-[11px] rounded px-2 py-0.5 bg-white/10 text-white/70">en curso</span>
      </div>
      <div id="drop1" class="dropzone mt-5 text-white/85 text-sm text-center select-none">
        Arrastr√° el XML actual aqu√≠ o <button id="inS1Select" class="underline font-semibold">seleccion√° un archivo</button>.
      </div>
      <div id="inS1File" class="mt-3 text-xs text-white/70 line-clamp-2">Ning√∫n archivo seleccionado.</div>
    </li>

    <li id="inStep2" class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 transition-all min-h-[300px] opacity-60">
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M4 7a2 2 0 012-2h7l5 5v7a2 2 0 01-2 2H6a2 2 0 01-2-2V7z" stroke="currentColor" class="text-white/70" stroke-width="1.5"/></svg>
          <div>
            <div class="text-xl font-semibold text-white">2. Archivo Anterior</div>
            <div class="text-xs text-white/70 -mt-0.5">Opcional ¬∑ mejora comparativas y tendencias</div>
          </div>
        </div>
        <span id="inS2State" class="text-[11px] rounded px-2 py-0.5 bg-white/10 text-white/70">opcional</span>
      </div>
      <div id="drop2" class="dropzone dropzone--muted mt-5 text-white/85 text-sm text-center select-none">
        Arrastr√° el XML anterior aqu√≠ o <button id="inS2Select" class="underline font-semibold">sub√≠ un archivo</button>.
      </div>
      <div class="mt-3 flex gap-2">
        <button id="inS2Skip" class="flex-1 px-3 py-2 rounded-md border border-white/15 text-white/85 text-xs hover:bg-white/10">
          Saltar paso 2
        </button>
      </div>
      <div id="inS2File" class="mt-3 text-xs text-white/70 line-clamp-2">No cargado.</div>
    </li>

    <li id="inStep3" class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 transition-all min-h-[300px] opacity-60">
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M20 7l-9 9-5-5" stroke="currentColor" class="text-white/70" stroke-width="1.8"/></svg>
          <div>
            <div class="text-xl font-semibold text-white">3. Generar Dashboard</div>
            <div class="text-xs text-white/70 -mt-0.5">Se desbloquea con el paso 1</div>
          </div>
        </div>
        <span id="inS3State" class="text-[11px] rounded px-2 py-0.5 bg-white/10 text-white/70">bloqueado</span>
      </div>
      <button id="inGenerate" class="mt-6 w-full px-4 py-3 rounded-md text-base font-semibold
                     bg-[color:var(--bl-dorado,var(--brand-accent,#F2D157))]
                     text-[color:var(--bl-azul-oscuro,#0A2342)]
                     disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        Generar dashboard
      </button>
      <p class="mt-2 text-[11px] text-white/55">Al generar, esta secci√≥n se ocultar√° y ver√°s el dashboard.</p>
    </li>
  </ol>
  <div class="mt-8 text-center" id="snapshot-section">
      <p class="text-sm text-white/70 mb-3">¬øTienes una instant√°nea?</p>
      <div class="flex items-center justify-center gap-4">
          <input type="file" id="snapshot-import-input" class="hidden" accept=".json">
          <button id="import-snapshot-btn" class="action-btn text-base py-2 px-4" title="Importar un panel guardado previamente">
              <i data-lucide="upload" class="w-4 h-4"></i>
              <span>Importar Instant√°nea</span>
          </button>
      </div>
  </div>
</section>


    <main class="flex-grow container mx-auto p-4 md:p-6 flex items-center justify-center">

        <section id="uploadSection" class="w-full transition-opacity duration-500">
            <div id="smart-dropzone" class="max-w-4xl mx-auto rounded-xl p-8 md:p-12">

                <div id="upload-step-1" class="text-center">
                     <i data-lucide="file-check-2" class="w-16 h-16 text-white/70 mb-4 mx-auto"></i>
                    <h3 class="font-display text-3xl text-white" data-i18n-key="upload_step_1_title"></h3>
                    <p class="text-white/60 mt-2 mb-6" data-i18n-key="upload_step_1_subtitle"></p>
                    <input type="file" id="currentFile" class="hidden" accept=".xml">
                    <label for="currentFile" class="bg-[--bl-dorado] text-[--bl-azul-oscuro] font-bold font-display text-lg px-8 py-2 rounded-lg hover:bg-yellow-300 transition-all cursor-pointer" data-i18n-key="upload_step_1_button"></label>
                </div>

                <div id="upload-step-2" class="hidden text-center">
                    <div class="mb-8 p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                        <p class="font-semibold text-green-300" data-i18n-key="upload_step_2_banner_title"></p>
                        <p id="currentFileName" class="text-sm text-white"></p>
                    </div>
                    <i data-lucide="file-clock" class="w-16 h-16 text-white/70 mb-4 mx-auto"></i>
                    <h3 class="font-display text-3xl text-white" data-i18n-key="upload_step_2_title"></h3>
                    <p class="text-white/60 mt-2 mb-6" data-i18n-key="upload_step_2_subtitle"></p>
                     <input type="file" id="previousFile" class="hidden" accept=".xml">
                    <label for="previousFile" class="bg-white/10 border border-white/20 text-white font-bold font-display text-lg px-8 py-2 rounded-lg hover:bg-white/20 transition-all cursor-pointer" data-i18n-key="upload_step_2_button"></label>
                </div>
                 <p id="previousFileName" class="text-xs text-center text-[--bl-dorado] mt-4 h-4"></p>

            </div>
             <div class="text-center mt-8">
                <button id="generate-report-btn" class="bg-[--bl-dorado] text-[--bl-azul-oscuro] font-bold font-display text-xl px-12 py-3 rounded-lg hover:bg-yellow-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled data-i18n-key="upload_generate_button"></button>
             </div>
        </section>

        <section id="dashboardSection" class="hidden opacity-0 transition-opacity duration-1000 w-full">
            <div class="mb-6 p-4 rounded-lg">
                <h2 class="font-display text-4xl" id="projectName"></h2>
                <p class="text-white/70" id="projectManager"></p>
                <!-- Bot√≥n DESCARGAR CUADROS CONTROL (integrado bajo Project Manager, no se exporta) -->
                <div class="mt-3 flex justify-start no-export">
                    <button id="download-html-report-btn" class="bg-[--bl-dorado] text-[--bl-azul-oscuro] font-bold px-4 py-2 rounded-lg hover:opacity-90 transition-colors flex items-center gap-2 shadow-lg text-sm">
                        <i data-lucide="download-cloud" class="w-4 h-4"></i>
                        Descargar Cuadros Control
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                <div id="trend-analysis-container-for-export" class="hidden card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">An√°lisis de Tendencias (Semana Actual vs. Anterior)</h3>
                        <button class="action-btn no-export" id="exportTrendJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="kpi-delta-section">
                             <h4 class="font-display text-xl text-[--bl-dorado] mb-1 cursor-pointer" data-tooltip-text="Salud general del proyecto y su evoluci√≥n semanal.">KPIs Principales</h4>
                             <p class="text-xs text-white/60 -mt-1 mb-2 italic">Un resumen del cambio en la salud del proyecto.</p>
                            <ul class="space-y-2 text-sm" id="kpiDeltaList"></ul>
                        </div>
                        <div id="slippage-section">
                            <h4 class="font-display text-xl text-[--bl-dorado] mb-1 cursor-pointer" data-tooltip-text="Diagn√≥stico de las tareas clave que causaron retrasos en la √∫ltima semana.">An√°lisis de Desv√≠os</h4>
                            <p class="text-xs text-white/60 -mt-1 mb-2 italic">Tareas clave que se han retrasado recientemente.</p>
                            <ul class="space-y-2 text-sm" id="slippageList"></ul>
                        </div>
                        <div id="scope-change-section">
                           <h4 class="font-display text-xl text-[--bl-dorado] mb-1 cursor-pointer" data-tooltip-text="Control sobre el trabajo a√±adido o eliminado del plan.">Cambios en Alcance</h4>
                           <p class="text-xs text-white/60 -mt-1 mb-2 italic">Detecci√≥n de "scope creep" o cambios en el plan.</p>
                            <ul class="space-y-2 text-sm" id="scopeChangeList"></ul>
                        </div>
                    </div>
                </div>

                <div id="summary-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-display text-2xl text-white">Resumen Ejecutivo para Cliente</h3>
                        <div class="flex items-center gap-2 no-export">
                            <button class="action-btn" id="generate-summary-btn"><i data-lucide="brain-circuit"></i>Generar Resumen IA</button>
                            <button class="action-btn" id="exportSummaryJPG" style="display:none;"><i data-lucide="image"></i>JPG</button>
                        </div>
                    </div>
                    <div id="executive-alerts" class="flex flex-wrap gap-2 mb-4"></div>
                    <div id="executive-summary-content" class="text-white/80 text-base leading-relaxed">
                        <p class="italic text-white/50">Haga clic en "Generar Resumen IA" para redactar un an√°lisis basado en los datos del dashboard actual.</p>
                    </div>
                </div>

                <div class="col-span-1 md:col-span-2 lg:col-span-4 grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">Fecha de Inicio</h4>
                        <p class="font-display text-3xl text-white" id="startDate"></p>
                    </div>
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">Fin L√≠nea Base</h4>
                        <p class="font-display text-3xl text-white" id="baselineEndDate"></p>
                    </div>
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">Fin Proyectada</h4>
                        <p class="font-display text-3xl text-white" id="projectedEndDate"></p>
                    </div>
                    <div class="card p-4 rounded-lg text-center">
                        <h4 class="font-display text-lg text-white/60">D√≠as Restantes</h4>
                        <p class="font-display text-3xl text-white" id="daysRemaining"></p>
                    </div>
                </div>

                <div class="card p-4 rounded-lg" id="progressChart"><div id="progressChart"></div></div>
                <div class="card p-4 rounded-lg" id="timeChart"><div id="timeChart"></div></div>

                <div id="rag-kpi-card" class="card p-4 rounded-lg md:col-span-2 lg:col-span-2 transition-shadow duration-300 kpi-interpretable" title="Doble clic para explicaci√≥n con IA">
                    <h3 class="font-display text-2xl mb-4 text-white text-center cursor-pointer" id="rag-title" data-tooltip-text="RAG (Red, Amber, Green) es un sistema de sem√°foro para mostrar la salud del proyecto. <br><b>Verde:</b> En buen camino. <br><b>√Åmbar:</b> Precauci√≥n. <br><b>Rojo:</b> Riesgo alto.">Estado General (RAG)</h3>
                    <div class="flex justify-around items-center h-full" id="ragStatusContainer">
                        </div>
                </div>

                <div class="col-span-1 md:col-span-2 lg:col-span-4 grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="card p-4 rounded-lg text-center" id="completedTasksCard"></div>
                    <div class="card p-4 rounded-lg text-center cursor-pointer hover:bg-white/10 transition-colors" id="inProgressTasksCard"></div>
                    <div class="card p-4 rounded-lg text-center cursor-pointer hover:bg-white/10 transition-colors" id="notStartedTasksCard"></div>
                    <div class="card p-4 rounded-lg text-center cursor-pointer hover:bg-white/10 transition-colors" id="overdueTasksCard"></div>
                </div>

                <div id="gantt-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="font-display text-2xl text-white">Diagrama de Gantt</h3>
                        <div class="flex items-center gap-4 text-sm flex-wrap no-export">
                             <div id="gantt-main-view-toggle" class="flex rounded-md bg-black/20 p-0.5">
                                <button data-view="gantt" class="gantt-view-btn active px-2 py-0.5 rounded-md text-xs">Gantt</button>
                                <button data-view="network" class="gantt-view-btn px-2 py-0.5 rounded-md text-xs">Diagrama de Red</button>
                            </div>
                            <div id="gantt-controls" class="flex items-center gap-4 text-sm flex-wrap">
                                <div class="flex items-center gap-2">
                                    <label for="ganttStartDate" class="text-white/70">Desde:</label>
                                    <input type="date" id="ganttStartDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="ganttEndDate" class="text-white/70">Hasta:</label>
                                    <input type="date" id="ganttEndDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                                </div>
                                <div id="gantt-timescale-toggle" class="flex rounded-md bg-black/20 p-0.5">
                                    <button data-view="day" class="gantt-view-btn active px-2 py-0.5 rounded-md text-xs">D√≠a</button>
                                    <button data-view="week" class="gantt-view-btn px-2 py-0.5 rounded-md text-xs">Semana</button>
                                </div>
                                <button class="action-btn" id="regenerateGantt"><i data-lucide="refresh-cw" class="w-3 h-3"></i>Regenerar</button>
                            </div>
                        </div>
                        <div class="flex gap-2 no-export">
                             <button class="action-btn" id="expandAll"><i data-lucide="unfold-vertical"></i>Expandir</button>
                             <button class="action-btn" id="collapseAll"><i data-lucide="fold-vertical"></i>Colapsar</button>
                             <button class="action-btn" id="exportGanttJPG"><i data-lucide="image"></i>JPG</button>
                             <button class="export-btn" id="exportAllTasks"><i data-lucide="file-down"></i>CSV</button>
                        </div>
                    </div>
                     <div id="gantt-advanced-filters" class="flex flex-wrap items-center gap-4 mb-4 pb-4 border-b border-white/10 no-export">
                        <div class="relative">
                            <input type="text" id="gantt-search" placeholder="Buscar tarea por nombre..." class="bg-black/20 rounded-md py-1 pl-8 pr-2 border-white/20 text-white text-sm w-48">
                            <i data-lucide="search" class="absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50"></i>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="gantt-resource-filter" class="text-sm text-white/70">Recurso:</label>
                            <select id="gantt-resource-filter" class="bg-black/20 rounded-md py-1 px-2 border-white/20 text-white text-sm">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                        <div id="gantt-isolation-filter" class="flex rounded-md bg-black/20 p-0.5 text-xs">
                            <button data-filter="all" class="gantt-view-btn active px-2 py-0.5 rounded-md">Ver Todo</button>
                            <button data-filter="critical" class="gantt-view-btn px-2 py-0.5 rounded-md">Solo Cr√≠ticas</button>
                            <button data-filter="milestones" class="gantt-view-btn px-2 py-0.5 rounded-md">Solo Hitos</button>
                            <button data-filter="delayed" class="gantt-view-btn px-2 py-0.5 rounded-md">Solo Retrasadas</button>
                        </div>
                        </div>
                    <div id="gantt-chart-wrapper" class="relative">
                        <div id="gantt-legend-anchor" class="relative"></div>
                          <button id="legend-toggle" class="no-export absolute -top-10 right-2 z-20 rounded-full border border-white/20 bg-[rgba(10,22,40,0.9)] text-white/90 w-9 h-9 flex items-center justify-center shadow hover:scale-105 transition" aria-label="Mostrar/Ocultar leyenda" title="Leyenda">i</button>
                          <aside id="gantt-legend" data-html2canvas-ignore="true" class="no-export absolute top-2 right-2 bg-[rgba(10,22,40,0.92)] backdrop-blur-sm border border-white/10 rounded-xl shadow-lg p-3 z-20 text-sm text-white/80 hidden">
                            <div class="font-semibold text-white/90 mb-2">Leyenda</div>
                            <div class="legend-item"><span class="swatch hatched"></span><span>Tarea resumen</span></div>
                            <div class="legend-item"><span class="swatch" style="background:#ef4444"></span><span>0‚Äì24% completado</span></div>
                            <div class="legend-item"><span class="swatch" style="background:#f59e0b"></span><span>25‚Äì49% completado</span></div>
                            <div class="legend-item"><span class="swatch" style="background:#3b82f6"></span><span>50‚Äì74% completado</span></div>
                            <div class="legend-item"><span class="swatch" style="background:#22c55e"></span><span>75‚Äì100% completado</span></div>
                          </aside>
                        </div>
                        <div id="gantt-chart-container" class="w-full h-[600px] border border-white/10 rounded-md gantt-grid"></div>
                        <div id="network-diagram-container" class="hidden w-full h-[600px] border border-white/10 rounded-md overflow-auto"></div>
                    </div>
                </div>
                 <div id="burnup-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="font-display text-2xl text-white">Gr√°fico de Avance (Curva S)</h3>
                        <div class="flex items-center gap-4 text-sm flex-wrap no-export">
                            <div id="burnup-view-toggle" class="flex rounded-md bg-black/20 p-0.5">
                                <button data-view="day" class="gantt-view-btn px-2 py-0.5 rounded-md text-xs">D√≠a</button>
                                <button data-view="week" class="gantt-view-btn active px-2 py-0.5 rounded-md text-xs">Semana</button>
                            </div>
                        </div>
                        <div class="flex gap-2 no-export">
                            <button class="action-btn" id="exportBurnupJPG"><i data-lucide="image"></i>JPG</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 text-sm flex-wrap mb-4 no-export">
                        <div class="flex items-center gap-2">
                            <label for="burnupStartDate" class="text-white/70">Desde:</label>
                            <input type="date" id="burnupStartDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="burnupEndDate" class="text-white/70">Hasta:</label>
                            <input type="date" id="burnupEndDate" class="bg-black/20 rounded-md p-1 border-white/20 text-white">
                        </div>
                        <button class="action-btn" id="regenerateBurnup"><i data-lucide="refresh-cw" class="w-3 h-3"></i>Regenerar</button>
                    </div>
                    <div id="burnupChart"></div>
                </div>
                <div id="resources-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">An√°lisis de Carga de Recursos</h3>
                        <button class="action-btn no-export" id="exportResourcesJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div id="resourceLoadChart"></div>
                </div>

                <div id="spi-kpi-card" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-2 transition-shadow duration-300 kpi-interpretable" title="Doble clic para explicaci√≥n con IA">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="<b>¬øQu√© es el SPI?</b><br>El √çndice de Rendimiento del Cronograma (SPI) mide la eficiencia del tiempo del proyecto. Compara el trabajo que se ha completado contra el que deber√≠a haberse completado hasta hoy.<br><br><b>Interpretaci√≥n de Colores:</b><br>üü¢ <b>Verde (SPI >= 0.98):</b> ¬°Excelente! El ritmo de trabajo es igual o mayor al planificado.<br>üü° <b>√Åmbar (0.90 a 0.97):</b> Precauci√≥n. El ritmo es ligeramente m√°s lento de lo esperado.<br>üî¥ <b>Rojo (SPI < 0.90):</b> Riesgo Alto. El ritmo de trabajo es significativamente menor al planificado.">√çndice de Rendimiento (SPI)</h3>
                        <button class="action-btn no-export" id="exportSPIJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div id="spiValueContainer" class="flex items-center justify-center h-full"></div>
                </div>

                <div id="predictive-risks-container" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-display text-2xl text-white flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-400"></i>
                            Diagn√≥stico Predictivo de Riesgos (IA)
                        </h3>
                        <div class="flex items-center gap-2 no-export">
                            <button class="action-btn" id="analyze-risks-btn"><i data-lucide="shield-half"></i>Analizar Riesgos con IA</button>
                            <button class="action-btn" id="exportRisksPredictiveJPG" style="display:none;"><i data-lucide="image"></i>JPG</button>
                        </div>
                    </div>
                    <div id="predictive-risks-content" class="text-white/80 text-base leading-relaxed space-y-4">
                        <p class="italic text-white/50">Haga clic en "Analizar Riesgos con IA" para obtener una predicci√≥n de los 3-5 riesgos m√°s probables de impactar el cronograma en las pr√≥ximas dos semanas.</p>
                    </div>
                </div>

                <div id="foco-critico-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="Muestra tareas que, si no se gestionan, tienen el mayor potencial de impactar negativamente el cronograma. Se basa en criticidad, urgencia y estado de avance.">Tareas de Foco Cr√≠tico</h3>
                        <button class="action-btn no-export" id="exportFocoCriticoJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="focoCriticoList"></ul>
                </div>
                <div id="upcoming-tasks-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="Muestra tareas clave que est√°n programadas para comenzar pronto.">Pr√≥ximas Tareas Clave</h3>
                        <div class="flex items-center gap-2 text-xs no-export">
                            <label for="upcoming-days">Ver en los pr√≥ximos</label>
                            <input type="number" id="upcoming-days" value="7" class="bg-black/20 w-12 text-center rounded-md p-0.5 border-white/20 text-white">
                            <span>d√≠as</span>
                        </div>
                        <button class="action-btn no-export" id="exportUpcomingJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div class="flex justify-center mb-3 no-export" id="upcoming-task-filter">
                        <div class="flex rounded-md bg-black/20 p-0.5 text-xs">
                            <button data-filter="all" class="gantt-view-btn active px-2 py-0.5 rounded-md">Todas</button>
                            <button data-filter="critical" class="gantt-view-btn px-2 py-0.5 rounded-md">Cr√≠ticas</button>
                            <button data-filter="milestones" class="gantt-view-btn px-2 py-0.5 rounded-md">Hitos</button>
                        </div>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="upcomingTaskList"></ul>
                </div>
                <div id="milestones-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">Hitos Principales</h3>
                        <button class="action-btn no-export" id="exportMilestonesJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <div class="relative pl-6 max-h-96 overflow-y-auto" id="milestoneTimeline"></div>
                </div>
                <div id="criticalpath-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white">Ruta Cr√≠tica</h3>
                        <button class="action-btn no-export" id="exportCriticalPathJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="criticalPathList"></ul>
                </div>
                <!-- NUEVO: Kanban de Issues -->
<div id="issues-kanban-container-for-export" class="card p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-4 bg-[--bl-azul-oscuro]">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
        <div>
            <h3 class="font-display text-2xl text-white">Kanban de Issues</h3>
            <p class="text-xs text-white/60 -mt-1 italic">
                Issues por estado, vinculados a su tarea y tarea padre. Notas r√°pidas guardadas en tu navegador.
            </p>
        </div>
        <div class="flex items-center gap-2 no-export">
            <button class="action-btn" id="exportIssuesKanbanJPG">
                <i data-lucide="image" class="w-4 h-4"></i>JPG
            </button>
        </div>
    </div>

    <div id="issues-kanban-board" class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
        <!-- Columnas construidas por JS -->
    </div>

    <!-- Sticky Note para comentarios de Issue -->
    <div id="issue-sticky-note" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden no-export">
        <div class="bg-[#fef3c7] text-[#1f2937] rounded-xl shadow-2xl w-full max-w-md border border-[#fbbf24]">
            <div class="px-4 py-2 flex justify-between items-center border-b border-[#fbbf24]/70">
                <div class="min-w-0">
                    <p id="sticky-issue-task" class="font-semibold text-sm leading-tight truncate"></p>
                    <p id="sticky-issue-parent" class="text-xs text-[#4b5563] truncate"></p>
                </div>
                <button id="sticky-close-btn" class="text-xs font-bold px-2 py-1 rounded hover:bg-black/5">
                    &times;
                </button>
            </div>
            <div class="px-4 py-3">
                <p class="text-xs font-semibold mb-1">Issue</p>
                <p id="sticky-issue-text" class="text-xs mb-3 max-h-24 overflow-y-auto leading-snug"></p>

                <label class="text-xs font-semibold mb-1 block">Sticky Notes</label>
                <textarea id="sticky-issue-notes"
                          class="w-full h-28 text-xs rounded-md border border-[#fcd34d] bg-[#fffbeb] px-2 py-1 focus:outline-none focus:ring-1 focus:ring-[#f59e0b] resize-none"></textarea>
            </div>
            <div class="px-4 py-2 flex justify-between items-center border-t border-[#fcd34d]/70 bg-[#fef9c3] rounded-b-xl">
                <span id="sticky-status-pill"
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wide"></span>
                <div class="space-x-2">
                    <button id="sticky-reset-btn"
                            class="text-[10px] font-semibold px-2 py-1 rounded border border-[#fbbf24] hover:bg-[#fef3c7]">
                        Revertir
                    </button>
                    <button id="sticky-save-btn"
                            class="text-[10px] font-semibold px-3 py-1 rounded bg-[#f59e0b] text-white shadow hover:bg-[#d97706]">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- FIN Kanban de Issues -->
<div id="risks-container-for-export" class="card p-6 rounded-lg lg:col-span-2 bg-[--bl-azul-oscuro]">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-display text-2xl text-white cursor-pointer" data-tooltip-text="Identifica todas las tareas que ya han superado su fecha de finalizaci√≥n planificada pero no est√°n al 100% completadas. Son un indicador directo de los desv√≠os del proyecto.">Riesgos (Tareas Atrasadas)</h3>
                        <button class="action-btn no-export" id="exportRisksJPG"><i data-lucide="image"></i>JPG</button>
                    </div>
                    <ul class="space-y-3 max-h-60 overflow-y-auto" id="riskList"></ul>
                </div>
            </div>
        </section>
    </main>

    <div id="task-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="card w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-white/10">
                <h3 id="modal-title" class="font-display text-2xl text-[--bl-dorado]"></h3>
                <button id="modal-close-btn" class="p-1 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>

    <div id="gantt-tooltip"></div>

    <aside id="branding-panel" class="flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-white/10">
            <h3 class="font-display text-2xl text-[--bl-dorado]">Personalizaci√≥n y IA</h3>
            <button id="branding-close-btn" class="p-1 rounded-full hover:bg-white/10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
            <div>
                <h4 class="font-semibold mb-2 text-white/80">Logo del Cliente (Izquierda)</h4>
                <input type="file" id="logo-upload-input" class="hidden" accept="image/*">
                <label for="logo-upload-input" class="w-full text-center block bg-white/5 py-2 rounded-md border border-dashed border-white/20 cursor-pointer hover:bg-white/10">
                    Subir nuevo logo de cliente
                </label>
            </div>
            <div>
                <h4 class="font-semibold mb-2 text-white/80">Logo de BlatoRH (Centro)</h4>
                <div class="brand-actions mt-2 flex gap-2">
                    <button id="logo-restore-btn" class="btn w-full">Subir logo de Blatorh</button>
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-2 text-white/80">Tema de Color</h4>
                <div class="grid grid-cols-3 gap-2 text-sm">
                    <button class="theme-btn border-2 border-[--bl-dorado] p-2 rounded-md" data-theme="default">Default</button>
                    <button class="theme-btn border-2 border-transparent p-2 rounded-md" data-theme="oceanic">Oce√°nico</button>
                    <button class="theme-btn border-2 border-transparent p-2 rounded-md" data-theme="contrast">Contraste</button>
                </div>
            </div>
            <div>
                 <h4 class="font-semibold mb-2 text-white/80">Color de Acento</h4>
                 <div class="relative">
                    <input type="color" id="accent-color-picker" class="w-full h-10 p-0 border-0 bg-transparent cursor-pointer">
                    <span class="absolute top-1/2 left-4 -translate-y-1/2 text-white/80 pointer-events-none" id="accent-color-value"></span>
                 </div>
            </div>

            <div class="pt-4 border-t border-white/10" id="panel-visibility-section">
                <h4 class="font-semibold mb-3 text-[--bl-dorado] flex items-center gap-2">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                    Visibilidad de Paneles
                </h4>
                <p class="text-xs text-white/70 mb-3">Selecciona qu√© paneles quieres mostrar en el dashboard:</p>
                <div id="panel-toggles-container" class="space-y-2 text-sm">
                    </div>
                <button id="save-visibility-btn" class="w-full mt-4 text-sm px-4 py-2 rounded-md bg-[--bl-azul-principal] text-white hover:bg-blue-600 transition disabled:opacity-50">
                    <i data-lucide="save" class="w-4 h-4 inline-block mr-2"></i>
                    Guardar Cambios
                </button>
                <div class="mt-4 pt-4 border-t border-white/10">
                    <h5 class="font-semibold mb-2 text-[--bl-dorado] flex items-center gap-2 text-sm">
                        <i data-lucide="layout-template" class="w-4 h-4"></i>
                        Presets de Paneles
                    </h5>
                    <p class="text-xs text-white/60 mb-3">
                        Guarda vistas personalizadas del dashboard (por ejemplo: "Vista PM", "Vista Cliente", "Vista Ejecutiva").
                    </p>
                    <div class="space-y-3 text-xs">
                        <div class="flex gap-2">
                            <input id="panel-preset-name" type="text" placeholder="Nombre del preset"
                                   class="flex-1 px-2 py-1 rounded bg-white/5 border border-white/10 text-white placeholder:text-white/40 text-xs focus:outline-none focus:ring-1 focus:ring-[--bl-dorado]">
                            <button id="save-panel-preset-btn"
                                    class="px-3 py-1 rounded-md bg-[--bl-dorado] text-[--bl-azul-oscuro] font-semibold hover:opacity-90 transition text-xs">
                                Guardar como nuevo
                            </button>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2 items-center">
                                <select id="panel-presets-select"
        class="flex-1 px-2 py-1 rounded bg-white border border-white/10 text-[--bl-azul-oscuro] text-xs focus:outline-none focus:ring-1 focus:ring-[--bl-dorado]">
    <option value="">Seleccionar preset guardado‚Ä¶</option>
</select>
                                <button id="apply-panel-preset-btn"
                                        class="px-3 py-1 rounded-md bg-[--bl-azul-principal] text-white hover:bg-blue-600 transition text-xs disabled:opacity-50">
                                    Aplicar
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button id="export-panel-preset-btn"
                                        class="flex-1 px-3 py-1 rounded-md bg-white/5 text-white hover:bg-white/10 transition text-xs disabled:opacity-50">
                                    Exportar preset
                                </button>
                                <label class="flex-1 cursor-pointer">
                                    <span class="sr-only">Importar preset</span>
                                    <input id="import-panel-preset-input" type="file" accept="application/json"
                                           class="block w-full text-xs text-white/60 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-[--bl-dorado] file:text-[--bl-azul-oscuro] hover:file:bg-[--bl-dorado]/90">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="pt-4 border-t border-white/10">
                 <h4 class="font-semibold mb-2 text-[--bl-dorado] flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    Configuraci√≥n Gemini AI
                </h4>
                <p class="text-xs text-white/70 mb-2">
                    Introduce tu API Key de Gemini Studio (debe tener acceso al modelo `gemini-2.5-flash-preview-05-20`).
                    <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-blue-400 hover:text-blue-300 underline block mt-1">Obtener mi API Key</a>
                </p>
                <input type="password" id="gemini-api-key-input" placeholder="Ingresa tu clave aqu√≠..." value="">
                <button id="save-api-key-btn" class="w-full mt-2 text-sm px-4 py-2 rounded-md bg-[--bl-azul-principal] text-white hover:bg-blue-600 transition">
                    Guardar Clave
                </button>
                <p id="api-status-msg" class="text-xs mt-2 h-4 text-white/70"></p>
            </div>
        </div>
        <div class="p-4 border-t border-white/10 text-right">
            <button id="presenter-save-btn"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-[--bl-dorado] text-[--bl-azul-oscuro] text-xs font-semibold hover:bg-yellow-300 transition-colors no-export">
                <i data-lucide="save" class="w-4 h-4"></i>
                Guardar notas PM
            </button>
        </div>
    </aside>
    <aside id="presenter-panel" class="flex flex-col no-export">
        <div class="flex justify-between items-center p-4 border-b border-white/10">
            <h3 class="font-display text-2xl text-[--bl-dorado]">Modo Presentador</h3>
            <button id="presenter-close-btn" class="p-1 rounded-full hover:bg-white/10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="presenter-panel-body" class="p-6 space-y-4 overflow-y-auto text-xs text-white/80">
            <!-- Las secciones se inyectan din√°micamente desde PANELS_CONFIG -->
        </div>
    </aside>

    <div id="presenter-note-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[120] hidden no-export">
        <div class="bg-[#020617] border border-[--bl-dorado] rounded-xl max-w-lg w-11/12 p-4 shadow-2xl">
            <div class="flex items-center justify-between mb-2">
                <h4 class="font-display text-lg text-[--bl-dorado]">Nota del Presentador</h4>
                <button id="presenter-note-close" class="p-1 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <p id="presenter-note-panel-label" class="text-xs text-white/60 mb-2"></p>
            <div id="presenter-note-content" class="max-h-64 overflow-y-auto text-sm text-white/80 whitespace-pre-line"></div>
        </div>
    </div>


    <footer class="text-center p-4 mt-6 text-sm text-white/40">
        Copyright 2024 | BlatoRH Group | All Rights Reserved
    </footer>

    <script>
    // --- SCRIPT DE LA APLICACI√ìN ---
    // --- I18N / Internacionalizaci√≥n ---

    async function loadTranslations(lang) {
        try {
            if (!lang) lang = 'es';

            // Intentar refrescar traducciones desde translations.json,
            // pero seguir funcionando con las embebidas si falla.
            try {
                const resp = await fetch('translations.json');
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && typeof data === 'object') {
                        TRANSLATIONS = data;
                    }
                }
            } catch (innerErr) {
                console.warn('No se pudo refrescar translations.json, se usan las traducciones embebidas.', innerErr);
            }

            if (!TRANSLATIONS || !TRANSLATIONS[lang]) {
                console.warn('Idioma no encontrado en translations, usando ES como fallback');
                lang = 'es';
            }

            CURRENT_LANG = lang;
            safeSetItem('i18nLang', lang);
            applyLanguage(lang);
        } catch (err) {
            console.warn('Error general en loadTranslations, usando ES por defecto', err);
            CURRENT_LANG = 'es';
            if (TRANSLATIONS && TRANSLATIONS['es']) {
                applyLanguage('es');
            }
        }
    }

    function applyLanguage(lang) {
        if (!TRANSLATIONS || !TRANSLATIONS[lang]) return;
        const dict = TRANSLATIONS[lang];
        const fallback = TRANSLATIONS['es'] || {};
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.getAttribute('data-i18n-key');
            if (!key) return;
            const txt = (dict[key] ?? fallback[key] ?? '');
            if (typeof txt === 'string') {
                el.textContent = txt;
            }
        });
    }


    // Global variable for API key
    let GEMINI_API_KEY = "";
    let TRANSLATIONS = {
    "es": {
        "upload_lang_label": "Idioma:",
        "upload_step_1_title": "Arrastra o selecciona el Archivo Actual",
        "upload_step_1_subtitle": "Este es el archivo XML de MS Project m√°s reciente (obligatorio).",
        "upload_step_1_button": "Seleccionar Archivo",
        "upload_step_2_banner_title": "Archivo Actual Cargado:",
        "upload_step_2_title": "Ahora, el Archivo Anterior (Opcional)",
        "upload_step_2_subtitle": "Para comparar, arrastra o selecciona el XML de la semana pasada.",
        "upload_step_2_button": "Seleccionar Archivo",
        "upload_generate_button": "Generar Dashboard"
    },
    "en": {
        "upload_lang_label": "Language:",
        "upload_step_1_title": "Drag or select the Current File",
        "upload_step_1_subtitle": "This is the most recent MS Project XML file (required).",
        "upload_step_1_button": "Select File",
        "upload_step_2_banner_title": "Current File Loaded:",
        "upload_step_2_title": "Now, the Previous File (Optional)",
        "upload_step_2_subtitle": "To compare, drag or select last week's XML file.",
        "upload_step_2_button": "Select File",
        "upload_generate_button": "Generate Dashboard"
    },
    "pt": {
        "upload_lang_label": "Idioma:",
        "upload_step_1_title": "Arraste ou selecione o Arquivo Atual",
        "upload_step_1_subtitle": "Este √© o arquivo XML mais recente do MS Project (obrigat√≥rio).",
        "upload_step_1_button": "Selecionar Arquivo",
        "upload_step_2_banner_title": "Arquivo Atual Carregado:",
        "upload_step_2_title": "Agora, o Arquivo Anterior (Opcional)",
        "upload_step_2_subtitle": "Para comparar, arraste ou selecione o arquivo XML da semana passada.",
        "upload_step_2_button": "Selecionar Arquivo",
        "upload_generate_button": "Gerar Dashboard"
    }
};
    let CURRENT_LANG = 'es';
    function safeSetItem(key, value) {
        try {
            window.localStorage.setItem(key, value);
        } catch (e) {
            console.warn('No se pudo guardar en localStorage para key=', key, e);
        }
    }


    // Lock de tama√±o de logo BlatoRH
    function lockBlatorhLogoBox() {
      const logo = document.getElementById('blatorh-logo-center');
      if (!logo) return;
      const r = logo.getBoundingClientRect();
      if (r.width && r.height) {
        document.documentElement.style.setProperty('--logo-bl-w', r.width + 'px');
        document.documentElement.style.setProperty('--logo-bl-h', r.height + 'px');
      }
    }


    // --- CONFIGURACI√ìN DE VISIBILIDAD DE PANELES ---
    const PANELS_CONFIG = {
        // ID del contenedor : Nombre legible para el usuario
        'trend-analysis-container-for-export': 'An√°lisis de Tendencias',
        'summary-container-for-export': 'Resumen Ejecutivo IA',
        'progressChart': 'Gr√°fico % Avance Real',
        'timeChart': 'Gr√°fico % Avance Plan',
        'rag-kpi-card': 'Estado General (RAG)',
        'completedTasksCard': 'Tarjeta Tareas Completadas',
        'inProgressTasksCard': 'Tarjeta Tareas en Progreso',
        'notStartedTasksCard': 'Tarjeta Tareas por Iniciar',
        'overdueTasksCard': 'Tarjeta Tareas Atrasadas',
        'gantt-container-for-export': 'Diagrama de Gantt',
        'burnup-container-for-export': 'Gr√°fico de Avance (Curva S)',
        'resources-container-for-export': 'An√°lisis de Carga de Recursos',
        'spi-kpi-card': 'KPI √çndice de Rendimiento (SPI)',
        'predictive-risks-container': 'Diagn√≥stico Predictivo de Riesgos (IA)',
        'foco-critico-container-for-export': 'Tareas de Foco Cr√≠tico',
        'upcoming-tasks-container-for-export': 'Pr√≥ximas Tareas Clave',
        'milestones-container-for-export': 'Hitos Principales',
        'criticalpath-container-for-export': 'Ruta Cr√≠tica',
        'issues-kanban-container-for-export': 'Kanban de Issues',
        'risks-container-for-export': 'Riesgos (Tareas Atrasadas)'
    };
    // --- FIN DE CONFIGURACI√ìN DE VISIBILIDAD DE PANELES ---

    // --- INICIO DE NUEVAS FUNCIONALIDADES ---

    document.addEventListener('DOMContentLoaded', () => {
        const storedLang = localStorage.getItem('i18nLang') || 'es';
        loadTranslations(storedLang);
        const langSelectorEl = document.getElementById('lang-selector');
        if (langSelectorEl) {
            langSelectorEl.value = storedLang;
            langSelectorEl.addEventListener('change', (e) => {
                const lang = e.target.value || 'es';
                loadTranslations(lang);
            });
        }

        const langToggleBtn = document.getElementById('lang-toggle-btn');
        const langMenu = document.getElementById('lang-menu');
        if (langToggleBtn && langMenu) {
            langToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                langMenu.classList.toggle('hidden');
            });

            langMenu.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-lang]');
                if (!btn) return;
                const lang = btn.getAttribute('data-lang') || 'es';
                loadTranslations(lang);
                langMenu.classList.add('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!langMenu.classList.contains('hidden')) {
                    if (!langMenu.contains(e.target) && e.target !== langToggleBtn) {
                        langMenu.classList.add('hidden');
                    }
                }
            });
        }



        // 1. Inicializar fondo interactivo
        particlesJS('particles-js', {
            "particles": { "number": { "value": 50, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#ffffff" }, "shape": { "type": "circle" }, "opacity": { "value": 0.3, "random": false }, "size": { "value": 3, "random": true }, "line_linked": { "enable": true, "distance": 150, "color": getComputedStyle(document.documentElement).getPropertyValue('--bl-dorado').trim(), "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false } },
            "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 1 } }, "push": { "particles_nb": 4 } } },
            "retina_detect": true
        });

        // 2. Aplicar preferencias guardadas y API Key
        loadGeminiApiKey(); // Cargar la clave al inicio
        applySavedPreferences();

        // 3. Animaci√≥n de entrada
        setTimeout(() => {
            document.getElementById('uploadSection').classList.add('loaded');
        }, 100);

        // 4. L√≥gica del panel de personalizaci√≥n
        const brandingPanel = document.getElementById('branding-panel');
        document.getElementById('branding-toggle-btn').addEventListener('click', () => brandingPanel.classList.add('is-open'));
        document.getElementById('branding-close-btn').addEventListener('click', () => brandingPanel.classList.remove('is-open'));

        // Logo Cliente
        const logoInput = document.getElementById('logo-upload-input');
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataUrl = event.target.result;
                    try{ safeSetItem('customLogo', dataUrl); }catch(e){ console.warn('No se pudo guardar customLogo en localStorage (quota):', e); }
                    document.getElementById('custom-logo').src = dataUrl;
                };
                reader.readAsDataURL(file);
            }
        });

        // Temas
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                safeSetItem('customTheme', theme);
                applyTheme(theme);
            });
        });

        // Color de acento
        const colorPicker = document.getElementById('accent-color-picker');
        colorPicker.addEventListener('input', (e) => {
            const newColor = e.target.value;
            safeSetItem('accentColor', newColor);
            applyAccentColor(newColor);
        });

        // 4b. L√≥gica de la API Key de Gemini
        const apiKeyInput = document.getElementById('gemini-api-key-input');
        const saveApiBtn = document.getElementById('save-api-key-btn');
        const apiStatusMsg = document.getElementById('api-status-msg');

        saveApiBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                safeSetItem('geminiApiKey', key);
                GEMINI_API_KEY = key;
                apiStatusMsg.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 inline-block mr-1 text-green-400"></i>Clave guardada exitosamente.`;
            } else {
                localStorage.removeItem('geminiApiKey');
                GEMINI_API_KEY = "";
                apiStatusMsg.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 inline-block mr-1 text-red-400"></i>Clave eliminada. El resumen IA no funcionar√°.`;
            }
            lucide.createIcons();
            setTimeout(() => apiStatusMsg.textContent = '', 5000);
        });

        // 5. L√≥gica de la zona de carga inteligente (c√≥digo existente)
        const dropzone = document.getElementById('smart-dropzone');
        const currentFileInput = document.getElementById('currentFile');
        const previousFileInput = document.getElementById('previousFile');
        const generateBtn = document.getElementById('generate-report-btn');
        const step1 = document.getElementById('upload-step-1');
        const step2 = document.getElementById('upload-step-2');

        const handleFileSelection = (file, inputTarget) => {
            if (inputTarget.id === 'currentFile') {
                document.getElementById('currentFileName').textContent = file.name;
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                generateBtn.disabled = false;
            } else if (inputTarget.id === 'previousFile') {
                document.getElementById('previousFileName').textContent = file.name;
            }
        };

        [currentFileInput, previousFileInput].forEach(input => {
            input.addEventListener('change', (e) => handleFileSelection(e.target.files[0], e.target));
        });

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                // Si el paso 1 est√° visible, es el archivo actual. Si no, es el anterior.
                const targetInput = step1.classList.contains('hidden') ? previousFileInput : currentFileInput;
                targetInput.files = e.dataTransfer.files;
                handleFileSelection(file, targetInput);
            }
        });

        // Agregar listener al bot√≥n de IA de Resumen
        document.getElementById('generate-summary-btn').addEventListener('click', generateExecutiveSummaryAI);

        // Agregar listener al bot√≥n de IA de Riesgos
        document.getElementById('analyze-risks-btn').addEventListener('click', generatePredictiveRisksAI);

        // Agregar listeners de doble clic para Asistente IA (Mejora 2)
        document.getElementById('spi-kpi-card').addEventListener('dblclick', (e) => {
            e.preventDefault();
            const spiValue = document.getElementById('spiValueContainer').textContent.trim();
            explainKPIAI('Schedule Performance Index (SPI)', spiValue, 'spi');
        });
        initPresenterMode();

        document.getElementById('rag-kpi-card').addEventListener('dblclick', (e) => {
            e.preventDefault();
            // Recoger los estados RAG generados por getRagStates
            const ragTimeStatus = document.querySelector('#ragStatusContainer > div:nth-child(1) h4').textContent.trim();
            const ragTasksStatus = document.querySelector('#ragStatusContainer > div:nth-child(2) h4').textContent.trim();
            explainKPIAI('Estado General (RAG)', `Tiempo: ${ragTimeStatus}, Tareas: ${ragTasksStatus}`, 'rag');
        });
    });

    /**
     * Carga la API Key de Gemini desde localStorage al inicio.
     */
    function loadGeminiApiKey() {
        const savedKey = localStorage.getItem('geminiApiKey');
        const apiKeyInput = document.getElementById('gemini-api-key-input');
        if (savedKey) {
            GEMINI_API_KEY = savedKey;
            apiKeyInput.value = savedKey;
        } else {
            GEMINI_API_KEY = "";
        }
    }

    // --- GESTI√ìN DE VISIBILIDAD DE PANELES ---
    const PANEL_PRESETS_KEY = 'panelVisibilityPresets_v1';

    function loadPanelPresets() {
        try {
            const raw = localStorage.getItem(PANEL_PRESETS_KEY);
            if (!raw) return {};
            const parsed = JSON.parse(raw);
            return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (e) {
            console.warn('No se pudieron cargar los presets de paneles:', e);
            return {};
        }
    }

    function savePanelPresets(presets) {
        try {
            safeSetItem(PANEL_PRESETS_KEY, JSON.stringify(presets));
        } catch (e) {
            console.warn('No se pudieron guardar los presets de paneles:', e);
        }
    }

    function getCurrentVisibilityFromUI() {
        const container = document.getElementById('panel-toggles-container');
        if (!container) {
            return loadPanelVisibilityState();
        }

        const checkboxes = container.querySelectorAll('input[type="checkbox"][data-panel-id]');
        const state = {};

        checkboxes.forEach(cb => {
            state[cb.dataset.panelId] = cb.checked;
        });

        Object.keys(PANELS_CONFIG).forEach(id => {
            if (typeof state[id] === 'undefined') {
                state[id] = true;
            }
        });

        return state;
    }

    function applyVisibilityStateToUI(state) {
        const normalized = {};
        Object.keys(PANELS_CONFIG).forEach(id => {
            normalized[id] = state && typeof state[id] !== 'undefined' ? !!state[id] : true;
        });

        savePanelVisibilityState(normalized);
        applyPanelVisibility();

        const container = document.getElementById('panel-toggles-container');
        if (container) {
            const checkboxes = container.querySelectorAll('input[type="checkbox"][data-panel-id]');
            checkboxes.forEach(cb => {
                const panelId = cb.dataset.panelId;
                if (typeof normalized[panelId] !== 'undefined') {
                    cb.checked = normalized[panelId];
                }
            });
        }
    }

    function refreshPanelPresetsSelect() {
        const select = document.getElementById('panel-presets-select');
        if (!select) return;

        const presets = loadPanelPresets();
        const currentValue = select.value;

        select.innerHTML = '<option value="">Seleccionar preset guardado‚Ä¶</option>';

        Object.keys(presets).sort().forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

        if (currentValue && presets[currentValue]) {
            select.value = currentValue;
        }
    }

    function initPanelPresetsUI() {
        const nameInput = document.getElementById('panel-preset-name');
        const saveBtn = document.getElementById('save-panel-preset-btn');
        const select = document.getElementById('panel-presets-select');
        const applyBtn = document.getElementById('apply-panel-preset-btn');
        const exportBtn = document.getElementById('export-panel-preset-btn');
        const importInput = document.getElementById('import-panel-preset-input');

        if (!nameInput || !saveBtn || !select || !applyBtn || !exportBtn || !importInput) {
            return;
        }

        refreshPanelPresetsSelect();

        saveBtn.addEventListener('click', () => {
            const name = (nameInput.value || '').trim();
            if (!name) {
                alert('Ingresa un nombre para el preset.');
                return;
            }

            const presets = loadPanelPresets();
            const state = getCurrentVisibilityFromUI();
            presets[name] = state;
            savePanelPresets(presets);
            refreshPanelPresetsSelect();
            select.value = name;
        });

        applyBtn.addEventListener('click', () => {
            const name = select.value;
            if (!name) return;

            const presets = loadPanelPresets();
            const state = presets[name];
            if (!state) return;

            applyVisibilityStateToUI(state);
        });

        exportBtn.addEventListener('click', () => {
            const name = select.value;
            if (!name) {
                alert('Selecciona un preset para exportar.');
                return;
            }

            const presets = loadPanelPresets();
            const state = presets[name];
            if (!state) return;

            const payload = {
                type: 'project-dashboard-panel-preset',
                version: 1,
                name,
                state
            };

            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `panel_preset_${name.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const payload = JSON.parse(ev.target.result);
                    if (!payload || payload.type !== 'project-dashboard-panel-preset' || !payload.name || !payload.state) {
                        alert('El archivo no tiene el formato esperado.');
                        return;
                    }

                    const presets = loadPanelPresets();
                    presets[payload.name] = payload.state;
                    savePanelPresets(presets);
                    refreshPanelPresetsSelect();
                    select.value = payload.name;
                } catch (err) {
                    console.error('Error al importar preset:', err);
                    alert('No se pudo importar el preset.');
                } finally {
                    importInput.value = '';
                }
            };
            reader.readAsText(file);
        });
    }


    /**
     * Carga el estado de visibilidad desde localStorage.
     * Si no existe, inicializa todos como visibles (true).
     */
    function loadPanelVisibilityState() {
        const saved = localStorage.getItem('panelVisibilityState');
        if (saved) {
            return JSON.parse(saved);
        }
        // Inicializar todos como visibles por defecto
        const initialState = {};
        Object.keys(PANELS_CONFIG).forEach(id => {
            initialState[id] = true;
        });
        return initialState;
    }

    /**
     * Guarda el estado de visibilidad en localStorage.
     */
    function savePanelVisibilityState(state) {
        safeSetItem('panelVisibilityState', JSON.stringify(state));
    }

    /**
     * Aplica el estado de visibilidad a los paneles en el DOM.
     * Regenera solo si el panel cambi√≥ de estado.
     */
    function applyPanelVisibility() {
        const state = loadPanelVisibilityState();
        let hasChanges = false;

        Object.keys(PANELS_CONFIG).forEach(panelId => {
            const panel = document.getElementById(panelId);
            const shouldBeVisible = state[panelId];

            if (panel) {
                const isCurrentlyVisible = !panel.classList.contains('hidden');
                if (isCurrentlyVisible !== shouldBeVisible) {
                    panel.classList.toggle('hidden', !shouldBeVisible);
                    hasChanges = true;
                }
            }
        });

        // Si hubo cambios, forzar re-render de gr√°ficos visibles para ajustar tama√±os
        if (hasChanges) {
            setTimeout(() => {
                // Re-render charts that might need layout adjustment
                if (window.ApexCharts) {
                    ApexCharts.exec('progressChart', 'resize'); // Si le pones ID a los charts
                    ApexCharts.exec('timeChart', 'resize');
                    ApexCharts.exec('burnupChart', 'resize'); // Asumiendo que Burnup tiene ID
                    ApexCharts.exec('resourceLoadChart', 'resize'); // Asumiendo que ResourceLoad tiene ID
                }
            }, 150);
        }
    }

    /**
     * Genera los toggles en el panel de configuraci√≥n.
     */
    function renderPanelToggles() {
        const container = document.getElementById('panel-toggles-container');
        const visibilityState = loadPanelVisibilityState();

        container.innerHTML = ''; // Limpiar existentes

        Object.entries(PANELS_CONFIG).forEach(([panelId, panelName]) => {
            const toggleDiv = document.createElement('div');
            toggleDiv.className = 'flex items-center justify-between';

            const label = document.createElement('label');
            label.className = 'text-white/80';
            label.textContent = panelName;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = visibilityState[panelId];
            checkbox.dataset.panelId = panelId;
            checkbox.className = 'accent-[--bl-dorado] w-4 h-4 cursor-pointer';

            toggleDiv.appendChild(label);
            toggleDiv.appendChild(checkbox);
            container.appendChild(toggleDiv);
        });
    }

    /**
     * Maneja el clic en "Guardar Cambios".
     */
    function handleSaveVisibilityChanges() {
        const container = document.getElementById('panel-toggles-container');
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const newState = {};

        checkboxes.forEach(checkbox => {
            newState[checkbox.dataset.panelId] = checkbox.checked;
        });

        savePanelVisibilityState(newState);
        applyPanelVisibility();

        // Feedback visual
        const saveBtn = document.getElementById('save-visibility-btn');
        const originalHTML = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 inline-block mr-2"></i>¬°Guardado!';
        saveBtn.disabled = true;
        lucide.createIcons();

        setTimeout(() => {
            saveBtn.innerHTML = originalHTML;
            saveBtn.disabled = false;
            lucide.createIcons();
        }, 2000);
    }

    /**
     * Inicializa toda la funcionalidad de visibilidad.
     */
    function initializePanelVisibilityFeature() {
        // Renderizar toggles y presets al abrir el panel de configuraci√≥n
        const brandingToggleBtn = document.getElementById('branding-toggle-btn');
        if (brandingToggleBtn) {
            brandingToggleBtn.addEventListener('click', () => {
                setTimeout(() => {
                    renderPanelToggles();
                    initPanelPresetsUI();
                }, 50); // Peque√±o delay para asegurar que el panel est√© visible
            });
        }

        // Asignar evento al bot√≥n de guardar
        const saveBtn = document.getElementById('save-visibility-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', handleSaveVisibilityChanges);
        }

        // La visibilidad se aplicar√° desde processAndRenderDashboard
    }
    // --- FIN DE GESTI√ìN DE VISIBILIDAD ---


    function applyTheme(theme) {
        document.body.className = document.body.className.replace(/theme-\w+/, '').trim();
        if (theme && theme !== 'default') {
            document.body.classList.add(`theme-${theme}`);
        }
        document.querySelectorAll('.theme-btn').forEach(b => {
            b.style.borderColor = b.dataset.theme === theme ? 'var(--bl-dorado)' : 'transparent';
        });
        // Actualizar el color de las part√≠culas
        if (window.pJSDom && window.pJSDom[0]) {
            const newColor = getComputedStyle(document.documentElement).getPropertyValue('--bl-dorado').trim();
            window.pJSDom[0].pJS.particles.line_linked.color = newColor;
        }
    }

    function applyAccentColor(color) {
        if (!color) return;
        document.documentElement.style.setProperty('--bl-dorado', color);
        document.getElementById('accent-color-picker').value = color;
        document.getElementById('accent-color-value').textContent = color.toUpperCase();
        // Actualizar el color de las part√≠culas
        if (window.pJSDom && window.pJSDom[0]) {
            window.pJSDom[0].pJS.particles.line_linked.color = color;
        }
    }

    function applySavedPreferences() {
        const savedLogo = localStorage.getItem('customLogo');
        const savedBlatorhLogo = localStorage.getItem('blatorhLogo'); // Nuevo logo
        const savedTheme = localStorage.getItem('customTheme') || 'default';
        const savedColor = localStorage.getItem('accentColor');

        if (savedLogo) {
            document.getElementById('custom-logo').src = savedLogo;
        }
        if (savedBlatorhLogo) {
            document.getElementById('blatorh-logo-center').src = savedBlatorhLogo;
        }

        applyTheme(savedTheme);
        if (savedColor) {
            applyAccentColor(savedColor);
        } else {
            // Sincronizar el picker con el color por defecto
            const defaultColor = getComputedStyle(document.documentElement).getPropertyValue('--bl-dorado').trim();
            document.getElementById('accent-color-picker').value = defaultColor;
            document.getElementById('accent-color-value').textContent = defaultColor.toUpperCase();
        }
    }

    // --- M√ìDULO GEMINI AI (Refactorizado para reuso) ---

    const GEMINI_MODEL = "gemini-2.5-flash";

    /**
     * Funci√≥n gen√©rica para llamar a la API de Gemini con reintento.
     * @param {string} systemPrompt - Instrucci√≥n de sistema para el modelo.
     * @param {string} userQuery - Contenido principal para el modelo.
     * @param {string} errorTargetId - ID del elemento donde mostrar errores.
     * @returns {Promise<string|null>} El texto generado o null en caso de fallo.
     */
    async function callGeminiAPI(systemPrompt, userQuery, errorTargetId) {
        const errorElement = document.getElementById(errorTargetId);
        if (!GEMINI_API_KEY) {
            errorElement.innerHTML = `<p class="text-red-400">Error: La API Key de Gemini no est√° configurada. Por favor, ingr√©sala en la configuraci√≥n.</p>`;
            lucide.createIcons();
            return null;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        let resultText = null;
        const maxRetries = 3;

        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 400 || response.status === 401) {
                         throw new Error("Error de autenticaci√≥n o solicitud inv√°lida (Revisa la API Key).");
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    resultText = candidate.content.parts[0].text;
                    break;
                } else {
                    throw new Error("Respuesta de la IA vac√≠a o inesperada.");
                }
            } catch (error) {
                console.error(`Intento ${attempt + 1} fallido:`, error.message);
                if (error.message.includes("autenticaci√≥n")) {
                     errorElement.innerHTML = `<p class="text-red-400 font-semibold">Error de autenticaci√≥n: La clave API de Gemini no es v√°lida. Por favor, corr√≠gela en la configuraci√≥n.</p>`;
                     return null;
                }
                if (attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    errorElement.innerHTML = `<p class="text-red-400 font-semibold">Error de servicio: La IA no pudo generar el resumen despu√©s de ${maxRetries} intentos.</p>`;
                    return null;
                }
            }
        }
        return resultText;
    }

    /**
     * Genera un resumen ejecutivo utilizando la API de Gemini (Mejora 1).
     */
    async function generateExecutiveSummaryAI() {
        const contentArea = document.getElementById('executive-summary-content');
        const exportBtn = document.getElementById('exportSummaryJPG');
        const generateBtn = document.getElementById('generate-summary-btn');

        if (!projectDataStore || !projectDataStore.name) {
            contentArea.innerHTML = `<p class="text-red-400">Error: No hay datos de proyecto cargados para analizar.</p>`;
            return;
        }

        generateBtn.disabled = true;
        generateBtn.innerHTML = `<span class="loading-dots">Generando resumen IA</span>`;
        exportBtn.style.display = 'none';
        contentArea.innerHTML = `<p class="text-white/50 text-center py-4"><span class="loading-dots">Analizando KPIs y redactando borrador</span>...</p>`;

        // 1. Recopilar datos de KPIs para el prompt (misma l√≥gica que antes)
        const today = new Date();
        const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary);
        const { projectedEndDate, spi } = calculateKPIs(flatTaskList, new Date(projectDataStore.startDate), new Date(projectDataStore.baselineEndDate), today);
        const taskStats = {
            completed: flatTaskList.filter(t => t.percentComplete === 100).length,
            inProgress: flatTaskList.filter(t => t.percentComplete > 0 && t.percentComplete < 100).length,
            overdue: flatTaskList.filter(t => new Date(t.end) < today && t.percentComplete < 100).length,
            total: flatTaskList.length
        };
        const criticalFocusCount = calculateFocoCriticoCount(flatTaskList, today);
        const { time: ragTime, tasks: ragTasks } = getRagStates(projectedEndDate, new Date(projectDataStore.baselineEndDate), taskStats.overdue, taskStats.total);

        const kpisData = {
            projectName: projectDataStore.name,
            projectManager: projectDataStore.projectManager,
            reportDate: formatDate(today.toISOString()),
            startDate: formatDate(projectDataStore.startDate),
            baselineEndDate: formatDate(projectDataStore.baselineEndDate),
            projectedEndDate: formatDate(projectedEndDate.toISOString()),
            schedulePerformanceIndex: spi.toFixed(2),
            tasksOverdue: taskStats.overdue,
            tasksCriticalFocus: criticalFocusCount,
            ragTimeStatus: ragTime,
            ragTasksStatus: ragTasks,
            taskCompletionStats: {
                total: taskStats.total,
                completed: taskStats.completed,
                inProgress: taskStats.inProgress,
            }
        };

        const systemPrompts = {"es": "Act√∫a como un Project Manager senior con 15 a√±os de experiencia preparando res√∫menes ejecutivos claros y accionables para clientes en espa√±ol.", "en": "Act as a senior Project Manager with 15 years of experience preparing clear, actionable executive summaries for clients in English.", "pt": "Atue como um Gerente de Projetos s√™nior com 15 anos de experi√™ncia preparando resumos executivos claros e acion√°veis para clientes em portugu√™s."};
        const systemPrompt = systemPrompts[CURRENT_LANG] || systemPrompts.es;
        const userQuery = `Datos: ${JSON.stringify(kpisData, null, 2)}`;

        const resultText = await callGeminiAPI(systemPrompt, userQuery, 'executive-summary-content');

        // 2. Inyectar el resultado y restaurar la UI
        if (resultText) {
            contentArea.innerHTML = resultText;
            exportBtn.style.display = 'inline-flex';
        }
        generateBtn.disabled = false;
        generateBtn.innerHTML = `<i data-lucide="brain-circuit"></i>Generar Resumen IA`;
        lucide.createIcons();
    }

    /**
     * Genera un diagn√≥stico predictivo de riesgos (Mejora 2 - Parte 1).
     */
    async function generatePredictiveRisksAI() {
        const contentArea = document.getElementById('predictive-risks-content');
        const generateBtn = document.getElementById('analyze-risks-btn');

        if (!projectDataStore || !projectDataStore.name) {
            contentArea.innerHTML = `<p class="text-red-400">Error: No hay datos de proyecto cargados para el an√°lisis de riesgos.</p>`;
            return;
        }

        generateBtn.disabled = true;
        generateBtn.innerHTML = `<span class="loading-dots">Analizando riesgos predictivos</span>`;
        contentArea.innerHTML = `<p class="text-white/50 text-center py-4"><span class="loading-dots">Procesando datos complejos del cronograma</span>...</p>`;

        // 1. Recolectar datos relevantes para la predicci√≥n
        const today = new Date();
        const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary);
        const { projectedEndDate, spi } = calculateKPIs(flatTaskList, new Date(projectDataStore.startDate), new Date(projectDataStore.baselineEndDate), today);

        // Identificar tareas cr√≠ticas y recursos sobrecargados (simplificado del chart de recursos)
        const criticalTasks = flatTaskList.filter(t => t.isCritical && t.percentComplete < 100)
            .map(t => ({
                name: t.name,
                end: formatDate(t.end),
                percent: t.percentComplete,
                overdue: new Date(t.end) < today ? true : false,
                overdueDays: new Date(t.end) < today ? Math.ceil((today - new Date(t.end)) / (1000 * 60 * 60 * 24)) : 0
            }));

        const resourcesMap = projectDataStore.resources;
        const resourceLoadData = Array.from(getResourceLoadData(flatTaskList, resourcesMap).entries()).map(([name, data]) => ({
            resource: name,
            taskCount: data.count,
            overloadIndicator: data.count > (flatTaskList.length / 5) ? 'High' : 'Normal'
        }));

        const { time: ragTime, tasks: ragTasks } = getRagStates(projectedEndDate, new Date(projectDataStore.baselineEndDate), criticalTasks.filter(t => t.overdue).length, flatTaskList.length);

        const risksData = {
            projectName: projectDataStore.name,
            reportDate: formatDate(today.toISOString()),
            projectStatus: {
                statusRAG: ragTime === 'Red' || ragTasks === 'Red' ? 'Rojo' : (ragTime === 'Amber' || ragTasks === 'Amber' ? '√Åmbar' : 'Verde'),
                spi: spi.toFixed(2),
                projectedDelayDays: Math.max(0, Math.ceil((projectedEndDate - new Date(projectDataStore.baselineEndDate)) / (1000 * 60 * 60 * 24))),
                tasksOverdueCount: criticalTasks.filter(t => t.overdue).length
            },
            criticalTasks: criticalTasks.slice(0, 15), // Muestrear m√°s para que el modelo elija
            resourceOverloadSample: resourceLoadData.filter(r => r.overloadIndicator === 'High').slice(0, 3)
        };

        const systemPrompts = {"es": "Act√∫a como un Project Manager senior experto en gesti√≥n de riesgos, identificando los 3‚Äì5 riesgos m√°s probables que afecten el cronograma en las pr√≥ximas dos semanas, en espa√±ol.", "en": "Act as a senior Project Manager specialized in risk management, identifying the 3‚Äì5 most likely risks that may impact the schedule in the next two weeks, in English.", "pt": "Atue como um Gerente de Projetos s√™nior especializado em gest√£o de riscos, identificando os 3‚Äì5 riscos mais prov√°veis de impactar o cronograma nas pr√≥ximas duas semanas, em portugu√™s."};
        const systemPrompt = systemPrompts[CURRENT_LANG] || systemPrompts.es;
        const userQuery = `Datos para el Diagn√≥stico Predictivo de Riesgos: ${JSON.stringify(risksData, null, 2)}`;

        const resultText = await callGeminiAPI(systemPrompt, userQuery, 'predictive-risks-content');

        // 2. Inyectar el resultado y restaurar la UI
        if (resultText) {
            contentArea.innerHTML = resultText;
            document.getElementById('exportRisksPredictiveJPG').style.display = 'inline-flex';
        } else {
             // Si fall√≥, el error ya fue escrito por callGeminiAPI
        }
        generateBtn.disabled = false;
        generateBtn.innerHTML = `<i data-lucide="shield-half"></i>Analizar Riesgos con IA`;
        lucide.createIcons();
    }

    /**
     * Asistente de Interpretaci√≥n Contextual en Tiempo Real (Mejora 2 - Parte 2).
     */
    async function explainKPIAI(kpiName, kpiValue, kpiType) {
        if (!projectDataStore || !projectDataStore.name) {
            showTaskModal('Asistente IA', '<p class="text-red-400">Carga un proyecto para habilitar el asistente de interpretaci√≥n.</p>');
            return;
        }

        const modalTitle = `Interpretaci√≥n IA: ${kpiName}`;
        const loadingContent = `<p class="text-white/50 text-center py-4"><span class="loading-dots">Consultando experto de BlatoRH IA</span>...</p>`;
        showTaskModal(modalTitle, loadingContent);

        const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary);
        const { projectedEndDate, spi } = calculateKPIs(flatTaskList, new Date(projectDataStore.startDate), new Date(projectDataStore.baselineEndDate), new Date());

        const contextData = {
            kpiName: kpiName,
            kpiValue: kpiValue,
            projectName: projectDataStore.name,
            currentSPI: spi.toFixed(2),
            projectedEndDate: formatDate(projectedEndDate.toISOString()),
            baselineEndDate: formatDate(projectDataStore.baselineEndDate),
            tasksTotal: flatTaskList.length,
            tasksOverdue: flatTaskList.filter(t => new Date(t.end) < new Date() && t.percentComplete < 100).length
        };

        const systemPrompt = "Eres un consultor de BlatoRH explic√°ndole a un cliente no t√©cnico el estado de su proyecto. El KPI '[NOMBRE_KPI]' tiene un valor de '[VALOR]'. Explica en 1-2 oraciones claras y sin jerga t√©cnica: 1) Qu√© significa este valor en el contexto de SU proyecto espec√≠fico (usando el nombre del proyecto y las fechas), y 2) Qu√© deber√≠a hacer el cliente al respecto (si aplica). S√© directo, conciso y √∫til. El resultado debe estar en formato HTML, contenido en una √∫nica etiqueta <p>.";
        let userQuery = `Analiza este KPI: ${kpiName} con valor ${kpiValue}. Contexto del Proyecto: ${JSON.stringify(contextData, null, 2)}`;

        // Sobrescribir el prompt para RAG ya que es un KPI compuesto
        if (kpiType === 'rag') {
             userQuery = `Analiza el estado RAG (Rojo, √Åmbar, Verde) de la siguiente manera: ${kpiValue}. Contexto del Proyecto: ${JSON.stringify(contextData, null, 2)}. El resumen debe explicar el riesgo implicado por esos colores para el proyecto ${contextData.projectName} y la acci√≥n sugerida.`;
        }

        const resultText = await callGeminiAPI(systemPrompt, userQuery, 'modal-content');

        // 2. Inyectar el resultado en el modal
        if (resultText) {
            document.getElementById('modal-content').innerHTML = resultText;
        }
        // Si fall√≥, el error ya fue escrito por callGeminiAPI en el modal
    }

    /**
     * Helper para obtener datos de carga de recursos para el prompt predictivo.
     * @returns {Map} Mapa de recursos gen√©ricos y su carga.
     */
    function getResourceLoadData(tasks, resourcesMap) {
        const genericResourceLoad = new Map();
        tasks.forEach(task => {
            task.resourceIds.forEach(resId => {
                const resource = resourcesMap.get(resId);
                if(resource && resource.name) {
                    const genericName = resource.name.replace(/\s*\d+\s*$/, '').trim();
                    if (!genericResourceLoad.has(genericName)) {
                        genericResourceLoad.set(genericName, { count: 0, tasks: [] });
                    }
                    genericResourceLoad.get(genericName).count++;
                }
            });
        });
        return genericResourceLoad;
    }

    // --- FIN L√ìGICA DE GEMINI AI ---


    // --- RESTO DEL SCRIPT JS ORIGINAL (CON NUEVAS FUNCIONES INTEGRADAS) ---

    let projectDataStore = {}; // Global store for full project data
    let previousProjectDataStore = null; // Store for previous project data
    let ganttViewMode = 'day'; // 'day' or 'week'
    let burnupViewMode = 'week'; // 'day' or 'week'
    let ganttMainView = 'gantt'; // gantt or network
    let ganttSearchTerm = '';
    let ganttResourceFilter = 'all';
    let ganttIsolationFilter = 'all';

    const uploadSection = document.getElementById('uploadSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const generateBtn = document.getElementById('generate-report-btn');
    const currentFileInput = document.getElementById('currentFile');
    const previousFileInput = document.getElementById('previousFile');

    generateBtn.addEventListener('click', handleFileSelect);

    async function handleFileSelect(event) {
        const currentFile = currentFileInput.files[0];
        const previousFile = previousFileInput.files[0];

        if (!currentFile) {
            console.warn("Debe seleccionar un 'Archivo Actual' para continuar.");
            return;
        }

        const readFile = file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        reject(new Error("Error al procesar el archivo XML."));
                    }
                    resolve(parseProjectXML(xmlDoc));
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        };

        try {
            const currentData = await readFile(currentFile);
            projectDataStore = { ...currentData, tasks: buildTaskTree(currentData.tasks) };

            if (previousFile) {
                const previousData = await readFile(previousFile);
                previousProjectDataStore = { ...previousData, tasks: buildTaskTree(previousData.tasks) };
            } else {
                previousProjectDataStore = null;
            }

            uploadSection.style.opacity = '0';
            uploadSection.style.pointerEvents = 'none';
            setTimeout(() => {
                uploadSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                setTimeout(() => dashboardSection.classList.remove('opacity-0'), 50);
                processAndRenderDashboard(projectDataStore, previousProjectDataStore);
            }, 500);

        } catch (error) {
            console.error("Error processing files:", error);
            const message = "Hubo un error al leer uno de los archivos del proyecto. Aseg√∫rate de que son XML v√°lidos exportados desde MS Project.";
            const contentArea = document.getElementById('executive-summary-content');
            contentArea.innerHTML = `<p class="text-red-400 font-semibold">${message}</p>`;
        }
    }

    // --- NUEVAS FUNCIONES HELPER ---
    /**
     * Calculates the RAG (Red, Amber, Green) status for Time and Tasks.
     * @returns {{time: string, tasks: string}} An object with the status ('Red', 'Amber', 'Green').
     */
    function getRagStates(projectedEndDate, baselineEndDate, overdueTasksCount, totalTasks) {
        const timeDiffDays = (projectedEndDate - baselineEndDate) / (1000 * 60 * 60 * 24);
        let timeStatus = 'Green';
        if (timeDiffDays > 14) {
            timeStatus = 'Red';
        } else if (timeDiffDays > 0) {
            timeStatus = 'Amber';
        }

        let tasksStatus = 'Green';
        if (totalTasks > 0 && (overdueTasksCount / totalTasks) > 0.1) {
            tasksStatus = 'Red';
        } else if (overdueTasksCount > 0) {
            tasksStatus = 'Amber';
        }
        return { time: timeStatus, tasks: tasksStatus };
    }

    /**
     * Calculates the number of critical focus tasks based on specific criteria.
     * @returns {number} The count of critical focus tasks.
     */
    function calculateFocoCriticoCount(tasks, today) {
        const sevenDaysFromNow = new Date(today);
        sevenDaysFromNow.setDate(today.getDate() + 7);
        const focoTasks = new Map();

        // Imminent start
        tasks.filter(t => t.isCritical && t.percentComplete === 0 && new Date(t.start) >= today && new Date(t.start) <= sevenDaysFromNow)
             .forEach(t => { if (!focoTasks.has(t.id)) focoTasks.set(t.id, { task: t }); });

        // Low progress
        tasks.filter(t => t.isCritical && t.percentComplete > 0 && t.percentComplete < 50)
             .sort((a, b) => a.percentComplete - b.percentComplete).slice(0, 5)
             .forEach(t => { if (!focoTasks.has(t.id)) focoTasks.set(t.id, { task: t }); });

        // Overdue
        tasks.filter(t => t.isCritical && t.percentComplete < 100 && new Date(t.end) < today)
             .forEach(t => { if (!focoTasks.has(t.id)) focoTasks.set(t.id, { task: t }); });

        return focoTasks.size;
    }

    /**
     * Renders the "intelligent alerts" based on key project metrics.
     */
    function renderExecutiveAlerts(data) {
        const container = document.getElementById('executive-alerts');
        if (!container) return;
        container.innerHTML = ''; // Clear previous alerts

        const createAlert = (text, color, tooltip = '') => {
            const colors = {
                red: 'bg-red-500/20 text-red-400',
                yellow: 'bg-yellow-500/20 text-yellow-400',
                green: 'bg-green-500/20 text-green-400'
            };
            const span = document.createElement('span');
            span.className = `px-2 py-1 rounded text-sm font-medium ${colors[color] || ''}`;
            span.innerHTML = text; // Use innerHTML to parse potential icon entities
            if (tooltip) {
                span.dataset.tooltipText = tooltip;
            }
            container.appendChild(span);
        };

        // Priority Order: Critical (Red) -> Warning (Yellow) -> Success (Green)
        if (data.ragTime === 'Red') {
            createAlert('üìÖ Retraso significativo en cronograma', 'red');
        }
        if (data.spi < 0.9) {
            createAlert(`üìâ SPI cr√≠tico (${data.spi.toFixed(2)})`, 'red', 'El ritmo de trabajo es significativamente menor al planificado.');
        }
        if (data.criticalCount > 0) {
            createAlert(`üéØ ${data.criticalCount} tarea(s) de foco cr√≠tico`, 'red');
        }
        if (data.overdueCount > 0) {
            createAlert(`‚ö†Ô∏è ${data.overdueCount} tarea(s) atrasadas`, 'yellow');
        }
        if (data.spi >= 0.9 && data.spi <= 0.97) {
            createAlert(`‚ö†Ô∏è SPI en precauci√≥n (${data.spi.toFixed(2)})`, 'yellow', 'El ritmo de trabajo es ligeramente m√°s lento de lo esperado.');
        }
        if (data.ragTasks === 'Green' && data.overdueCount === 0) {
            createAlert('‚úÖ Ejecuci√≥n de tareas bajo control', 'green');
        }
    }


    // --- RESTO DEL SCRIPT JS ORIGINAL (CON NUEVAS FUNCIONES INTEGRADAS) ---
    function parseProjectXML(xmlDoc) {
    const get = (el, tag) => el.getElementsByTagName(tag)[0]?.textContent?.trim() || '';

    const resources = new Map();
    Array.from(xmlDoc.getElementsByTagName('Resource')).forEach(resEl => {
        const id = get(resEl, 'UID');
        if (id) {
            resources.set(id, {
                name: get(resEl, 'Name') || `Recurso ${id}`,
            });
        }
    });

    const normalizeIssueStatus = (raw) => {
        if (!raw) return '';
        const val = raw.toString().trim().toLowerCase();
        if (!val) return '';
        if (val.includes('cerrado')) return 'Cerrado';
        if (val.includes('resuelto') || val.includes('solucion')) return 'Resuelto';
        if (val.includes('progreso') || val.includes('progress') || val.includes('curso')) return 'En Progreso';
        return 'Abierto';
    };

    const tasks = Array.from(xmlDoc.getElementsByTagName('Task')).map(taskEl => {
        const assignments = Array.from(taskEl.getElementsByTagName('Assignment')).map(assEl => {
            const resourceId = get(assEl, 'ResourceUID');
            return resourceId;
        });

        const predecessors = Array.from(taskEl.getElementsByTagName('PredecessorLink')).map(linkEl => ({
            uid: get(linkEl, 'PredecessorUID'),
            type: get(linkEl, 'Type'),
        }));

        let issueText = '';
        let issueStatusRaw = '';
        const extAttrs = Array.from(taskEl.getElementsByTagName('ExtendedAttribute'));
        extAttrs.forEach(attrEl => {
            const fieldId = get(attrEl, 'FieldID');
            if (fieldId === '188743746') {
                issueText = get(attrEl, 'Value');
            } else if (fieldId === '188743747') {
                issueStatusRaw = get(attrEl, 'Value');
            }
        });
        const issueStatus = issueText ? normalizeIssueStatus(issueStatusRaw) : '';

        return {
            id: get(taskEl, 'UID'),
            name: get(taskEl, 'Name'),
            start: get(taskEl, 'Start'),
            end: get(taskEl, 'Finish'),
            baselineStart: get(taskEl, 'BaselineStart') || get(taskEl, 'Start'),
            baselineFinish: get(taskEl, 'BaselineFinish') || get(taskEl, 'Finish'),
            percentComplete: parseFloat(get(taskEl, 'PercentComplete') || 0),
            isMilestone: get(taskEl, 'Milestone') === '1',
            isCritical: get(taskEl, 'Critical') === '1',
            outlineLevel: parseInt(get(taskEl, 'OutlineLevel') || 1, 10),
            isSummary: get(taskEl, 'Summary') === '1',
            resourceIds: assignments,
            predecessors: predecessors,
            issueText,
            issueStatus
        };
    });

    const projectSummary = tasks.find(t => t.id === '0');

    return {
        name: get(xmlDoc, 'Title') || 'Proyecto sin T√≠tulo',
        projectManager: get(xmlDoc, 'Author') || 'No especificado',
        startDate: get(xmlDoc, 'StartDate'),
        baselineEndDate: projectSummary ? projectSummary.end : get(xmlDoc, 'FinishDate'),
        tasks: tasks.filter(t => t.id !== '0' && t.name),
        resources,
    };
}

    // Paso 1: Modificar buildTaskTree para incluir ruta jer√°rquica
    function buildTaskTree(tasks) {
        const stack = [];
        const tree = [];
        const taskMap = new Map(); // Para b√∫squeda r√°pida por ID

        // Primero, crear un mapa de todas las tareas por ID
        tasks.forEach(task => taskMap.set(task.id, task));

        // Funci√≥n para construir la ruta completa
        const buildFullPath = (taskId, pathArray = []) => {
            const task = taskMap.get(taskId);
            if (!task) return pathArray;

            // A√±adir el nombre de esta tarea al inicio del array
            pathArray.unshift(task.name);

            // Buscar el padre (outlineLevel - 1)
            const parentLevel = task.outlineLevel - 1;
            if (parentLevel >= 1) {
                // Encontrar la tarea padre m√°s cercana en la jerarqu√≠a
                // Buscamos hacia atr√°s en el array original
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                for (let i = taskIndex - 1; i >= 0; i--) {
                    if (tasks[i].outlineLevel === parentLevel) {
                        return buildFullPath(tasks[i].id, pathArray);
                    }
                }
            }
            return pathArray;
        };

        for (const task of tasks) {
            // Construir la ruta completa para esta tarea
            const fullPathArray = buildFullPath(task.id);
            const parentName = fullPathArray.length > 1 ? fullPathArray[fullPathArray.length - 2] : null; // El padre directo

            const node = {
                ...task,
                children: [],
                parentName: parentName, // Nombre del padre directo
                fullPath: fullPathArray.join(' > ') // Ruta completa tipo "Fase 1 > Dise√±o > Pruebas"
            };

            while (stack.length > 0 && stack[stack.length - 1].outlineLevel >= node.outlineLevel) {
                stack.pop();
            }

            if (stack.length > 0) {
                stack[stack.length - 1].children.push(node);
            } else {
                tree.push(node);
            }

            stack.push(node);
        }
        return tree;
    }

    // Paso 2: Actualizar flattenTasks para preservar la ruta
    function flattenTasks(tasks) {
        let flat = [];
        tasks.forEach(task => {
            // Preservar las propiedades de ruta que ya existen
            flat.push(task);
            if (task.children) {
                flat = flat.concat(flattenTasks(task.children));
            }
        });
        return flat;
    }

    // Paso 3: Crear una funci√≥n helper para mostrar la ruta
    /**
     * Formatea la ruta de una tarea para mostrarla en UI
     * @param {object} task - La tarea con propiedades fullPath y parentName
     * @param {boolean} showFullPath - Si true, muestra "Fase > Subfase > Tarea". Si false, solo "Fase > Tarea"
     * @returns {string} HTML formateado
     */
    function formatTaskPath(task, showFullPath = true) {
        if (!task.fullPath) return '';

        const pathArray = task.fullPath.split(' > ');
        if (pathArray.length <= 1) return ''; // No hay padre

        if (showFullPath && pathArray.length > 2) {
            // Muestra toda la jerarqu√≠a
            return `<span class="text-xs text-white/50 block">${task.fullPath}</span>`;
        } else if (task.parentName) {
            // Solo muestra el padre directo
            return `<span class="text-xs text-white/50 block">${task.parentName}</span>`;
        }
        return '';
    }

    // --- Kanban de Issues & Sticky Notes ---

const ISSUE_STATUSES = [
    { key: 'Abierto',      title: 'Abierto',      caption: 'Issues detectados pendientes de an√°lisis.' },
    { key: 'En Progreso',  title: 'En Progreso',  caption: 'Issues en tratamiento activo.' },
    { key: 'Resuelto',     title: 'Resuelto',     caption: 'Soluci√≥n aplicada, pendiente de cierre formal.' },
    { key: 'Cerrado',      title: 'Cerrado',      caption: 'Issue cerrado y comunicado.' }
];

let currentIssueNoteContext = null;
let issuesStickyInitialized = false;
let presenterModeInitialized = false;
let presenterDebounceTimers = {};
let presenterNoteModalInitialized = false;


function getIssuesNotesStoreKey(projectName) {
    const safe = (projectName || 'Proyecto_Sin_Nombre').toLowerCase().replace(/[^a-z0-9]+/g, '_');
    return `blatorh_issues_notes_${safe}`;
}

function loadIssuesNotes(storeKey) {
    try {
        const raw = localStorage.getItem(storeKey);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
    } catch (e) {
        console.warn('No se pudieron cargar notas de issues:', e);
        return {};
    }
}

function saveIssuesNotes(storeKey, notes) {
    try {
        safeSetItem(storeKey, JSON.stringify(notes || {}));
    } catch (e) {
        console.warn('No se pudieron guardar notas de issues:', e);
    }
}

function statusPillClasses(status) {
    switch (status) {
        case 'Abierto':
            return 'bg-red-100 text-red-700 border-red-300';
        case 'En Progreso':
            return 'bg-yellow-100 text-yellow-700 border-yellow-300';
        case 'Resuelto':
            return 'bg-emerald-100 text-emerald-700 border-emerald-300';
        case 'Cerrado':
            return 'bg-slate-200 text-slate-800 border-slate-300';
        default:
            return 'bg-slate-200 text-slate-800 border-slate-300';
    }
}

// Construye el Kanban usando SOLO el archivo actual
function renderIssuesKanban(data, flatTaskListOverride = null) {
    const container = document.getElementById('issues-kanban-container-for-export');
    const board = document.getElementById('issues-kanban-board');
    if (!container || !board) return;

    const flat = flatTaskListOverride || flattenTasks(data.tasks || []);
    const projectName = data.name || 'Proyecto sin T√≠tulo';
    const notesStoreKey = getIssuesNotesStoreKey(projectName);
    const notes = loadIssuesNotes(notesStoreKey);

    const issues = flat
        .filter(t => t.issueText && t.issueText.trim())
        .map(t => ({
            id: t.id,
            taskName: t.name,
            parentName: t.parentName || '',
            fullPath: t.fullPath || '',
            issueText: t.issueText,
            status: t.issueStatus || 'Abierto'
        }));

    board.innerHTML = '';

    if (!issues.length) {
        board.innerHTML = `
            <p class="col-span-4 text-xs text-white/60 italic">
                No se detectaron issues con texto en el archivo actual.
            </p>`;
        return;
    }

    ISSUE_STATUSES.forEach(statusConf => {
        const col = document.createElement('div');
        col.className = 'bg-[#020617]/40 rounded-lg border border-white/10 flex flex-col max-h-[420px]';

        col.innerHTML = `
            <div class="px-3 py-2 border-b border-white/10 flex items-center justify-between">
                <div>
                    <p class="font-display text-lg text-white">${statusConf.title}</p>
                    <p class="text-[10px] text-white/60">${statusConf.caption}</p>
                </div>
                <span class="rounded-full px-2 py-0.5 text-[10px] font-semibold bg-white/5 text-white count-pill">0</span>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2 issues-column-body"></div>
        `;

        const body = col.querySelector('.issues-column-body');
        const countPill = col.querySelector('.count-pill');

        const colIssues = issues.filter(i => i.status === statusConf.key);
        countPill.textContent = colIssues.length;

        colIssues.forEach(issue => {
            const card = document.createElement('button');
            card.type = 'button';
            card.className = 'w-full text-left rounded-md bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 shadow-sm transition flex flex-col gap-1';

            const noteKey = issue.id.toString();
            const hasNote = !!(notes[noteKey] && notes[noteKey].trim());

            const parentInfo = issue.parentName
                ? `${issue.parentName} ‚Ä∫ ${issue.taskName}`
                : issue.taskName;

            card.innerHTML = `
                <div class="flex items-center justify-between gap-2">
                    <span class="text-[11px] font-semibold text-[--bl-dorado] line-clamp-1">${issue.taskName}</span>
                    ${hasNote ? '<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-[#facc15]/10 border border-[#facc15]/60 text-[9px] text-[#facc15] font-semibold">Notas</span>' : ''}
                </div>
                <p class="text-[10px] text-white/60 truncate" title="${issue.fullPath || parentInfo}">${parentInfo}</p>
                <p class="text-[11px] text-white/80 line-clamp-3" title="${issue.issueText}">${issue.issueText}</p>
            `;

            card.addEventListener('click', () => {
                openIssueStickyNote(issue, notes, notesStoreKey);
            });

            body.appendChild(card);
        });

        board.appendChild(col);
    });

    initializeIssuesStickyHandlers();
}

function initializeIssuesStickyHandlers() {
    if (issuesStickyInitialized) return;
    issuesStickyInitialized = true;

    const modal = document.getElementById('issue-sticky-note');
    if (!modal) return;

    const closeBtn = document.getElementById('sticky-close-btn');
    const saveBtn = document.getElementById('sticky-save-btn');
    const resetBtn = document.getElementById('sticky-reset-btn');

    const closeModal = () => {
        modal.classList.add('hidden');
        currentIssueNoteContext = null;
    };

    if (closeBtn) {
        closeBtn.onclick = closeModal;
    }

    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeModal();
        }
    });

    if (resetBtn) {
        resetBtn.onclick = () => {
            if (!currentIssueNoteContext) return;
            const textarea = document.getElementById('sticky-issue-notes');
            textarea.value = currentIssueNoteContext.originalText || '';
        };
    }

    if (saveBtn) {
        saveBtn.onclick = () => {
            if (!currentIssueNoteContext) return;
            const { notes, storeKey, issue } = currentIssueNoteContext;
            const textarea = document.getElementById('sticky-issue-notes');
            const newText = textarea.value || '';

            notes[issue.id.toString()] = newText;
            saveIssuesNotes(storeKey, notes);

            closeModal();

            if (window.projectDataStore) {
                const flat = flattenTasks(window.projectDataStore.tasks || []);
                renderIssuesKanban(window.projectDataStore, flat);
            }
        };
    }
}

function openIssueStickyNote(issue, notes, storeKey) {
    const modal = document.getElementById('issue-sticky-note');
    if (!modal) return;

    const titleEl = document.getElementById('sticky-issue-task');
    const parentEl = document.getElementById('sticky-issue-parent');
    const textEl = document.getElementById('sticky-issue-text');
    const notesEl = document.getElementById('sticky-issue-notes');
    const statusPill = document.getElementById('sticky-status-pill');

    const noteKey = issue.id.toString();
    const existingNote = notes[noteKey] || '';

    titleEl.textContent = issue.taskName;
    parentEl.textContent = issue.parentName ? `Padre: ${issue.parentName}` : '';
    textEl.textContent = issue.issueText;
    notesEl.value = existingNote;

    statusPill.textContent = issue.status || 'Abierto';
    statusPill.className =
        'inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wide border ' +
        statusPillClasses(issue.status);

    currentIssueNoteContext = {
        issue,
        notes,
        storeKey,
        originalText: existingNote
    };

    modal.classList.remove('hidden');
}


function getPresenterNoteKey(projectName, panelId) {
    const safeName = (projectName || 'default').toLowerCase().replace(/[^a-z0-9]+/g, '_');
    return 'blatorh_presenter_notes_' + safeName + '_' + panelId;
}

function getCurrentProjectNameForPresenter() {
    if (window.projectDataStore && projectDataStore.name) {
        return projectDataStore.name;
    }
    return 'default';
}

function loadPresenterNote(projectName, panelId) {
    const key = getPresenterNoteKey(projectName, panelId);
    return localStorage.getItem(key) || '';
}

function savePresenterNote(projectName, panelId, text) {
    const key = getPresenterNoteKey(projectName, panelId);
    if (text && text.trim()) {
        safeSetItem(key, text);
    } else {
        localStorage.removeItem(key);
    }
}


function initPresenterMode() {
    const toggleBtn = document.getElementById('presenter-mode-toggle');
    const panel = document.getElementById('presenter-panel');
    const body = document.getElementById('presenter-panel-body');

    if (!toggleBtn || !panel || !body || typeof PANELS_CONFIG === 'undefined') return;

    if (!presenterModeInitialized) {
        toggleBtn.addEventListener('click', () => {
            const isOpen = panel.classList.toggle('is-open');
            if (isOpen) {
                toggleBtn.classList.add('text-[--bl-dorado]');
            } else {
                toggleBtn.classList.remove('text-[--bl-dorado]');
            }
        });

        const closeBtn = document.getElementById('presenter-close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                panel.classList.remove('is-open');
                toggleBtn.classList.remove('text-[--bl-dorado]');
            });
        }

        const saveBtn = document.getElementById('presenter-save-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                const projectName = getCurrentProjectNameForPresenter();
                const textareas = body.querySelectorAll('textarea[data-panel-id]');
                textareas.forEach(textarea => {
                    const panelId = textarea.dataset.panelId;
                    const text = textarea.value || '';
                    savePresenterNote(projectName, panelId, text);
                });
                refreshPresenterMicIcons();
            });
        }

        initPresenterNoteModal();

        presenterModeInitialized = true;
    }

    const projectName = getCurrentProjectNameForPresenter();
    const visibilityState = typeof loadPanelVisibilityState === 'function'
        ? loadPanelVisibilityState()
        : null;

    body.innerHTML = '';

    Object.entries(PANELS_CONFIG).forEach(([panelId, panelLabel]) => {
        if (visibilityState && visibilityState[panelId] === false) {
            return;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'border border-white/10 rounded-lg p-3';

        const title = document.createElement('p');
        title.className = 'text-[11px] font-semibold text-[--bl-dorado] mb-1';
        title.textContent = panelLabel;
        wrapper.appendChild(title);

        const textarea = document.createElement('textarea');
        textarea.className = 'w-full text-xs rounded-md bg-[#020617] border border-white/20 text-white px-2 py-1.5 resize-none focus:outline-none focus:ring-1 focus:ring-[--bl-dorado] transition-all placeholder:italic';
        textarea.rows = 4;
        textarea.dataset.panelId = panelId;

        const existing = loadPresenterNote(projectName, panelId);
        if (existing) {
            textarea.value = existing;
        } else {
            textarea.placeholder = '¬øQu√© dir√°s en la presentaci√≥n sobre este panel?';
        }

        textarea.addEventListener('input', () => {
            const text = textarea.value || '';
            const key = getPresenterNoteKey(projectName, panelId);
            if (presenterDebounceTimers[key]) {
                clearTimeout(presenterDebounceTimers[key]);
            }
            presenterDebounceTimers[key] = setTimeout(() => {
                savePresenterNote(projectName, panelId, text);
                refreshPresenterMicIcons();
            }, 500);
        });

        wrapper.appendChild(textarea);
        body.appendChild(wrapper);
    });

    refreshPresenterMicIcons();
}

function initPresenterNoteModal() {
    if (presenterNoteModalInitialized) return;

    const modal = document.getElementById('presenter-note-modal');
    if (!modal) return;

    const closeBtn = document.getElementById('presenter-note-close');

    const hide = () => {
        modal.classList.add('hidden');
    };

    if (closeBtn) {
        closeBtn.addEventListener('click', hide);
    }

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hide();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hide();
        }
    });

    presenterNoteModalInitialized = true;
}

function refreshPresenterMicIcons() {
    if (typeof PANELS_CONFIG === 'undefined') return;
    const projectName = getCurrentProjectNameForPresenter();

    Object.entries(PANELS_CONFIG).forEach(([panelId, panelLabel]) => {
        const panelEl = document.getElementById(panelId);
        if (!panelEl) return;

        panelEl.classList.add('relative');

        let micBtn = panelEl.querySelector('.presenter-mic-icon');
        const note = loadPresenterNote(projectName, panelId).trim();

        if (!note) {
            if (micBtn) micBtn.remove();
            return;
        }

        if (!micBtn) {
            micBtn = document.createElement('button');
            micBtn.type = 'button';
            micBtn.className = 'presenter-mic-icon no-export absolute top-2 right-2 p-1 rounded-full bg-black/40 border border-[--bl-dorado]/60 hover:bg-black/70 transition flex items-center justify-center';
            micBtn.innerHTML = '<i data-lucide="mic" class="w-3 h-3 text-[--bl-dorado]"></i>';
            panelEl.appendChild(micBtn);
        }

        micBtn.setAttribute('data-tooltip-text', note);
        micBtn.setAttribute('title', 'Nota del PM');

        micBtn.ondblclick = (e) => {
            e.stopPropagation();
            showPresenterNoteModal(panelLabel, note);
        };
    });

    if (window.lucide && typeof lucide.createIcons === 'function') {
        lucide.createIcons();
    }
}

function showPresenterNoteModal(panelLabel, note) {
    const modal = document.getElementById('presenter-note-modal');
    if (!modal) {
        alert(note);
        return;
    }
    const labelEl = document.getElementById('presenter-note-panel-label');
    const contentEl = document.getElementById('presenter-note-content');

    if (labelEl) {
        labelEl.textContent = panelLabel;
    }
    if (contentEl) {
        contentEl.textContent = note;
    }

    modal.classList.remove('hidden');
}
// --- FIN Kanban de Issues ---

function processAndRenderDashboard(data, previousData = null) {
        const today = new Date();
        const startDate = new Date(data.startDate);
        const baselineEndDate = new Date(data.baselineEndDate);
        const flatTaskList = flattenTasks(data.tasks);
        renderIssuesKanban(data, flatTaskList);
        initPresenterMode();
        const executableTasks = flatTaskList.filter(t => !t.isSummary);
        const { projectedEndDate, spi } = calculateKPIs(executableTasks, startDate, baselineEndDate, today);
        const daysRemaining = Math.max(0, Math.ceil((baselineEndDate - today) / (1000 * 60 * 60 * 24)));
        const taskStats = {
            completed: executableTasks.filter(t => t.percentComplete === 100),
            inProgress: executableTasks.filter(t => t.percentComplete > 0 && t.percentComplete < 100),
            notStarted: executableTasks.filter(t => t.percentComplete === 0),
            overdue: executableTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100),
        };
        updateReportDateTime();
        populateSummary(data, projectedEndDate, daysRemaining);
        const overallProgress = executableTasks.length > 0 ? Math.round(executableTasks.reduce((acc, task) => acc + task.percentComplete, 0) / executableTasks.length) : 0;
        const timeProgress = (baselineEndDate - startDate) > 0 ? Math.min(100, Math.round(((today - startDate) / (baselineEndDate - startDate)) * 100)) : 0;
        renderGauges(overallProgress, timeProgress);
        renderSPI(spi);
        renderRagStatus(projectedEndDate, baselineEndDate, taskStats.overdue.length, executableTasks.length);
        setupGlobalTooltips();
        renderTaskStats(taskStats);
        setupGanttFilters(data.startDate, data.baselineEndDate);
        setupUpcomingTasksFilter();
        filterAndRenderViews();
        renderUpcomingTasks(7, 'all');
        setupBurnUpFilters(data.startDate, data.baselineEndDate);
        filterAndRenderBurnup(executableTasks);
        renderResourceLoadChart(executableTasks, data.resources);
        renderMilestoneTimeline(flatTaskList);
        // PASO 1: Reemplazar renderCriticalPath
        renderCriticalPath(executableTasks);
        // FIN PASO 1
        renderFocoCritico(executableTasks, today);
        renderRisks(executableTasks, today);
        if (previousData) {
            renderTrendAnalysis(data, previousData);
        }
        addExportFunctionality({ ...data, tasks: flatTaskList });
        const ragStates = getRagStates(projectedEndDate, baselineEndDate, taskStats.overdue.length, executableTasks.length);
        const criticalFocusCount = calculateFocoCriticoCount(executableTasks, today);
        renderExecutiveAlerts({ spi: spi, overdueCount: taskStats.overdue.length, criticalCount: criticalFocusCount, ragTime: ragStates.time, ragTasks: ragStates.tasks });

        // Aplicar visibilidad de paneles guardada
        setTimeout(() => {
            initializePanelVisibilityFeature();
            applyPanelVisibility();
        }, 100);
    }
    function calculateKPIs(executableTasks, startDate, baselineEndDate, today) { const overallProgress = executableTasks.length > 0 ? Math.round(executableTasks.reduce((acc, task) => acc + task.percentComplete, 0) / executableTasks.length) : 0; const timeProgress = (baselineEndDate - startDate) > 0 ? Math.min(100, Math.round(((today - startDate) / (baselineEndDate - startDate)) * 100)) : 0; const performanceFactor = timeProgress > 0 ? (overallProgress / timeProgress) : 1; const totalPlannedDuration = (baselineEndDate - startDate) / (1000 * 60 * 60 * 24); const projectedDuration = totalPlannedDuration / (performanceFactor || 1); const projectedEndDate = new Date(startDate.getTime() + projectedDuration * 1000 * 60 * 60 * 24); const EV = executableTasks.filter(t => t.percentComplete === 100).length; const PV = executableTasks.filter(t => new Date(t.end) <= today).length; const spi = (PV > 0) ? (EV / PV) : 1.00; return { projectedEndDate, spi, overallProgress }; }
    function populateSummary(data, projectedEndDate, daysRemaining) { document.getElementById('projectName').textContent = data.name; document.getElementById('projectManager').textContent = `Project Manager: ${data.projectManager}`; document.getElementById('startDate').textContent = formatDate(data.startDate); document.getElementById('baselineEndDate').textContent = formatDate(data.baselineEndDate); document.getElementById('projectedEndDate').textContent = formatDate(projectedEndDate); document.getElementById('daysRemaining').textContent = daysRemaining; }
    function updateReportDateTime() { const now = new Date(); const day = String(now.getDate()).padStart(2, '0'); const month = String(now.getMonth() + 1).padStart(2, '0'); const year = String(now.getFullYear()).slice(-2); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes}`; const reportDateEl = document.getElementById('report-date'); if(reportDateEl) { reportDateEl.textContent = `Generado el: ${formattedDateTime}`; } }
    function renderGauges(progress, time) { document.getElementById('progressChart').innerHTML = ''; document.getElementById('timeChart').innerHTML = ''; const gaugeOptions = (series, label, chartId) => ({ chart: { id: chartId, type: 'radialBar', height: 250, sparkline: { enabled: true } }, plotOptions: { radialBar: { hollow: { size: '70%' }, track: { background: 'rgba(255, 255, 255, 0.1)' }, dataLabels: { name: { offsetY: -10, color: 'var(--bl-dorado)', fontFamily: 'Bebas Neue', fontSize: '20px' }, value: { offsetY: 5, color: '#FFFFFF', fontFamily: 'Exo', fontSize: '24px', formatter: val => val + "%" } } } }, fill: { colors: ['var(--bl-dorado)'] }, stroke: { lineCap: 'round' }, series: [series], labels: [label] }); new ApexCharts(document.querySelector("#progressChart"), gaugeOptions(progress, 'Progreso General', 'progressChart')).render(); new ApexCharts(document.querySelector("#timeChart"), gaugeOptions(time, 'Tiempo Transcurrido', 'timeChart')).render(); }
    function renderSPI(spi) { const container = document.getElementById('spiValueContainer'); let colorClass = 'text-green-400'; if (spi < 0.9) { colorClass = 'text-red-400'; } else if (spi <= 0.98) { colorClass = 'text-yellow-400'; } container.innerHTML = `<div class="text-center"><p class="font-display text-7xl ${colorClass}">${spi.toFixed(2)}</p></div>`; }
    function renderRagStatus(projectedEndDate, baselineEndDate, overdueTasksCount, totalTasks) { const container = document.getElementById('ragStatusContainer'); container.innerHTML = ''; const { time: timeStatus, tasks: tasksStatus } = getRagStates(projectedEndDate, baselineEndDate, overdueTasksCount, totalTasks); let timeColor, timeTooltip, tasksColor, tasksTooltip; if (timeStatus === 'Red') { timeColor = 'bg-red-500'; timeTooltip = "<b>Estado del Tiempo: Rojo</b><br>Riesgo Alto. El proyecto tiene un retraso significativo (m√°s de 14 d√≠as)."; } else if (timeStatus === 'Amber') { timeColor = 'bg-yellow-500'; timeTooltip = "<b>Estado del Tiempo: √Åmbar</b><br>Atenci√≥n. Hay un ligero retraso (hasta 14 d√≠as) sobre la fecha planificada."; } else { timeColor = 'bg-green-500'; timeTooltip = "<b>Estado del Tiempo: Verde</b><br>¬°Excelente! El proyecto est√° en camino de terminar en la fecha original o antes."; } if (tasksStatus === 'Red') { tasksColor = 'bg-red-500'; tasksTooltip = "<b>Estado de Tareas: Rojo</b><br>Problema. M√°s del 10% del total de las tareas est√°n atrasadas."; } else if (tasksStatus === 'Amber') { tasksColor = 'bg-yellow-500'; tasksTooltip = "<b>Estado de Tareas: √Åmbar</b><br>Precauci√≥n. Hay tareas atrasadas, pero representan menos del 10% del total."; } else { tasksColor = 'bg-green-500'; tasksTooltip = "<b>Estado de Tareas: Verde</b><br>¬°Perfecto! No hay ninguna tarea atrasada en el proyecto."; } const createRagItem = (color, label, tooltipText) => ` <div class="text-center cursor-pointer" data-tooltip-text="${tooltipText.replace(/"/g, '&quot;')}"> <div class="w-16 h-16 rounded-full ${color} mx-auto mb-2 border-4 border-white/20 pointer-events-none"></div> <h4 class="font-display text-xl pointer-events-none">${label}</h4> </div>`; container.innerHTML = createRagItem(timeColor, 'Tiempo', timeTooltip) + createRagItem(tasksColor, 'Tareas', tasksTooltip); }
    function setupGlobalTooltips() { const tooltip = document.getElementById('gantt-tooltip'); document.body.addEventListener('mousemove', (e) => { const target = e.target.closest('[data-tooltip-text]'); if (target) { tooltip.style.display = 'block'; tooltip.style.left = `${e.clientX + 15}px`; tooltip.style.top = `${e.clientY + 15}px`; tooltip.innerHTML = target.dataset.tooltipText; } else { const ganttBar = e.target.closest('.gantt-bar, .gantt-milestone'); if(!ganttBar) { tooltip.style.display = 'none'; } } }); document.body.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; }); }

    // Paso 4A: Modificar renderTaskStats
    function renderTaskStats(stats) {
        const createTaskCard = (id, count, label, icon, colorClass, taskList) => {
            const card = document.getElementById(id);
            const hasTasks = taskList && taskList.length > 0;

            card.innerHTML = `
                <i data-lucide="${icon}" class="w-8 h-8 mx-auto mb-2 ${colorClass}"></i>
                <p class="font-display text-4xl text-white">${count}</p>
                <h4 class="font-display text-lg ${colorClass}">${label}</h4>
                ${hasTasks ? '<p class="text-xs text-white/60 mt-1">Doble clic para ver detalles</p>' : ''}
            `;

            // Agregar tooltip con preview de primeras 3 tareas y su ruta
            if (hasTasks) {
                const previewTasks = taskList.slice(0, 3);
                const tooltipContent = previewTasks.map(t =>
                    `<div class="text-left"><strong>${t.name}</strong>${formatTaskPath(t, false)}</div>`
                ).join('<hr class="my-1 border-white/20">');

                card.dataset.tooltipText = `<div class="space-y-1">${tooltipContent}${taskList.length > 3 ? `<div class="text-center mt-2 text-white/60">+${taskList.length - 3} m√°s</div>` : ''}</div>`;
            }
        };

        createTaskCard('completedTasksCard', stats.completed.length, 'Completadas', 'check-circle-2', 'text-green-400', stats.completed);
        createTaskCard('inProgressTasksCard', stats.inProgress.length, 'En Progreso', 'loader-2', 'text-blue-400', stats.inProgress);
        createTaskCard('notStartedTasksCard', stats.notStarted.length, 'Por Iniciar', 'circle-dashed', 'text-gray-400', stats.notStarted);
        createTaskCard('overdueTasksCard', stats.overdue.length, 'Atrasadas', 'alert-triangle', 'text-red-400', stats.overdue);

        lucide.createIcons();

        // Event listeners para doble clic (ya existentes)
        document.getElementById('inProgressTasksCard').addEventListener('dblclick', () => showTaskModal('Tareas en Progreso', stats.inProgress));
        document.getElementById('notStartedTasksCard').addEventListener('dblclick', () => showTaskModal('Tareas por Iniciar', stats.notStarted));
        document.getElementById('overdueTasksCard').addEventListener('dblclick', () => showTaskModal('Tareas Atrasadas', stats.overdue));
    }

    function setupGanttFilters(projectStart, projectEnd) { const startDateInput = document.getElementById('ganttStartDate'); const endDateInput = document.getElementById('ganttEndDate'); startDateInput.value = new Date(projectStart).toISOString().split('T')[0]; endDateInput.value = new Date(projectEnd).toISOString().split('T')[0]; document.getElementById('regenerateGantt').addEventListener('click', filterAndRenderViews); const resourceFilter = document.getElementById('gantt-resource-filter'); resourceFilter.innerHTML = '<option value="all">Todos los Recursos</option>'; const resourceNames = new Set(); projectDataStore.resources.forEach(res => resourceNames.add(res.name)); [...resourceNames].sort().forEach(name => { if (name) { const option = document.createElement('option'); option.value = name; option.textContent = name; resourceFilter.appendChild(option); } }); document.getElementById('gantt-search').addEventListener('input', (e) => { ganttSearchTerm = e.target.value.toLowerCase(); filterAndRenderViews(); }); resourceFilter.addEventListener('change', (e) => { ganttResourceFilter = e.target.value; filterAndRenderViews(); }); document.querySelectorAll('#gantt-isolation-filter .gantt-view-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelector('#gantt-isolation-filter .gantt-view-btn.active').classList.remove('active'); btn.classList.add('active'); ganttIsolationFilter = btn.dataset.filter; filterAndRenderViews(); }); }); document.querySelectorAll('#gantt-timescale-toggle .gantt-view-btn').forEach(btn => { btn.addEventListener('click', () => { ganttViewMode = btn.dataset.view; document.querySelector('#gantt-timescale-toggle .gantt-view-btn.active').classList.remove('active'); btn.classList.add('active'); filterAndRenderViews(); }); }); document.querySelectorAll('#gantt-main-view-toggle .gantt-view-btn').forEach(btn => { btn.addEventListener('click', () => { ganttMainView = btn.dataset.view; document.querySelector('#gantt-main-view-toggle .gantt-view-btn.active').classList.remove('active'); btn.classList.add('active'); const isGantt = ganttMainView === 'gantt'; document.getElementById('gantt-controls').style.display = isGantt ? 'flex' : 'none'; document.getElementById('expandAll').style.display = isGantt ? 'inline-flex' : 'none'; document.getElementById('collapseAll').style.display = isGantt ? 'inline-flex' : 'none'; document.getElementById('gantt-chart-container').style.display = isGantt ? 'grid' : 'none'; document.getElementById('network-diagram-container').style.display = isGantt ? 'none' : 'block'; filterAndRenderViews(); }); }); document.getElementById('expandAll').addEventListener('click', () => { toggleAll(projectDataStore.tasks, false); filterAndRenderViews(); }); document.getElementById('collapseAll').addEventListener('click', () => { toggleAll(projectDataStore.tasks, true); filterAndRenderViews(); }); }
    function toggleAll(tasks, collapse) { tasks.forEach(task => { if (task.isSummary) { task.isCollapsed = collapse; if (task.children) { toggleAll(task.children, collapse); } } }); }
    function filterAndRenderViews() { if (!projectDataStore.tasks) return; let filteredTree = applyAdvancedFilters(projectDataStore.tasks); if (ganttMainView === 'gantt') { const filterStart = new Date(document.getElementById('ganttStartDate').value); const filterEnd = new Date(document.getElementById('ganttEndDate').value); let dateFilteredTree = filterTaskTree(filteredTree, filterStart, filterEnd); renderGanttChart(dateFilteredTree); } else { renderNetworkDiagram(filteredTree); } }
    
    // PASO 2B: Modificar applyAdvancedFilters
function calculateTaskDelayStatus(task, today) {
    const baselineEnd = new Date(task.baselineFinish);
    const totalDuration = (new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24);
    const elapsedDuration = (today - new Date(task.start)) / (1000 * 60 * 60 * 24);
    const plannedProgress = Math.min(100, Math.max(0, (elapsedDuration / totalDuration) * 100));
    const daysOverdue = Math.ceil((today - baselineEnd) / (1000 * 60 * 60 * 24));

    return {
        isDelayed: task.percentComplete < plannedProgress || (daysOverdue > 0 && task.percentComplete < 100),
        daysOverdue: daysOverdue,
        plannedProgress: Math.round(plannedProgress)
    };
}

function applyAdvancedFilters(taskTree) {
    const resourceMap = projectDataStore.resources;
    const today = new Date();

    function filterNode(node) {
        const nameMatch = ganttSearchTerm ? node.name.toLowerCase().includes(ganttSearchTerm) : true;
        const resourceMatch = (ganttResourceFilter === 'all') ? true : node.resourceIds.some(id => resourceMap.get(id)?.name === ganttResourceFilter);

        let isolationMatch = true;
        if (ganttIsolationFilter === 'critical' && !node.isCritical) {
            isolationMatch = false;
        } else if (ganttIsolationFilter === 'milestones' && !node.isMilestone) {
            isolationMatch = false;
        } else if (ganttIsolationFilter === 'delayed') {
            const delayStatus = calculateTaskDelayStatus(node, today);
            isolationMatch = delayStatus.isDelayed && !node.isSummary;
        }

        let filteredChildren = [];
        if (node.children && node.children.length > 0) {
            filteredChildren = node.children.map(filterNode).filter(child => child !== null);
        }

        if (ganttIsolationFilter === 'delayed') {
            if (isolationMatch || filteredChildren.length > 0) {
                return { ...node, children: filteredChildren };
            }
        } else {
            if ((nameMatch && resourceMatch && isolationMatch) || filteredChildren.length > 0) {
                return { ...node, children: filteredChildren };
            }
        }
        return null;
    }

    return taskTree.map(filterNode).filter(node => node !== null);
}
// FIN PASO 2B

    
    function filterTaskTree(tasks, rangeStart, rangeEnd) { const filtered = []; tasks.forEach(task => { const taskStart = new Date(task.start); const taskEnd = new Date(task.end); let children = []; if (task.children && task.children.length > 0) { children = filterTaskTree(task.children, rangeStart, rangeEnd); } const intersects = (taskEnd >= rangeStart && taskStart <= rangeEnd); if (intersects || children.length > 0) { filtered.push({ ...task, children: children }); } }); return filtered; }
    function renderGanttChart(taskTree) { const container = document.getElementById('gantt-chart-container'); container.innerHTML = ` <div class="border-b border-r border-white/10 text-sm font-semibold flex items-center justify-center text-white/80 p-2">Tarea</div> <div id="gantt-timeline-header-wrapper" class="overflow-hidden border-b border-white/10"> <div id="gantt-timeline-header" class="h-[64px] relative"></div> </div> <div id="gantt-task-list" class="overflow-y-auto overflow-x-hidden border-r border-white/10"></div> <div id="gantt-timeline-wrapper" class="overflow-auto relative"> <div id="gantt-timeline" class="relative"></div> </div> `; const taskListEl = document.getElementById('gantt-task-list'); const timelineWrapperEl = document.getElementById('gantt-timeline-wrapper'); const timelineHeaderWrapperEl = document.getElementById('gantt-timeline-header-wrapper'); const timelineHeaderEl = document.getElementById('gantt-timeline-header'); const timelineEl = document.getElementById('gantt-timeline'); const filterStart = new Date(document.getElementById('ganttStartDate').value); const filterEnd = new Date(document.getElementById('ganttEndDate').value); const tooltip = document.getElementById('gantt-tooltip'); const DAY_WIDTH = 40; const WEEK_WIDTH = 60; const ROW_HEIGHT = 32; const unitWidth = ganttViewMode === 'day' ? DAY_WIDTH : WEEK_WIDTH; timelineHeaderEl.innerHTML = ''; if (ganttViewMode === 'day') { renderDayHeader(timelineHeaderEl, filterStart, filterEnd); } else { renderWeekHeader(timelineHeaderEl, filterStart, filterEnd); } let visibleRowCount = 0; function renderRows(tasks, parentIsCollapsed = false) { tasks.forEach(task => { const isCollapsed = task.isSummary && (task.isCollapsed === undefined ? true : task.isCollapsed); const isHidden = parentIsCollapsed; if (!isHidden) { const taskStart = new Date(task.start); const taskEnd = new Date(task.end); const keywordMilestone = /hito|sign off|entrega|fin/i.test(task.name); const isVisuallyMilestone = task.isMilestone || (taskStart.getTime() === taskEnd.getTime()) || keywordMilestone; const taskRow = document.createElement('div'); taskRow.className = 'gantt-row flex items-center text-sm px-2'; taskRow.style.paddingLeft = `${(task.outlineLevel - 1) * 20 + 8}px`; let toggleIcon = task.isSummary ? `<i data-lucide="chevron-down" class="toggle-btn shrink-0 mr-1 ${isCollapsed ? 'collapsed' : ''}"></i>` : (isVisuallyMilestone ? '<span class="text-[--bl-dorado] w-4 mr-1 text-center font-bold">‚óÜ</span>' : `<span class="w-4 mr-1"></span>`); taskRow.innerHTML = `${toggleIcon}<span class="gantt-task-name ${task.isSummary ? 'summary-task' : ''}" title="${task.name}">${task.name}</span>`; taskListEl.appendChild(taskRow); if (task.isSummary) { taskRow.querySelector('.toggle-btn').addEventListener('click', (e) => { e.stopPropagation(); task.isCollapsed = !isCollapsed; filterAndRenderViews(); }); } const offset = ganttViewMode === 'day' ? (taskStart - filterStart) / (1000 * 60 * 60 * 24) : (taskStart - filterStart) / (1000 * 60 * 60 * 24 * 7); let barContainer; if (isVisuallyMilestone) { barContainer = document.createElement('div'); barContainer.className = 'gantt-milestone'; barContainer.style.left = `${offset * unitWidth + (unitWidth / 2) - 8}px`; } else { const MS_DAY = 1000 * 60 * 60 * 24; const MS_WEEK = MS_DAY * 7; const unitMS = (ganttViewMode === 'day') ? MS_DAY : MS_WEEK; const chartStart = new Date(filterStart); const chartEnd = new Date(filterEnd); const visStart = (taskStart < chartStart) ? chartStart : taskStart; const visEnd = (taskEnd > chartEnd) ? chartEnd : taskEnd; if (visEnd < chartStart || visStart > chartEnd) { barContainer = document.createElement('div'); barContainer.className = 'gantt-bar'; barContainer.style.left = `0px`; barContainer.style.width = `0px`; } else { const barUnits = (visEnd - visStart) / unitMS; const barOffset = (visStart - chartStart) / unitMS; const barWidthPx = Math.max(0.001, barUnits * unitWidth); const progFrac = Math.max(0, Math.min(1, (task.percentComplete || 0) / 100)); const totalUnits = (taskEnd - taskStart) / unitMS; const progressAbsUnits = (taskStart - chartStart) / unitMS + totalUnits * progFrac; const barLeftUnits = (visStart - chartStart) / unitMS; const barRightUnits = (visEnd - chartStart) / unitMS; const clampedProgressUnits = Math.min(Math.max(progressAbsUnits, barLeftUnits), barRightUnits); const absMarkerPx = (clampedProgressUnits - barLeftUnits) * unitWidth; const absProgPx = Math.max(0, Math.min(barWidthPx, absMarkerPx)); const taskStartUnits = (taskStart - chartStart) / unitMS; const taskEndUnits = (taskEnd - chartStart) / unitMS; const visTaskStartUnits = Math.max(taskStartUnits, 0); const visTaskEndUnits = Math.min(taskEndUnits, (chartEnd - chartStart) / unitMS); const visibleTaskUnits = Math.max(0, visTaskEndUnits - visTaskStartUnits); const progressVisEndUnits = Math.min(Math.max(progressAbsUnits, visTaskStartUnits), visTaskEndUnits); const rel = visibleTaskUnits > 0 ? (progressVisEndUnits - visTaskStartUnits) / visibleTaskUnits : 0; const visMarkerPx = rel * barWidthPx; const visProgPx = visMarkerPx; const markerPx = absMarkerPx; const progPx = absProgPx; barContainer = document.createElement('div'); barContainer.className = 'gantt-bar'; barContainer.style.left = `${barOffset * unitWidth}px`; barContainer.style.width = `${barWidthPx}px`; const track = document.createElement('div'); track.className = (task.isSummary) ? 'absolute top-0 left-0 w-full h-full rounded-md gantt-track-summary' : 'absolute top-0 left-0 w-full h-full rounded-md bg-gray-700'; barContainer.appendChild(track); const delayStatus = calculateTaskDelayStatus(task, new Date()); const isSignificantlyDelayed = delayStatus.isDelayed && delayStatus.daysOverdue > 0; let colorClass; if (task.isSummary) { colorClass = 'bg-[--bl-dorado]'; } else if (isSignificantlyDelayed) { colorClass = 'bg-red-600'; } else if (progFrac < 0.25) { colorClass = 'bg-red-500'; } else if (progFrac < 0.50) { colorClass = 'bg-amber-500'; } else if (progFrac < 0.75) { colorClass = 'bg-blue-500'; } else { colorClass = 'bg-green-500'; } if (isSignificantlyDelayed && barWidthPx < 30) { barContainer.style.minWidth = '30px'; barContainer.style.zIndex = '10'; barContainer.style.border = '2px solid #dc2626'; } if (isSignificantlyDelayed) { barContainer.classList.add('delayed-task'); } const progress = document.createElement('div'); progress.className = `gantt-progress ${colorClass} ${task.isSummary ? 'gantt-progress-summary' : ''}`.trim(); progress.style.width = `${progPx}px`; barContainer.appendChild(progress); const marker = document.createElement('div'); marker.className = 'gantt-progress-marker'; marker.style.left = `${Math.max(0, Math.min(barWidthPx - 2, (typeof markerPx!=='undefined'?markerPx:progPx) - 1))}px`; barContainer.appendChild(marker); const badge = document.createElement('span'); badge.className = 'gantt-percent-badge'; badge.textContent = `${task.percentComplete}%`; const badgeWidthGuess = 34; const padding = 6; const preferRight = (progPx + badgeWidthGuess + padding) <= barWidthPx; badge.style.left = preferRight ? `${progPx + padding}px` : `${Math.max(0, progPx - badgeWidthGuess - padding)}px`; barContainer.appendChild(badge); } } barContainer.style.top = `${visibleRowCount * ROW_HEIGHT}px`; timelineEl.appendChild(barContainer); barContainer.addEventListener('mousemove', e => { tooltip.style.display = 'block'; tooltip.style.left = `${e.clientX + 15}px`; tooltip.style.top = `${e.clientY + 15}px`; let tooltipContent = `<strong>${task.name}</strong>${formatTaskPath(task, true)}`; if (!isVisuallyMilestone) { tooltipContent += `<br>Fin: ${formatDate(task.end)}<br>Avance: ${task.percentComplete}%`; } tooltip.innerHTML = tooltipContent; }); barContainer.addEventListener('mouseleave', () => tooltip.style.display = 'none'); visibleRowCount++; } if (task.children && task.children.length > 0) { renderRows(task.children, isHidden || isCollapsed); } }); } renderRows(taskTree); const totalHeight = visibleRowCount * ROW_HEIGHT; taskListEl.style.height = `${totalHeight}px`; timelineEl.style.height = `${totalHeight}px`; let isSyncingScroll = false; timelineWrapperEl.addEventListener('scroll', () => { if (isSyncingScroll) return; isSyncingScroll = true; taskListEl.scrollTop = timelineWrapperEl.scrollTop; timelineHeaderWrapperEl.scrollLeft = timelineWrapperEl.scrollLeft; isSyncingScroll = false; }); taskListEl.addEventListener('scroll', () => { if (isSyncingScroll) return; isSyncingScroll = true; timelineWrapperEl.scrollTop = taskListEl.scrollTop; isSyncingScroll = false; }); lucide.createIcons(); }
    function renderDayHeader(headerEl, filterStart, filterEnd) { const totalDays = Math.max(0, Math.round((filterEnd - filterStart) / (1000 * 60 * 60 * 24))); const chartWidth = totalDays * 40; headerEl.style.width = `${chartWidth}px`; const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]; const monthsEl = document.createElement('div'); monthsEl.className = 'flex gantt-row'; const daysEl = document.createElement('div'); daysEl.className = 'flex gantt-row'; headerEl.appendChild(monthsEl); headerEl.appendChild(daysEl); let currentMonth = -1; let monthDayCount = 0; let lastMonthDiv = null; for (let i = 0; i <= totalDays; i++) { const date = new Date(filterStart); date.setUTCDate(date.getUTCDate() + i); const month = date.getUTCMonth(); const dayDiv = document.createElement('div'); dayDiv.className = 'shrink-0 text-center text-xs text-white/60 border-r border-white/10 flex items-center justify-center'; dayDiv.style.width = '40px'; dayDiv.textContent = date.getUTCDate(); daysEl.appendChild(dayDiv); if (month !== currentMonth) { if (lastMonthDiv) lastMonthDiv.style.width = `${monthDayCount * 40}px`; monthDayCount = 0; currentMonth = month; const monthName = `${monthNames[month]} ${date.getUTCFullYear()}`; const monthDiv = document.createElement('div'); monthDiv.className = 'shrink-0 border-r border-white/10 text-center font-semibold text-sm flex items-center justify-center'; monthDiv.textContent = monthName; monthsEl.appendChild(monthDiv); lastMonthDiv = monthDiv; } monthDayCount++; } if (lastMonthDiv) lastMonthDiv.style.width = `${monthDayCount * 40}px`; }
    function renderWeekHeader(headerEl, filterStart, filterEnd) { const totalWeeks = Math.max(0, Math.ceil(((filterEnd - filterStart) / (1000 * 60 * 60 * 24)) / 7)); const chartWidth = totalWeeks * 60; headerEl.style.width = `${chartWidth}px`; const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]; const monthsEl = document.createElement('div'); monthsEl.className = 'flex gantt-row'; const weeksEl = document.createElement('div'); weeksEl.className = 'flex gantt-row'; headerEl.appendChild(monthsEl); headerEl.appendChild(weeksEl); let currentMonth = -1; let monthWeekCount = 0; let lastMonthDiv = null; let weekStartDate = new Date(filterStart); while (weekStartDate < filterEnd) { const month = weekStartDate.getUTCMonth(); const weekDiv = document.createElement('div'); weekDiv.className = 'shrink-0 text-center text-xs text-white/60 border-r border-white/10 flex items-center justify-center'; weekDiv.style.width = '60px'; weekDiv.textContent = `S${getWeekNumber(weekStartDate)}`; weeksEl.appendChild(weekDiv); if (month !== currentMonth) { if (lastMonthDiv) lastMonthDiv.style.width = `${monthWeekCount * 60}px`; monthWeekCount = 0; currentMonth = month; const monthName = `${monthNames[month]} ${weekStartDate.getUTCFullYear()}`; const monthDiv = document.createElement('div'); monthDiv.className = 'shrink-0 border-r border-white/10 text-center font-semibold text-sm flex items-center justify-center'; monthDiv.textContent = monthName; monthsEl.appendChild(monthDiv); lastMonthDiv = monthDiv; } monthWeekCount++; weekStartDate.setUTCDate(weekStartDate.getUTCDate() + 7); } if (lastMonthDiv) lastMonthDiv.style.width = `${monthWeekCount * 60}px`; }
    function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7); return weekNo; }
    
    // PASO 2C: Modificar renderNetworkDiagram
    function renderNetworkDiagram(taskTree) {
        const container = document.getElementById('network-diagram-container');
        const today = new Date();

        let filteredTasks = flattenTasks(taskTree).filter(t => !t.isSummary && t.id);

        if (ganttIsolationFilter === 'critical') {
            filteredTasks = filteredTasks.filter(t => t.isCritical);
        } else if (ganttIsolationFilter === 'milestones') {
            filteredTasks = filteredTasks.filter(t => t.isMilestone);
        } else if (ganttIsolationFilter === 'delayed') {
            // Incluir tareas retrasadas y sus padres
            const delayedTasks = filteredTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100);
            const parentTasks = [];
            const allFlatTasks = flattenTasks(projectDataStore.tasks);

            delayedTasks.forEach(task => {
                const parent = allFlatTasks.find(t =>
                    t.children && t.children.some(child => child.id === task.id)
                );
                if (parent && !delayedTasks.some(dt => dt.id === parent.id) && !parentTasks.some(pt => pt.id === parent.id)) {
                    parentTasks.push(parent);
                }
            });

            filteredTasks = [...new Set([...delayedTasks, ...parentTasks])];
        }

        if (filteredTasks.length === 0) {
            container.innerHTML = '<p class="text-center text-white/50 p-8">No hay tareas que mostrar con los filtros aplicados.</p>';
            return;
        }

        const tasksMap = new Map(filteredTasks.map(t => [t.id, t]));
        const levels = new Map();
        let maxLevel = 0;

        function calculateLevel(task) {
            if (!task || !task.id) return 0;
            if (levels.has(task.id)) return levels.get(task.id);

            if (!task.predecessors || task.predecessors.length === 0) {
                levels.set(task.id, 0);
                return 0;
            }

            let maxPredLevel = 0;
            task.predecessors.forEach(p => {
                const predTask = tasksMap.get(p.uid);
                if (predTask) {
                    maxPredLevel = Math.max(maxPredLevel, calculateLevel(predTask));
                }
            });

            const level = maxPredLevel + 1;
            levels.set(task.id, level);
            maxLevel = Math.max(maxLevel, level);
            return level;
        }
        
        filteredTasks.forEach(task => calculateLevel(task));
        const nodesByLevel = Array(maxLevel + 1).fill(0).map(() => []);
        filteredTasks.forEach(task => {
            const level = levels.get(task.id);
            if (level !== undefined && nodesByLevel[level]) {
                nodesByLevel[level].push(task);
            }
        });

        const PADDING = 50;
        const NODE_WIDTH = 150;
        const NODE_HEIGHT = 60;
        const H_GAP = 80;
        const V_GAP = 40;
        const width = (maxLevel + 1) * (NODE_WIDTH + H_GAP) + PADDING * 2;
        const maxHeight = nodesByLevel.reduce((max, level) => Math.max(max, level.length), 0);
        const height = maxHeight * (NODE_HEIGHT + V_GAP) + PADDING * 2;

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);

        const nodePositions = new Map();
        let svgDefs = `<defs><marker id="arrowhead" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#fff" opacity="0.5"></path></marker></defs>`;
        let svgLinks = '';
        let svgNodes = '';

        nodesByLevel.forEach((tasksInLevel, levelIndex) => {
            const levelHeight = tasksInLevel.length * (NODE_HEIGHT + V_GAP);
            const startY = (height - levelHeight) / 2;

            tasksInLevel.forEach((task, taskIndex) => {
                const x = PADDING + levelIndex * (NODE_WIDTH + H_GAP);
                const y = startY + taskIndex * (NODE_HEIGHT + V_GAP);
                nodePositions.set(task.id, { x, y });

                const delayStatus = calculateTaskDelayStatus(task, today); let color = '#374151'; let stroke = 'rgba(255,255,255,0.2)'; if (delayStatus.isDelayed && delayStatus.daysOverdue > 0) { color = '#dc2626'; stroke = '#f87171'; } else if (task.percentComplete === 100) { color = '#16a34a'; } else if (new Date(task.end) < today && task.percentComplete < 100) { color = '#dc2626'; } else if (task.percentComplete > 0) { color = '#2563eb'; } else if (task.isMilestone) { color = 'var(--bl-dorado)'; } if (task.isCritical && !(delayStatus.isDelayed && delayStatus.daysOverdue > 0)) { stroke = '#f59e0b'; }const taskTooltip = `<strong>${task.name}</strong>${formatTaskPath(task, true)}<br>Inicio: ${formatDate(task.start)}<br>Fin: ${formatDate(task.end)}<br>Avance: ${task.percentComplete}%`;

                svgNodes += `
                    <g transform="translate(${x}, ${y})" data-tooltip-text="${taskTooltip.replace(/"/g, '&quot;')}" class="network-node">
                        <rect width="${NODE_WIDTH}" height="${NODE_HEIGHT}" rx="8" fill="${color}" stroke="${stroke}" stroke-width="2"></rect>
                        <foreignObject width="${NODE_WIDTH}" height="${NODE_HEIGHT}">
                            <div xmlns="http://www.w3.org/1999/xhtml" class="text-white p-2 text-xs overflow-hidden h-full flex flex-col justify-center">
                                <p class="font-bold whitespace-nowrap overflow-hidden text-ellipsis" title="${task.name}">${task.name}</p>
                                <p class="text-white/70">${formatDate(task.start)} - ${formatDate(task.end)}</p>
                            </div>
                        </foreignObject>
                    </g>
                `;
            });
        });

        filteredTasks.forEach(task => {
            if (task.predecessors) {
                task.predecessors.forEach(p => {
                    const predPos = nodePositions.get(p.uid);
                    const taskPos = nodePositions.get(task.id);
                    if (predPos && taskPos) {
                        const x1 = predPos.x + NODE_WIDTH;
                        const y1 = predPos.y + NODE_HEIGHT / 2;
                        const x2 = taskPos.x;
                        const y2 = taskPos.y + NODE_HEIGHT / 2;

                        const isCriticalLink = tasksMap.get(p.uid)?.isCritical && task.isCritical;
                        const stroke = isCriticalLink ? '#f59e0b' : 'rgba(255,255,255,0.5)';

                        svgLinks += `<path d="M ${x1} ${y1} C ${x1 + H_GAP / 2} ${y1}, ${x2 - H_GAP / 2} ${y2}, ${x2} ${y2}" stroke="${stroke}" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"></path>`;
                    }
                });
            }
        });

        svg.innerHTML = svgDefs + svgLinks + svgNodes;
        container.innerHTML = '';
        container.appendChild(svg);
        
        // Re-apply tooltip logic for the network diagram nodes
        container.querySelectorAll('.network-node').forEach(node => {
            node.addEventListener('mousemove', e => {
                const target = e.currentTarget.closest('[data-tooltip-text]');
                if (target) {
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                    tooltip.innerHTML = target.dataset.tooltipText;
                }
            });
            node.addEventListener('mouseleave', () => tooltip.style.display = 'none');
        });
    }
    // FIN PASO 2C
    
    function setupUpcomingTasksFilter() { const daysInput = document.getElementById('upcoming-days'); const filterButtons = document.querySelectorAll('#upcoming-task-filter .gantt-view-btn'); const updateView = () => { const days = parseInt(daysInput.value) || 7; const activeFilter = document.querySelector('#upcoming-task-filter .gantt-view-btn.active').dataset.filter; renderUpcomingTasks(days, activeFilter); }; daysInput.addEventListener('change', updateView); filterButtons.forEach(btn => { btn.addEventListener('click', () => { filterButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateView(); }); }); }

    // Paso 4D: Modificar renderUpcomingTasks
    function renderUpcomingTasks(days, filter) {
        const container = document.getElementById('upcomingTaskList');
        container.innerHTML = '';

        const today = new Date();
        const futureDate = new Date();
        futureDate.setDate(today.getDate() + days);

        let tasks = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary);
        if (filter === 'critical') tasks = tasks.filter(t => t.isCritical);
        if (filter === 'milestones') tasks = tasks.filter(t => t.isMilestone);

        const upcoming = tasks.filter(t => {
            const startDate = new Date(t.start);
            return t.percentComplete < 100 && startDate >= today && startDate <= futureDate;
        }).sort((a,b) => new Date(a.start) - new Date(b.start));

        if (upcoming.length === 0) {
            container.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="calendar-check-2" class="w-4 h-4 shrink-0 mr-2"></i>No hay tareas clave comenzando pronto.</li>`;
        } else {
            upcoming.slice(0, 10).forEach(task => {
                const item = document.createElement('li');
                item.className = 'flex items-start text-sm';

                let icon = 'calendar-plus';
                let iconColor = 'text-blue-400';
                if (task.isCritical) {
                    icon = 'alert-triangle';
                    iconColor = 'text-amber-400';
                }
                if (task.isMilestone) {
                    icon = 'award';
                    iconColor = 'text-[--bl-dorado]';
                }

                item.innerHTML = `
                    <i data-lucide="${icon}" class="w-4 h-4 shrink-0 mr-2 mt-0.5 ${iconColor}"></i>
                    <div class="flex-1 min-w-0">
                        <span class="font-semibold text-white block">${task.name}</span>
                        ${formatTaskPath(task, false)}
                        <span class="block text-white/60 text-xs">Comienza: ${formatDate(task.start)}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        lucide.createIcons();
    }

    function setupBurnUpFilters(projectStart, projectEnd) { const startDateInput = document.getElementById('burnupStartDate'); const endDateInput = document.getElementById('burnupEndDate'); startDateInput.value = new Date(projectStart).toISOString().split('T')[0]; endDateInput.value = new Date(projectEnd).toISOString().split('T')[0]; document.getElementById('regenerateBurnup').addEventListener('click', () => { const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary); filterAndRenderBurnup(flatTaskList); }); document.querySelectorAll('#burnup-view-toggle .gantt-view-btn').forEach(btn => { btn.addEventListener('click', () => { burnupViewMode = btn.dataset.view; document.querySelector('#burnup-view-toggle .gantt-view-btn.active').classList.remove('active'); btn.classList.add('active'); const flatTaskList = flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary); filterAndRenderBurnup(flatTaskList); }); }); }
    function filterAndRenderBurnup(executableTasks) { if (!executableTasks) return; const filterStart = new Date(document.getElementById('burnupStartDate').value); const filterEnd = new Date(document.getElementById('burnupEndDate').value); renderBurnUpChart(executableTasks, filterStart, filterEnd); }
    function renderBurnUpChart(tasks, startDate, endDate) { document.getElementById('burnupChart').innerHTML = ''; const burnupData = generateBurnUpData(tasks, startDate, endDate); const options = { series: [ { name: 'Plan de Finalizaci√≥n (Curva S)', data: burnupData.planned }, { name: 'Avance Real', data: burnupData.completed } ], chart: { id: 'burnupChart', type: 'area', height: 350, toolbar: { show: false }, background: 'transparent' }, dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 2 }, xaxis: { type: 'datetime', categories: burnupData.categories, labels: { style: { colors: '#FFFFFF' }, formatter: function(value, timestamp) { if (timestamp) { const date = new Date(timestamp); if (burnupViewMode === 'week') { const week = getWeekNumber(date); const month = date.toLocaleString('es-AR', { month: 'short', timeZone: 'UTC' }); const year = date.getUTCFullYear(); const capitalizedMonth = month.charAt(0).toUpperCase() + month.slice(1).replace('.',''); return `S${week} - ${capitalizedMonth} ${year}`; } return date.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', timeZone:'UTC'}); } return value; }, rotate: -45, hideOverlappingLabels: true, } }, yaxis: { labels: { style: { colors: '#FFFFFF' }, formatter: function (value) { return Math.round(value); } }, title: { text: 'N¬∫ de Tareas', style: { color: '#FFFFFF', fontWeight: 'normal'} } }, tooltip: { theme: 'dark', x: { formatter: function(value) { const date = new Date(value); return `${burnupViewMode === 'week' ? 'Semana del' : ''} ${date.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', year:'numeric', timeZone:'UTC'})}`; } } }, grid: { borderColor: 'rgba(255,255,255,0.2)' }, legend: { labels: { colors: '#FFFFFF' } }, colors: ['#FFFFFF', 'var(--bl-dorado)'] }; new ApexCharts(document.querySelector("#burnupChart"), options).render(); }
    function renderMilestoneTimeline(tasks) { const container = document.getElementById('milestoneTimeline'); container.innerHTML = ''; tasks.filter(t => t.isMilestone).forEach(milestone => { const isCompleted = milestone.percentComplete === 100; const item = document.createElement('div'); item.className = 'relative pl-8 pb-8 timeline-item'; item.innerHTML = `<div class="timeline-dot ${isCompleted ? 'completed' : ''}"></div><p class="text-sm text-white/60">${formatDate(milestone.start)}</p><h5 class="font-semibold text-white">${milestone.name}</h5>`; container.appendChild(item); }); }

    // PASO 1: Reemplazar renderCriticalPath
    function renderCriticalPath(tasks) {
        const container = document.getElementById('criticalPathList');
        container.innerHTML = '';

        const criticalTasks = tasks.filter(t => t.isCritical && !t.isMilestone);

        if (criticalTasks.length === 0) {
            container.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="check-circle-2" class="w-4 h-4 shrink-0 mr-2"></i>No hay tareas en la ruta cr√≠tica.</li>`;
        } else {
            criticalTasks.forEach(task => {
                const item = document.createElement('li');
                item.className = 'flex items-start text-sm hover:bg-white/5 rounded px-2 py-1 transition';

                item.innerHTML = `
                    <i data-lucide="link-2" class="w-4 h-4 shrink-0 mr-2 mt-0.5 text-white/50"></i>
                    <div class="flex-1 min-w-0">
                        <span class="font-semibold text-white block">${task.name}</span>
                        ${formatTaskPath(task, false)}
                        <div class="text-xs text-white/60 mt-0.5">Fin: ${formatDate(task.end)} | Avance: ${task.percentComplete}%</div>
                    </div>
                `;

                container.appendChild(item);
            });
        }
        lucide.createIcons();
    }
    // FIN PASO 1

    // Paso 4B: Modificar renderFocoCritico
    function renderFocoCritico(tasks, today) {
        const container = document.getElementById('focoCriticoList');
        container.innerHTML = '';

        const sevenDaysFromNow = new Date(today);
        sevenDaysFromNow.setDate(today.getDate() + 7);
        const focoTasks = new Map();

        // L√≥gica existente para identificar tareas cr√≠ticas...
        tasks.filter(t => t.isCritical && t.percentComplete === 0 && new Date(t.start) >= today && new Date(t.start) <= sevenDaysFromNow)
             .forEach(t => { if (!focoTasks.has(t.id)) focoTasks.set(t.id, { task: t, reasons: [] }); focoTasks.get(t.id).reasons.push({ text: 'Inicio Inminente', color: 'text-blue-400', icon: 'play-circle' }); });

        tasks.filter(t => t.isCritical && t.percentComplete > 0 && t.percentComplete < 50)
             .sort((a, b) => a.percentComplete - b.percentComplete).slice(0, 5)
             .forEach(t => { if (!focoTasks.has(t.id)) focoTasks.set(t.id, { task: t, reasons: [] }); focoTasks.get(t.id).reasons.push({ text: `Bajo Avance (${t.percentComplete}%)`, color: 'text-yellow-400', icon: 'trending-down' }); });

        tasks.filter(t => t.isCritical && t.percentComplete < 100 && new Date(t.end) < today)
             .forEach(t => { if (!focoTasks.has(t.id)) focoTasks.set(t.id, { task: t, reasons: [] }); focoTasks.get(t.id).reasons.push({ text: 'Atrasada', color: 'text-red-400', icon: 'alert-triangle' }); });

        if (focoTasks.size === 0) {
            container.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="shield-check" class="w-4 h-4 shrink-0 mr-2"></i>No se identifican tareas de foco cr√≠tico.</li>`;
        } else {
            focoTasks.forEach(data => {
                const item = document.createElement('li');
                item.className = 'flex items-start text-sm';
                const reasonsHTML = data.reasons.map(reason =>
                    `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${reason.color} bg-opacity-20 bg-current mr-2">${reason.text}</span>`
                ).join('');

                item.innerHTML = `
                    <i data-lucide="target" class="w-4 h-4 shrink-0 mr-2 mt-0.5 text-[--bl-dorado]"></i>
                    <div class="flex-1 min-w-0">
                        <span class="font-semibold text-white block">${data.task.name}</span>
                        ${formatTaskPath(data.task, false)}
                        <div class="flex flex-wrap mt-1">${reasonsHTML}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        lucide.createIcons();
    }

    // Paso 4C: Modificar renderRisks
    function renderRisks(tasks, today) {
        const container = document.getElementById('riskList');
        container.innerHTML = '';
        const risks = [];

        tasks.filter(t => new Date(t.end) < today && t.percentComplete < 100)
             .forEach(t => risks.push({ task: t, type: 'Tarea Atrasada' }));

        if (risks.length === 0) {
            container.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="shield-check" class="w-4 h-4 shrink-0 mr-2"></i>No se han detectado riesgos mayores.</li>`;
        } else {
            risks.forEach(risk => {
                const item = document.createElement('li');
                item.className = 'flex items-start text-sm';
                const daysOverdue = Math.ceil((today - new Date(risk.task.end)) / (1000 * 60 * 60 * 24));

                item.innerHTML = `
                    <i data-lucide="alert-triangle" class="w-4 h-4 shrink-0 mr-2 mt-0.5 text-yellow-400"></i>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-white">${risk.task.name}</span>
                            <span class="text-xs text-red-400 font-medium">(${daysOverdue} d√≠as de retraso)</span>
                        </div>
                        ${formatTaskPath(risk.task, false)}
                        <div class="text-xs text-white/60 mt-0.5">Fin planificado: ${formatDate(risk.task.end)} | Avance: ${risk.task.percentComplete}%</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        lucide.createIcons();
    }

    function renderResourceLoadChart(tasks, resourcesMap) { const chartEl = document.getElementById('resourceLoadChart'); chartEl.innerHTML = ''; const genericResourceLoad = getResourceLoadData(tasks, resourcesMap); if (genericResourceLoad.size === 0) { chartEl.innerHTML = '<p class="text-center text-white/50">No hay recursos asignados a tareas.</p>'; return; } const sortedResources = [...genericResourceLoad.entries()].sort((a,b) => b[1].count - a[1].count); const avgTasks = tasks.length / genericResourceLoad.size; const chartData = sortedResources.map(([name, data]) => ({ x: data.count, y: name, fillColor: data.count > avgTasks * 1.5 ? '#ef4444' : (data.count > avgTasks * 1.1 ? 'var(--bl-dorado)' : 'var(--bl-azul-principal)') })); const options = { series: [{ data: chartData }], chart: { id: 'resourceLoadChart', type: 'bar', height: 100 + sortedResources.length * 30, background: 'transparent', toolbar: { show: false }, events: { dataPointSelection: (event, chartContext, config) => { const resourceName = config.w.globals.labels[config.dataPointIndex]; const allTasksForRole = []; tasks.forEach(task => { const hasResource = task.resourceIds.some(resId => { const resource = resourcesMap.get(resId); return resource && resource.name.replace(/\s*\d+\s*$/, '').trim() === resourceName; }); if (hasResource) { allTasksForRole.push(task); } }); showTaskModal(`Tareas asignadas a: ${resourceName}`, allTasksForRole, true); } } }, plotOptions: { bar: { borderRadius: 4, horizontal: true, distributed: true, dataLabels: { position: 'top' } } }, dataLabels: { enabled: true, offsetX: 15, style: { colors: ['#fff'], fontSize: '12px' } }, legend: { show: false }, xaxis: { categories: sortedResources.map(([name, data]) => name), labels: { style: { colors: '#FFFFFF' } }, title: { text: 'N¬∫ de Tareas Asignadas', style: { color: '#FFFFFF', fontWeight: 'normal'} } }, yaxis: { labels: { style: { colors: '#FFFFFF' } } }, grid: { borderColor: 'rgba(255,255,255,0.1)' } }; new ApexCharts(chartEl, options).render(); }
    function formatDate(dateStr) { if (!dateStr) return 'N/A'; const date = new Date(dateStr); return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' }); }
    function generateBurnUpData(tasks, startDate, endDate) { const data = { planned: [], completed: [], categories: [] }; if (!startDate || !endDate || startDate > endDate) return data; const relevantTasks = tasks.filter(t => { const taskEnd = new Date(t.end); return taskEnd >= startDate && taskEnd <= endDate; }); const increment = burnupViewMode === 'day' ? 1 : 7; for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + increment)) { const datePoint = d.toISOString().split('T')[0]; data.categories.push(datePoint); const plannedOnDate = relevantTasks.filter(t => new Date(t.end) <= d).length; data.planned.push(plannedOnDate); const completedOnDate = relevantTasks.filter(t => t.percentComplete === 100 && new Date(t.end) <= d).length; data.completed.push(completedOnDate); } return data; }

    // Paso 4E: Modificar showTaskModal
    function showTaskModal(title, tasks) {
        const modal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        modalTitle.textContent = title;

        if (typeof tasks === 'string') {
            modalContent.innerHTML = tasks;
        } else if (Array.isArray(tasks)) {
            modalContent.innerHTML = '';
            if (tasks.length === 0) {
                modalContent.innerHTML = '<p class="text-white/60">No hay tareas para mostrar en esta categor√≠a.</p>';
            } else {
                let tableHTML = `
                    <table class="w-full text-sm text-left table-fixed">
                        <thead class="text-xs text-white/70 uppercase">
                            <tr>
                                <th scope="col" class="px-4 py-2 w-[35%]">Nombre Tarea</th>
                                <th scope="col" class="px-4 py-2 w-[20%]">Ubicaci√≥n</th>
                                <th scope="col" class="px-4 py-2 w-[15%]">Recurso(s)</th>
                                <th scope="col" class="px-4 py-2 w-[15%]">Fecha Fin</th>
                                <th scope="col" class="px-4 py-2 w-[10%] text-right">Avance</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                tasks.forEach(task => {
                    const resourceNames = task.resourceIds.map(id => projectDataStore.resources.get(id)?.name || '').join(', ');
                    const pathHTML = formatTaskPath(task, false).replace('<span class="text-xs text-white/50 block">', '').replace('</span>', '');

                    tableHTML += `
                        <tr class="border-b border-white/10 hover:bg-white/5">
                            <td class="px-4 py-2 font-medium">
                                <div class="font-semibold truncate" title="${task.name}">${task.name}</div>
                                ${pathHTML ? `<div class="text-xs text-white/50">${pathHTML}</div>` : ''}
                            </td>
                            <td class="px-4 py-2 text-xs truncate" title="${task.parentName || 'N/A'}">${task.parentName || 'N/A'}</td>
                            <td class="px-4 py-2 text-xs truncate" title="${resourceNames}">${resourceNames || 'Sin asignar'}</td>
                            <td class="px-4 py-2">${formatDate(task.end)}</td>
                            <td class="px-4 py-2 text-right">${task.percentComplete}%</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                modalContent.innerHTML = tableHTML;
            }
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    const modal = document.getElementById('task-modal'); document.getElementById('modal-close-btn').addEventListener('click', () => modal.classList.add('hidden')); modal.addEventListener('click', (e) => { if (e.target.id === 'task-modal') { modal.classList.add('hidden'); } }); document.addEventListener('keydown', (e) => { if (e.key === "Escape" && !modal.classList.contains('hidden')) { modal.classList.add('hidden'); } });

    /**
     * Reemplazo de la funci√≥n anterior de resumen manual (DEPRECATED: mantener la referencia para el addExportFunctionality)
     */
    function generateExecutiveSummary() {
        // Esta funci√≥n ahora solo es un placeholder. La l√≥gica IA es en generateExecutiveSummaryAI.
        const contentArea = document.getElementById('executive-summary-content');
        contentArea.innerHTML = '<p class="text-yellow-400 italic">Esta es la funci√≥n de resumen manual/pre-calculado. Use "Generar Resumen IA" para el an√°lisis inteligente.</p>';
    }


    function addExportFunctionality(data) { const addClickListener = (id, generator) => { const button = document.getElementById(id); if (!button) return; const newButton = button.cloneNode(true); button.parentNode.replaceChild(newButton, button); newButton.addEventListener('click', generator); }; addClickListener('exportGanttJPG', () => exportElementAsJPG('gantt-container-for-export', 'exportGanttJPG')); addClickListener('exportBurnupJPG', () => exportElementAsJPG('burnup-container-for-export', 'exportBurnupJPG')); addClickListener('exportResourcesJPG', () => exportElementAsJPG('resources-container-for-export', 'exportResourcesJPG')); addClickListener('exportMilestonesJPG', () => exportElementAsJPG('milestones-container-for-export', 'exportMilestonesJPG')); addClickListener('exportCriticalPathJPG', () => exportElementAsJPG('criticalpath-container-for-export', 'exportCriticalPathJPG')); addClickListener('exportFocoCriticoJPG', () => exportElementAsJPG('foco-critico-container-for-export', 'exportFocoCriticoJPG')); addClickListener('exportIssuesKanbanJPG', () => exportElementAsJPG('issues-kanban-container-for-export', 'exportIssuesKanbanJPG'));
    addClickListener('exportRisksJPG', () => exportElementAsJPG('risks-container-for-export', 'exportRisksJPG')); addClickListener('exportSPIJPG', () => exportElementAsJPG('spi-kpi-card', 'exportSPIJPG')); addClickListener('exportTrendJPG', () => exportElementAsJPG('trend-analysis-container-for-export', 'exportTrendJPG')); addClickListener('exportUpcomingJPG', () => exportElementAsJPG('upcoming-tasks-container-for-export', 'exportUpcomingJPG')); addClickListener('exportAllTasks', () => { const csvData = generateHierarchicalCSVData(projectDataStore.tasks); exportToCSV(csvData, 'gantt_proyecto.csv'); });
    // Mantiene la referencia a la funci√≥n de IA
    addClickListener('generate-summary-btn', generateExecutiveSummaryAI);
    addClickListener('exportSummaryJPG', () => exportElementAsJPG('summary-container-for-export', 'exportSummaryJPG'));
    // A√±adir el nuevo bot√≥n de exportaci√≥n para Riesgos Predictivos
    addClickListener('analyze-risks-btn', generatePredictiveRisksAI);
    addClickListener('exportRisksPredictiveJPG', () => exportElementAsJPG('predictive-risks-container', 'exportRisksPredictiveJPG'));
    }

    // --- FUNCI√ìN DE EXPORTACI√ìN ACTUALIZADA ---
    async function exportElementAsJPG(elementId, buttonId) {
        const containerToExport = document.getElementById(elementId);
        const button = document.getElementById(buttonId);
        const originalButtonHTML = button ? button.innerHTML : '';
        if (button) {
            button.innerHTML = 'Generando...';
            button.disabled = true;
        }

        // 1. Clonar el contenedor
        const clone = containerToExport.cloneNode(true);
        clone.id = `${elementId}-clone`;
        clone.style.position = 'absolute';
        clone.style.top = '-10000px';
        clone.style.left = '0';
        clone.style.zIndex = '-1';
        clone.style.width = containerToExport.scrollWidth + 'px';
        clone.style.maxWidth = 'none';
        clone.style.maxHeight = 'none';

        // --- INICIO: MODO PRESENTACI√ìN AUTOM√ÅTICO ---

        // 2. Aplicar estilos de presentaci√≥n base al clon
        clone.style.fontSize = '110%';

        // 3. Ocultar todos los elementos de UI marcados con .no-export
        clone.querySelectorAll('.no-export').forEach(el => {
            el.style.display = 'none';
        });

        // 4. Funci√≥n mejorada para asegurar que todo el contenido sea visible
        const expandOverflow = (root) => {
            // A√±adir una regla de estilo para ocultar scrollbars de Webkit en el clon
            const style = document.createElement('style');
            style.innerHTML = `#${root.id} ::-webkit-scrollbar { display: none; }`;
            root.appendChild(style);

            root.querySelectorAll('*').forEach(el => {
                const cs = getComputedStyle(el);
                const needsHeight = el.scrollHeight > el.clientHeight;
                const needsWidth = el.scrollWidth > el.clientWidth;

                // Forzar la visibilidad para expandir el contenido
                if (cs.overflowY !== 'visible') el.style.overflowY = 'visible';
                if (cs.overflowX !== 'visible') el.style.overflowX = 'visible';

                // Ajustar dimensiones si el contenido est√° recortado
                if (needsHeight) { el.style.height = el.scrollHeight + 'px'; }
                if (needsWidth) { el.style.width = el.scrollWidth + 'px'; }

                // Limpiar restricciones y scrollbars de Firefox
                el.style.maxHeight = 'none';
                el.style.maxWidth = 'none';
                el.style.scrollbarWidth = 'none';
            });
        };

        // --- FIN: MODO PRESENTACI√ìN ---

        document.body.appendChild(clone);

        // 5. Ejecutar la funci√≥n para expandir y limpiar el clon
        expandOverflow(clone);

        // --- L√≥gica original para copiar canvas y generar imagen ---
        const originalCanvases = containerToExport.querySelectorAll('canvas');
        const clonedCanvases = clone.querySelectorAll('canvas');
        for (let i = 0; i < clonedCanvases.length; i++) {
            const src = originalCanvases[i];
            const dst = clonedCanvases[i];
            if (src && dst) {
                dst.width = src.width;
                dst.height = src.height;
                const ctx = dst.getContext('2d');
                try {
                    ctx.drawImage(src, 0, 0);
                } catch (e) {
                    console.warn('No se pudo copiar un canvas:', e);
                }
            }
        }

        await new Promise(r => setTimeout(r, 100)); // Peque√±a pausa para renderizado

        try {
            const exportWidth = Math.max(clone.scrollWidth, containerToExport.scrollWidth, clone.clientWidth);
            const exportHeight = Math.max(clone.scrollHeight, containerToExport.scrollHeight, clone.clientHeight);

            const canvas = await html2canvas(clone, {
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bl-azul-oscuro').trim() || null,
                scale: 2,
                useCORS: true,
                allowTaint: false,
                logging: false,
                width: exportWidth,
                height: exportHeight,
                windowWidth: exportWidth,
                windowHeight: exportHeight,
                scrollX: 0,
                scrollY: 0,
            });

            const link = document.createElement('a');
            const fileName = `${elementId.split('-')[0]}_proyecto_${new Date().toISOString().split('T')[0]}.jpg`;
            link.download = fileName;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();

        } catch (err) {
            console.error("Error al exportar JPG:", err);
            // Replaced alert
            const contentArea = document.getElementById('executive-summary-content');
            contentArea.innerHTML = `<p class="text-red-400 font-semibold">Hubo un problema al generar la imagen. Consulta la consola para m√°s detalles.</p>`;
        } finally {
            document.body.removeChild(clone);
            if (button) {
                button.innerHTML = originalButtonHTML;
                button.disabled = false;
            }
            if (window.lucide && window.lucide.createIcons) {
                lucide.createIcons();
            }
        }
    }

    function generateHierarchicalCSVData(taskTree) { const csvData = []; function traverse(tasks, prefix) { tasks.forEach((task, index) => { const wbs = prefix ? `${prefix}.${index + 1}` : `${index + 1}`; const indentation = ' '.repeat(task.outlineLevel - 1); csvData.push({ 'ID (WBS)': wbs, 'Nivel': task.outlineLevel, 'Nombre Tarea': `${indentation}${task.name}`, 'Es Resumen': task.isSummary ? 'S√≠' : 'No', 'Inicio': formatDate(task.start), 'Fin': formatDate(task.end), 'Avance (%)': task.percentComplete, 'Cr√≠tica': task.isCritical ? 'S√≠' : 'No' }); if (task.children && task.children.length > 0) { traverse(task.children, wbs); } }); } traverse(taskTree, ''); return csvData; }
    function exportToCSV(data, filename) { if (data.length === 0) { console.warn("No hay datos para exportar."); return; } const headers = Object.keys(data[0]).join(','); const rows = data.map(row => { return Object.values(row).map(value => { let valStr = String(value).replace(/"/g, '""'); if (valStr.includes(',')) return `"${valStr}"`; return valStr; }).join(','); }).join('\n'); const csvContent = `data:text/csv;charset=utf-8,\uFEFF${headers}\n${rows}`; const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    function renderTrendAnalysis(currentData, previousData) { const trendPanel = document.getElementById('trend-analysis-container-for-export'); const kpiList = document.getElementById('kpiDeltaList'); const slippageList = document.getElementById('slippageList'); const scopeList = document.getElementById('scopeChangeList'); if (!trendPanel || !kpiList || !slippageList || !scopeList) return; trendPanel.classList.remove('hidden'); const today = new Date(); const currentFlatTasks = flattenTasks(currentData.tasks); const previousFlatTasks = flattenTasks(previousData.tasks); const currentExecTasks = currentFlatTasks.filter(t => !t.isSummary); const previousExecTasks = previousFlatTasks.filter(t => !t.isSummary); const currentKPIs = calculateKPIs(currentExecTasks, new Date(currentData.startDate), new Date(currentData.baselineEndDate), today); const previousKPIs = calculateKPIs(previousExecTasks, new Date(previousData.startDate), new Date(previousData.baselineEndDate), today); const currentOverdue = currentExecTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100).length; const previousOverdue = previousExecTasks.filter(t => new Date(t.end) < today && t.percentComplete < 100).length; const currentCompleted = currentExecTasks.filter(t => t.percentComplete === 100).length; const previousCompleted = previousExecTasks.filter(t => t.percentComplete === 100).length; kpiList.innerHTML = ''; const tooltips = { endDate: "<b>¬øPor qu√© cambia?</b> Se calcula en base al rendimiento general. Si se completaron menos tareas de las planificadas o hubo retrasos, la fecha proyectada se mover√° hacia el futuro.", spi: "<b>¬øPor qu√© cambia?</b> Compara la cantidad de tareas que deber√≠an haberse terminado a hoy (Plan) con las que realmente se terminaron (Real). Si el n√∫mero real es menor, el √≠ndice baja.", overdue: "<b>¬øPor qu√© cambia?</b> Aumenta si las tareas no se completan antes de su fecha de fin. Disminuye a medida que esas tareas se van completando, incluso tarde.", completed: "<b>¬øPor qu√© cambia?</b> Es un contador de tareas al 100%. El cambio muestra la productividad del equipo en el √∫ltimo per√≠odo." }; const endDateDiff = (currentKPIs.projectedEndDate - previousKPIs.projectedEndDate) / (1000 * 60 * 60 * 24); kpiList.appendChild(createDeltaLi('Fin Proyectada', formatDate(currentKPIs.projectedEndDate), endDateDiff, 'd√≠as', true, tooltips.endDate)); const spiDiff = currentKPIs.spi - previousKPIs.spi; kpiList.appendChild(createDeltaLi('√çndice SPI', currentKPIs.spi.toFixed(2), spiDiff, '', false, tooltips.spi)); const overdueDiff = currentOverdue - previousOverdue; kpiList.appendChild(createDeltaLi('Tareas Atrasadas', currentOverdue, overdueDiff, '', true, tooltips.overdue)); const completedDiff = currentCompleted - previousCompleted; kpiList.appendChild(createDeltaLi('Tareas Completadas', currentCompleted, completedDiff, '', false, tooltips.completed)); slippageList.innerHTML = ''; const previousTasksMap = new Map(previousFlatTasks.map(t => [t.id, t])); const slippedTasks = []; currentFlatTasks.forEach(currentTask => { const previousTask = previousTasksMap.get(currentTask.id); if (previousTask && (currentTask.isCritical || currentTask.isMilestone)) { const currentEndDate = new Date(currentTask.end); const previousEndDate = new Date(previousTask.end); if (currentEndDate > previousEndDate) { slippedTasks.push({task: currentTask, prevEnd: previousEndDate}); } } }); if (slippedTasks.length > 0) { slippedTasks.forEach(slip => { const li = document.createElement('li'); li.className = 'flex items-start text-xs'; li.innerHTML = ` <i data-lucide="chevrons-right" class="w-4 h-4 text-orange-400 shrink-0 mr-2"></i> <div> <span class="font-semibold">${slip.task.name}</span> <span class="block text-orange-400">Desv√≠o de ${formatDate(slip.prevEnd)} a ${formatDate(slip.task.end)}</span> </div>`; slippageList.appendChild(li); }); } else { slippageList.innerHTML = `<li class="flex items-center text-sm text-green-400"><i data-lucide="thumbs-up" class="w-4 h-4 shrink-0 mr-2"></i>Sin desv√≠os en tareas clave.</li>`; } scopeList.innerHTML = ''; const currentTaskIds = new Set(currentFlatTasks.map(t => t.id)); const previousTaskIds = new Set(previousFlatTasks.map(t => t.id)); const newTasks = currentFlatTasks.filter(t => !previousTaskIds.has(t.id)); const removedTasks = previousFlatTasks.filter(t => !currentTaskIds.has(t.id)); scopeList.innerHTML = ` <li class="flex items-center justify-between"><span>Tareas Nuevas:</span> <span class="font-bold text-lg text-blue-400">${newTasks.length}</span></li> <li class="flex items-center justify-between"><span>Tareas Eliminadas:</span> <span class="font-bold text-lg text-gray-400">${removedTasks.length}</span></li> `; lucide.createIcons(); }
    function createDeltaLi(label, value, delta, unit = '', higherIsWorse = false, tooltipText = '') { const li = document.createElement('li'); li.className = 'flex items-center justify-between cursor-pointer'; li.dataset.tooltipText = tooltipText.replace(/"/g, '&quot;'); let deltaText = ''; let colorClass = 'text-gray-400'; if (delta !== 0) { const sign = delta > 0 ? '+' : ''; colorClass = (delta > 0) ? (higherIsWorse ? 'text-red-400' : 'text-green-400') : (higherIsWorse ? 'text-green-400' : 'text-red-400'); deltaText = `(${sign}${delta.toFixed(2).replace(/\.00$/, '')} ${unit})`; } li.innerHTML = ` <span>${label}:</span> <span class="font-bold text-lg">${value} <span class="text-xs ${colorClass}">${deltaText}</span></span> `; return li; }

    lucide.createIcons();
    </script>

<script>
(function(){
  // ===== Robust hide of legacy hero =====
  function hideLegacyHero(){
    const matchers = [
      (h)=> (h.textContent||'').toUpperCase().includes('ARRASTRA O SELECCIONA EL ARCHIVO ACTUAL'),
      (h)=> (h.textContent||'').toUpperCase().includes('ESTE ES EL ARCHIVO XML DE MS PROJECT'),
    ];
    const hs = Array.from(document.querySelectorAll('h1,h2,h3'));
    for(const h of hs){
      if(matchers.some(fn=>fn(h))){
        const hero = h.closest('section') || h.closest('div');
        if(hero){
          hero.classList.add('legacy-upload-hero');
          hero.style.display='none';
        }
      }
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hideLegacyHero);
  } else { hideLegacyHero(); }

  // ===== Steps logic =====
  const steps = document.getElementById('stepsInlinePro');
  if(!steps) return;

  const inputActual   = document.getElementById('currentFile');
  const inputAnterior = document.getElementById('previousFile');
  const btnGenerar    = document.getElementById('generate-report-btn');

  const s1 = document.getElementById('inStep1');
  const s2 = document.getElementById('inStep2');
  const s3 = document.getElementById('inStep3');

  const s1File = document.getElementById('inS1File');
  const s2File = document.getElementById('inS2File');

  const s1State = document.getElementById('inS1State');
  const s2State = document.getElementById('inS2State');
  const s3State = document.getElementById('inS3State');

  const select1 = document.getElementById('inS1Select');
  const select2 = document.getElementById('inS2Select');
  const skip2   = document.getElementById('inS2Skip');
  const gen     = document.getElementById('inGenerate');

  const drop1   = document.getElementById('drop1');
  const drop2   = document.getElementById('drop2');

  function accent(){
    const r = getComputedStyle(document.documentElement);
    return r.getPropertyValue('--bl-dorado') || r.getPropertyValue('--brand-accent') || '#F2D157';
  }
  function setState(card, chip, state){
    card.classList.remove('opacity-60','ring-2','card-done','card-skip');
    card.style.removeProperty('--tw-ring-color');
    if(state==='disabled'){ card.classList.add('opacity-60'); chip.textContent='bloqueado'; }
    if(state==='current'){ card.classList.add('ring-2'); card.style.setProperty('--tw-ring-color', accent()); chip.textContent='en curso'; }
    if(state==='done'){ card.classList.add('card-done'); chip.textContent='listo'; }
    if(state==='skip'){ card.classList.add('card-skip'); chip.textContent='saltado'; }
  }
  function enableGenerateIfReady(){
    const ok = !!(inputActual?.files && inputActual.files[0]);
    if(ok){ gen.removeAttribute('disabled'); setState(s3, s3State, 'current'); }
    else  { gen.setAttribute('disabled',''); setState(s3, s3State, 'disabled'); }
  }
  function setInputFiles(input, files){
    try{
      const dt = new DataTransfer();
      for (let i=0;i<files.length;i++) dt.items.add(files[i]);
      input.files = dt.files;
      // Trigger the existing handleFileSelection logic via change event
      input.dispatchEvent(new Event('change', { bubbles: true }));
    }catch(e){ console.warn('No se pudieron asignar los archivos al input:', e); }
  }
  function wireDrop(dropEl, input, labelEl){
    ['dragenter','dragover'].forEach(evt => dropEl.addEventListener(evt,(e)=>{
      e.preventDefault(); e.stopPropagation();
      dropEl.classList.add('ring-2'); dropEl.style.setProperty('--tw-ring-color', accent());
      if(e.dataTransfer) e.dataTransfer.dropEffect='copy';
    }));
    ;['dragleave','drop'].forEach(evt => dropEl.addEventListener(evt,(e)=>{
      e.preventDefault(); e.stopPropagation();
      dropEl.classList.remove('ring-2'); dropEl.style.removeProperty('--tw-ring-color');
    }));
    dropEl.addEventListener('drop',(e)=>{
      const files = e.dataTransfer?.files;
      if(files && files.length){
        setInputFiles(input, files);
        labelEl.textContent = files[0].name;
      }
    });
  }

  // Buttons
  select1?.addEventListener('click', ()=> inputActual?.click());
  select2?.addEventListener('click', ()=> inputAnterior?.click());
  skip2?.addEventListener('click', ()=>{
    safeSetItem('__inline_prev_skipped__','1');
    setState(s2, s2State, 'skip');
    s2File.textContent = 'Saltado.';
    enableGenerateIfReady();
    // Clear previous file input state (IMPORTANT: uses setInputFiles utility)
    setInputFiles(inputAnterior, []);
  });
  gen?.addEventListener('click', ()=>{
    if(inputActual?.files && inputActual.files[0]){
      // Trigger the main generation logic
      btnGenerar?.click();
      document.getElementById('stepsInlinePro')?.classList.add('hidden');
    }
  });

  // DnD
  if(drop1 && inputActual) wireDrop(drop1, inputActual, s1File);
  if(drop2 && inputAnterior) wireDrop(drop2, inputAnterior, s2File);

  // React to native changes
  inputActual?.addEventListener('change', ()=>{
    if(inputActual.files && inputActual.files[0]){
      setState(s1, s1State, 'done');
      s1File.textContent = inputActual.files[0].name;
      setState(s2, s2State, 'current');
      enableGenerateIfReady();
    }else{
      setState(s1, s1State, 'current');
      s1File.textContent = 'Ning√∫n archivo seleccionado.';
      setState(s2, s2State, 'disabled');
      setState(s3, s3State, 'disabled');
      gen.setAttribute('disabled','');
    }
  });
  inputAnterior?.addEventListener('change', ()=>{
    if(inputAnterior.files && inputAnterior.files[0]){
      localStorage.removeItem('__inline_prev_skipped__');
      setState(s2, s2State, 'done');
      s2File.textContent = inputAnterior.files[0].name;
    }else if (!localStorage.getItem('__inline_prev_skipped__')){
        // If file input is cleared and not explicitly skipped, keep it current/pending
      setState(s2, s2State, 'current');
      s2File.textContent = 'No cargado.';
    }
  });

  // Initial
  setState(s1, s1State, 'current');
  setState(s2, s2State, 'disabled');
  setState(s3, s3State, 'disabled');
  setTimeout(()=>{
    if(inputActual?.files && inputActual.files[0]){
      setState(s1, s1State, 'done'); s1File.textContent = inputActual.files[0].name; setState(s2, s2State, 'current'); enableGenerateIfReady();
    }
    if(inputAnterior?.files && inputAnterior.files[0]){
      setState(s2, s2State, 'done'); s2File.textContent = inputAnterior.files[0].name;
    } else if (localStorage.getItem('__inline_prev_skipped__')==='1'){
      setState(s2, s2State, 'skip'); s2File.textContent = 'Saltado.';
    }
  }, 0);

  // ===== Branding: same-size logo + restore =====
  (function(){
    const logo = document.getElementById('custom-logo'); // Logo Cliente
    if(!logo) return;
    
    // Lock current box size as CSS vars so any new image uses exact same box
    function lockLogoBox(){
      const r = logo.getBoundingClientRect();
      if(r.width && r.height){
        document.documentElement.style.setProperty('--logo-w', r.width+'px');
        document.documentElement.style.setProperty('--logo-h', r.height+'px');
      }
    }
    // Initial lock (after image loads)
    if(logo.complete){ lockLogoBox(); } else { logo.addEventListener('load', lockLogoBox, {once:true}); }

    const DEFAULT_SRC = logo.getAttribute('data-default-src') || logo.src;

    // Build/ensure Restore button in Config near the logo upload control (now only for restoring client logo)
    function ensureRestoreBtn(){
      let restore = document.getElementById('logo-restore-btn-client');
      if(!restore){
        restore = document.createElement('button');
        restore.id = 'logo-restore-btn-client';
        restore.className = 'btn';
        restore.textContent = 'Restaurar logo de cliente';
        // Place next to label[for="logo-upload-input"]
        const label = document.querySelector('label[for="logo-upload-input"]');
        if(label && label.parentElement){
          let wrap = label.parentElement.querySelector('.brand-actions-client');
          if(!wrap){
            wrap = document.createElement('div');
            wrap.className = 'brand-actions-client mt-2 flex gap-2';
            label.parentElement.appendChild(wrap);
          }
          wrap.appendChild(restore);
        } else {
          // fallback: append near the logo
          logo.parentElement && logo.parentElement.appendChild(restore);
        }
      }
      restore.addEventListener('click', ()=>{
        try{
          localStorage.removeItem('customLogo');
          logo.src = DEFAULT_SRC;
        }catch(e){ console.warn('No se pudo restaurar el logo de cliente:', e); }
      }, {once:false});
    }
    ensureRestoreBtn();

    // Apply custom from localStorage on load
    const saved = localStorage.getItem('customLogo');
    if(saved){
      logo.src = saved;
    }

    // Wire file upload input
    const fileInput = document.getElementById('logo-upload-input');
    if(fileInput){
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = function(evt){
          const dataURL = evt.target?.result;
          if(!dataURL) return;
          // Lock current box size before swap
          lockLogoBox();
          logo.src = dataURL;
          try{ safeSetItem('customLogo', dataURL); }catch(e){ console.warn('No se pudo guardar customLogo en localStorage (quota):', e); }
        };
        reader.readAsDataURL(f);
      });
    }
  })();
  
  // PASO 3B: Logo central de BlatoRH
  (function(){
    const logoBlatorh = document.getElementById('blatorh-logo-center');
    if(!logoBlatorh) return;

    // Hacer clickeable
    logoBlatorh.style.cursor = 'pointer';
    logoBlatorh.addEventListener('click', () => location.reload());

    // Input file para subir logo BlatoRH
    const fileInputBlatorh = document.createElement('input');
    fileInputBlatorh.type = 'file';
    fileInputBlatorh.id = 'blatorh-logo-upload-input';
    fileInputBlatorh.className = 'hidden';
    fileInputBlatorh.accept = 'image/*';
    document.body.appendChild(fileInputBlatorh);

    // Cambiar texto del bot√≥n de restaurar (usando el ID que creamos en el HTML)
    const restoreBtn = document.getElementById('logo-restore-btn');
    if(restoreBtn) {
        restoreBtn.textContent = 'Subir logo de Blatorh';
        restoreBtn.addEventListener('click', () => fileInputBlatorh.click());
    }

    // Guardar/cargar logo BlatoRH
    fileInputBlatorh.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = function(evt){
            const dataURL = evt.target.result;
            logoBlatorh.src = dataURL;
            safeSetItem('blatorhLogo', dataURL);
        };
        reader.readAsDataURL(f);
    });

    const savedBlatorh = localStorage.getItem('blatorhLogo');
    if(savedBlatorh) logoBlatorh.src = savedBlatorh;
  })();
  // FIN PASO 3B
})();
</script>

<script>
// --- Utils ---
function _pad(n){return String(n).padStart(2,'0');}
function _fmt(iso){
    if(!iso) return 'N/D';
    const d=new Date(iso);
    return `${_pad(d.getDate())}.${_pad(d.getMonth()+1)}.${String(d.getFullYear()).slice(-2)} ${_pad(d.getHours())}:${_pad(d.getMinutes())}`;
}

// --- Extend parseProjectXML to capture LastSaved ---
(function(){
    const base=parseProjectXML;
    window.parseProjectXML=function(xmlDoc){
        const data=base(xmlDoc);
        let lastSaved='';
        Array.from(xmlDoc.getElementsByTagName('*')).forEach(el=>{
            if(el.localName==='LastSaved'){ lastSaved=el.textContent;}
        });
        data.lastSaved=lastSaved;
        return data;
    };
})();

// --- Create branded Inicio button once dashboard shown ---
function ensureInicioButton(){
    if(document.getElementById('btnReturnHome')) return;
    const btn=document.createElement('button');
    btn.id='btnReturnHome';
    const root=getComputedStyle(document.documentElement);
    btn.style.backgroundColor=root.getPropertyValue('--bl-dorado').trim()||'#B1A96E';
    btn.style.color=root.getPropertyValue('--bl-azul-oscuro').trim()||'#0D2240';
    btn.className='fixed bottom-4 left-4 z-50 px-5 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:opacity-90 transition';
    btn.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg><span>Inicio</span>`;
    btn.addEventListener('click',()=>location.reload());
    document.body.appendChild(btn);
}

// --- Inject last modification dates and create button inside processAndRenderDashboard ---
(function(){
    const base=processAndRenderDashboard;
    window.processAndRenderDashboard=function(data, prev=null){
        base.apply(this, arguments);

        // Show last saved info
        const title=document.getElementById('projectName');
        if(title){
            let holder=document.getElementById('lastSavedHolder');
            if(!holder){
                holder=document.createElement('div');
                holder.id='lastSavedHolder';
                holder.className='space-y-0.5';
                title.parentNode.insertBefore(holder, title.nextSibling);
            }else{ holder.innerHTML=''; }

            const pCur=document.createElement('p');
            pCur.className='text-[--bl-dorado] font-semibold text-sm';
            pCur.textContent='√öltima modificaci√≥n (actual): '+_fmt(data.lastSaved);
            holder.appendChild(pCur);

            if(prev && prev.lastSaved){
                const pPrev=document.createElement('p');
                pPrev.className='text-[--bl-dorado]/80 font-medium text-sm';
                pPrev.textContent='√öltima modificaci√≥n (anterior): '+_fmt(prev.lastSaved);
                holder.appendChild(pPrev);
            }
        }

        ensureInicioButton();
    };
})();

// --- Remove Inicio button when on initial page ---
document.addEventListener('DOMContentLoaded', ()=>{
    const dash=document.getElementById('dashboardSection');
    if(dash && dash.classList.contains('hidden')){
        const btn=document.getElementById('btnReturnHome');
        if(btn) btn.remove();
    }
});
</script>


<script>
// 1. Enhance parseProjectXML to include overallProgress and plannedProgress
(function(){
    const base=parseProjectXML;
    window.parseProjectXML=function(xmlDoc){
        const data=base(xmlDoc);
        // Detect summary task UID 0
        const get=(el,tag)=>el.getElementsByTagName(tag)[0]?.textContent||'';
        const tasks=Array.from(xmlDoc.getElementsByTagName('Task'));
        let overall=0, planned=0;
        tasks.forEach(t=>{
            if(get(t,'UID')==='0'){
                overall=parseFloat(get(t,'PercentComplete'))||0;
                const ext=Array.from(t.getElementsByTagName('ExtendedAttribute')).find(e=>get(e,'FieldID')==='188743731');
                if(ext){ planned=parseFloat(get(ext,'Value').replace('%',''))||0; }
            }
        });
        data.overallProgress=overall;
        data.plannedProgress=planned;
        return data;
    };
})();

// 2. Override renderGauges to rename labels
(function(){
    const baseRG=renderGauges;
    window.renderGauges=function(real,plan){
        baseRG(real,plan);
        setTimeout(()=>{
            document.querySelectorAll('text').forEach(el=>{
                const txt=el.textContent.trim();
                if(txt==='Progreso General') el.textContent='% Avance Real';
                if(txt==='Tiempo Transcurrido') el.textContent='% Avance Plan';
            });
        },0);
    };
})();

// 3. Wrap processAndRenderDashboard to feed plannedProgress and keep button/date logic
(function(){
    const baseProc=processAndRenderDashboard;
    window.processAndRenderDashboard=function(data, prev=null){
        baseProc.apply(this, arguments);
        // Re-render gauges with real-plan pair from XML values
        if(typeof renderGauges==='function'){
            renderGauges(data.overallProgress, data.plannedProgress);
        }

        // --- NEW --- Show export snapshot button
        const exportBtn = document.getElementById('export-snapshot-btn');
        if (exportBtn) {
            exportBtn.classList.remove('hidden');
        }

        // Ensure Inicio button exists
        if(!document.getElementById('btnReturnHome')){
            const root=getComputedStyle(document.documentElement);
            const btn=document.createElement('button');
            btn.id='btnReturnHome';
            btn.className='fixed bottom-4 left-4 z-50 px-5 py-3 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:opacity-90';
            btn.style.backgroundColor=root.getPropertyValue('--bl-dorado').trim()||'#B1A96E';
            btn.style.color=root.getPropertyValue('--bl-azul-oscuro').trim()||'#0D2240';
            btn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg><span>Inicio</span>';
            btn.addEventListener('click', ()=>location.reload());
            document.body.appendChild(btn);
        }
    };
})();
</script>


<script>
// ========== EXPORTACI√ìN HTML PROFESIONAL ==========

async function generateProfessionalHTMLReport() {
    const btn = document.getElementById('download-html-report-btn');
    if (!btn) {
        console.error('Bot√≥n de descarga HTML no encontrado');
        return;
    }
    const originalHTML = btn.innerHTML;
    
    btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 inline-block animate-spin"></i>Generando...';
    btn.disabled = true;
    
    let filename = 'Cuadros_Control.html';

    try {
        // 1. Obtener datos din√°micos
        const projectName = (typeof projectDataStore !== 'undefined' && projectDataStore && projectDataStore.name) 
            ? projectDataStore.name 
            : 'Proyecto_Sin_Nombre';
        const dateStr = new Date()
            .toLocaleDateString('es-AR', { month: '2-digit', year: '2-digit' })
            .replace(/\//g, '');
        filename = `Cuadros_Control_${projectName.replace(/[^a-z0-9]/gi, '_')}_${dateStr}.html`;
        
        // 2. Clonar dashboard visible
        const reportClone = document.createElement('div');
        reportClone.id = 'html-report-clone';
        reportClone.style.display = 'none';
        document.body.appendChild(reportClone);
        
        const dashboard = document.getElementById('dashboardSection');
        if (!dashboard) throw new Error('No se encontr√≥ dashboardSection');
        const clone = dashboard.cloneNode(true);
        
        // 3. Limpiar clones (sin controles de edici√≥n ni paneles de branding / modales)
        clone.querySelectorAll('.no-export, #branding-panel, #task-modal, #gantt-tooltip').forEach(el => el.remove());
        clone.querySelectorAll('button, input[type="file"], input[type="date"], select').forEach(el => {
            if (!el.dataset.tooltipText) el.disabled = true;
        });
        
        // 4. Preparar tooltips para HTML est√°tico
        clone.querySelectorAll('[data-tooltip-text]').forEach(el => {
            const tooltip = document.createElement('div');
            tooltip.className = 'static-tooltip absolute hidden bg-[--bl-gris-oscuro] text-white p-3 rounded border border-[--bl-dorado] text-sm z-50 w-[460px] max-w-[460px]';
            tooltip.innerHTML = el.dataset.tooltipText;
            el.appendChild(tooltip);
        });
        
        // 5. Convertir Canvas a Im√°genes
        const canvasPromises = Array.from(clone.querySelectorAll('canvas')).map(async (canvas, i) => {
            try {
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/png');
                img.className = 'w-full max-h-96 object-contain';
                img.alt = `Gr√°fico ${i + 1}`;
                canvas.parentNode.replaceChild(img, canvas);
            } catch (e) {
                console.warn('No se pudo convertir un canvas a imagen', e);
            }
        });
        
        await Promise.all(canvasPromises);
        
        // 6. Inyectar todo en plantilla profesional
        const baseStyleEl = document.querySelector('head style:not([id])');
        const baseCss = baseStyleEl ? baseStyleEl.innerHTML : '';
        const patchEl = document.getElementById('blatorh-patch');
        const patchCss = patchEl ? patchEl.innerHTML : '';

        const htmlContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuadros Control - ${projectName}</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Exo:wght@400;700&display=swap" rel="stylesheet">
    <style>
${baseCss}
${patchCss}
        :root {
            --bl-azul-oscuro: #0D2240;
            --bl-dorado: #B1A96E;
            --bl-azul-principal: #1A77D2;
            --bl-blanco: #FFFFFF;
            --bl-gris-claro: #f3f4f6;
            --bl-gris-oscuro: #1f2937;
        }
        body { 
            font-family: 'Exo', sans-serif; 
            background-color: var(--bl-azul-oscuro); 
            color: var(--bl-blanco); 
        }
        h1, h2, h3, h4, .font-display { 
            font-family: 'Bebas Neue', sans-serif; 
        }
        .static-tooltip { 
            position: absolute; 
            pointer-events: none; 
            bottom: 105%; 
            left: 50%; 
            transform: translateX(-50%); 
            margin-bottom: 10px; 
            padding: 12px 18px; 
            font-size: 1rem; 
            line-height: 1.4; 
            max-width: 520px; 
            z-index: 120; 
            white-space: normal; 
            word-wrap: break-word; 
            text-align: left; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.45); 
        }
        .static-tooltip.hidden { 
            display: none !important; 
        }
        [data-tooltip-text] { 
            position: relative; 
            cursor: help; 
        }
        .card { 
            background-color: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
        }
        .no-interaction { 
            pointer-events: none; 
        }
        .kpi-interpretable:hover { 
            box-shadow: none !important; 
            transform: none !important; 
        }
        img { 
            max-width: 100%; 
            height: auto; 
        }
        /* Listas horizontales para comentarios/toplist en reporte */
        #kpiDeltaList,
        #slippageList,
        #scopeChangeList,
        #focoCriticoList,
        #upcomingTaskList,
        #criticalPathList,
        #riskList {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            flex-wrap: wrap;
            gap: 0.75rem;
            max-height: none;
            font-size: 1.1em;
        }
        #kpiDeltaList > *,
        #slippageList > *,
        #scopeChangeList > *,
        #focoCriticoList > *,
        #upcomingTaskList > *,
        #criticalPathList > *,
        #riskList > * {
            flex: 1 1 100%;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        @media print { 
            body { background: white !important; color: black !important; } 
            .card { background: #f9f9f9 !important; border: 1px solid #ddd !important; } 
        }
    <\/style>
</head>
<body>
    <!-- Header minimalista -->
    <div class="p-6 border-b border-white/10 bg-[--bl-azul-oscuro]/80 backdrop-blur-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="${document.getElementById('custom-logo').src}" class="h-16 w-auto object-contain" alt="Logo Cliente">
                <img src="${document.getElementById('blatorh-logo-center').src}" class="h-16 w-auto object-contain" alt="Logo BlatoRH">
            </div>
            <div class="text-right">
                <h1 class="font-display text-4xl text-[--bl-dorado]">${projectName}</h1>
                <p class="text-white/70 text-sm">Generado el ${new Date().toLocaleDateString('es-AR')}</p>
            </div>
        </div>
    </div>
    
    <!-- Contenido del Dashboard -->
    <main class="container mx-auto p-6">
        ${clone.innerHTML}
    </main>
    
    <!-- Scripts para interactividad m√≠nima -->
    <script>
        // Posicionar padres de tooltips
        document.querySelectorAll('.static-tooltip').forEach(tooltip => {
            if (tooltip.parentElement) {
                tooltip.parentElement.style.position = 'relative';
            }
        });
        // Mostrar / ocultar tooltips
        document.querySelectorAll('[data-tooltip-text]').forEach(el => {
            const tooltip = el.querySelector('.static-tooltip');
            if (!tooltip) return;
            el.addEventListener('mouseenter', () => tooltip.classList.remove('hidden'));
            el.addEventListener('mouseleave', () => tooltip.classList.add('hidden'));
        });
        // Scroll suave para navegaci√≥n interna
        document.querySelectorAll('a[href^="#"]').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.querySelector(a.getAttribute('href'));
                if (target) target.scrollIntoView({ behavior: 'smooth' });
            });
        });
    <\/script>
</body>
</html>`;
        
        // 7. Descargar archivo
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // 8. Limpiar
        document.body.removeChild(reportClone);
        
    } catch (error) {
        console.error('Error al generar el HTML profesional:', error);
        // Fallback a JPG simple del dashboard completo
        if (typeof exportElementAsJPG === 'function') {
            try {
                exportElementAsJPG('dashboardSection', 'download-html-report-btn');
            } catch (e) {
                console.error('Error en fallback exportElementAsJPG:', e);
            }
        }
    } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        if (window.lucide && typeof lucide.createIcons === 'function') {
            lucide.createIcons();
        }
    }
}

(function attachHtmlReportButton(){
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('download-html-report-btn');
            if (btn) btn.addEventListener('click', generateProfessionalHTMLReport);
        });
    } else {
        const btn = document.getElementById('download-html-report-btn');
        if (btn) btn.addEventListener('click', generateProfessionalHTMLReport);
    }
})();
</script>
<script>
// --- SNAPSHOT FUNCTIONALITY ---

/**
 * Exports the current dashboard state to a JSON file.
 */
function exportDashboardSnapshot() {
    if (!projectDataStore || !projectDataStore.name) {
        // Replaced alert
        const contentArea = document.getElementById('executive-summary-content');
        contentArea.innerHTML = `<p class="text-yellow-400 font-semibold">No hay datos de proyecto cargados para exportar la instant√°nea.</p>`;
        return;
    }

    // Helper to prepare a data store for JSON serialization.
    // It converts the 'resources' Map into a serializable array.
    const prepareStoreForExport = (store) => {
        if (!store) return null;
        const storeCopy = { ...store };
        if (store.resources instanceof Map) {
            storeCopy.resources = Array.from(store.resources.entries());
        }
        return storeCopy;
    };

    const snapshot = {
        metadata: {
            version: '1.1', // Version indicates it includes UI state
            projectName: projectDataStore.name,
            exportedAt: new Date().toISOString()
        },
        projectDataStore: prepareStoreForExport(projectDataStore),
        previousProjectDataStore: prepareStoreForExport(previousProjectDataStore),
        uiState: {
            ganttViewMode,
            burnupViewMode,
            ganttMainView,
            ganttSearchTerm,
            ganttResourceFilter,
            ganttIsolationFilter,
            ganttStartDate: document.getElementById('ganttStartDate').value,
            ganttEndDate: document.getElementById('ganttEndDate').value,
            burnupStartDate: document.getElementById('burnupStartDate').value,
            burnupEndDate: document.getElementById('burnupEndDate').value,
            upcomingDays: document.getElementById('upcoming-days').value,
            panelVisibilityState: loadPanelVisibilityState() // Save visibility state
        }
    };

    try {
        const dataStr = JSON.stringify(snapshot, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement('a');
        const safeName = projectDataStore.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const dateStamp = new Date().toISOString().split('T')[0];
        link.download = `blatorh_snapshot_${safeName}_${dateStamp}.json`;
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error("Error creating snapshot JSON:", error);
        const contentArea = document.getElementById('executive-summary-content');
        contentArea.innerHTML = `<p class="text-red-400 font-semibold">Hubo un error al generar el archivo de instant√°nea.</p>`;
    }
}

/**
 * Restores the UI controls to a previously saved state.
 * @param {object} uiState The state object from the snapshot.
 */
function restoreUiControlsState(uiState) {
    try {
        // Restore simple input values
        document.getElementById('gantt-search').value = uiState.ganttSearchTerm || '';
        document.getElementById('gantt-resource-filter').value = uiState.ganttResourceFilter || 'all';
        document.getElementById('upcoming-days').value = uiState.upcomingDays || '7';

        // Restore date ranges
        document.getElementById('ganttStartDate').value = uiState.ganttStartDate;
        document.getElementById('ganttEndDate').value = uiState.ganttEndDate;
        document.getElementById('burnupStartDate').value = uiState.burnupStartDate;
        document.getElementById('burnupEndDate').value = uiState.burnupEndDate;

        // Helper to update active classes on toggle button groups
        const updateToggles = (selector, activeValue) => {
            document.querySelectorAll(selector).forEach(btn => {
                const key = btn.dataset.view || btn.dataset.filter;
                btn.classList.toggle('active', key === activeValue);
            });
        };

        // Restore all toggle states
        updateToggles('#gantt-timescale-toggle .gantt-view-btn', uiState.ganttViewMode);
        updateToggles('#gantt-main-view-toggle .gantt-view-btn', uiState.ganttMainView);
        updateToggles('#gantt-isolation-filter .gantt-view-btn', uiState.ganttIsolationFilter);
        updateToggles('#burnup-view-toggle .gantt-view-btn', uiState.burnupViewMode);

        // Restore Panel Visibility State
        if (uiState.panelVisibilityState) {
            savePanelVisibilityState(uiState.panelVisibilityState);
            applyPanelVisibility(); // Apply immediately after loading state
        }

        // Re-render the main views to apply all restored states and filters
        // This is crucial for the Gantt, Network Diagram, etc., to update visually.
        filterAndRenderViews();
        filterAndRenderBurnup(flattenTasks(projectDataStore.tasks).filter(t => !t.isSummary));
        renderUpcomingTasks(parseInt(uiState.upcomingDays || '7', 10), uiState.ganttIsolationFilter || 'all');

    } catch (error) {
        console.warn("Could not fully restore UI state, some controls might be at default:", error);
    }
}


/**
 * Handles the snapshot file import process.
 * @param {Event} event The file input change event.
 */
function importDashboardSnapshot(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const snapshot = JSON.parse(e.target.result);

            // Validation for new version
            if (!snapshot.projectDataStore || !snapshot.metadata?.version || !snapshot.metadata.version.startsWith('1.')) {
                // Replaced alert
                const contentArea = document.getElementById('executive-summary-content');
                contentArea.innerHTML = `<p class="text-red-400 font-semibold">El archivo de instant√°nea no es v√°lido, est√° corrupto o es de una versi√≥n incompatible.</p>`;
                return;
            }

            // Helper to restore Maps from arrays
            const restoreStoreFromImport = (storeData) => {
                if (!storeData) return null;
                if (Array.isArray(storeData.resources)) {
                    storeData.resources = new Map(storeData.resources);
                }
                return storeData;
            };

            // Assign data to global variables
            projectDataStore = restoreStoreFromImport(snapshot.projectDataStore);
            previousProjectDataStore = restoreStoreFromImport(snapshot.previousProjectDataStore) || null;

            // Restore UI state variables from snapshot
            if (snapshot.uiState) {
                ganttViewMode = snapshot.uiState.ganttViewMode || 'day';
                burnupViewMode = snapshot.uiState.burnupViewMode || 'week';
                ganttMainView = snapshot.uiState.ganttMainView || 'gantt';
                ganttSearchTerm = snapshot.uiState.ganttSearchTerm || '';
                ganttResourceFilter = snapshot.uiState.ganttResourceFilter || 'all';
                ganttIsolationFilter = snapshot.uiState.ganttIsolationFilter || 'all';
            }

            // Hide all upload sections and show dashboard
            const stepsContainer = document.getElementById('stepsInlinePro');
            const legacyContainer = document.getElementById('uploadSection');
            const dashboardContainer = document.getElementById('dashboardSection');

            if (stepsContainer) {
                 stepsContainer.style.transition = 'opacity 0.5s';
                 stepsContainer.style.opacity = '0';
            }
            if (legacyContainer) {
                legacyContainer.style.display = 'none';
            }

            setTimeout(() => {
                if (stepsContainer) stepsContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                setTimeout(() => {
                    dashboardContainer.classList.remove('opacity-0');

                    // Call the main rendering function which sets up the structure
                    processAndRenderDashboard(projectDataStore, previousProjectDataStore);

                    // AFTER rendering, apply the restored UI state to the controls
                    if (snapshot.uiState) {
                        restoreUiControlsState(snapshot.uiState);
                    }
                }, 50);

            }, 500);

        } catch (error) {
            console.error("Error al importar la instant√°nea:", error);
            // Replaced alert
            const contentArea = document.getElementById('executive-summary-content');
            contentArea.innerHTML = `<p class="text-red-400 font-semibold">Error al procesar el archivo JSON. Aseg√∫rate de que el formato es correcto.</p>`;
        } finally {
            // Reset file input to allow re-uploading the same file
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

// Add event listeners for snapshot buttons
function initializeSnapshotButtons() {
    // Import
    const importBtn = document.getElementById('import-snapshot-btn');
    const importInput = document.getElementById('snapshot-import-input');
    if (importBtn && importInput) {
        importBtn.addEventListener('click', () => importInput.click());
        importInput.addEventListener('change', importDashboardSnapshot);
    }

    // Export (Button is in the header)
    const exportBtn = document.getElementById('export-snapshot-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportDashboardSnapshot);
    }
}

// Wait for the DOM to be fully loaded before attaching events
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSnapshotButtons);
} else {
    initializeSnapshotButtons();
}
</script>

</body>
</html>